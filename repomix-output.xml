This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.continue/agents/new-config.yaml
.env,local
.firebaserc
.gitignore
app/actions/consumeItem.ts
app/actions/createPrinted.ts
app/actions/importStl.ts
app/actions/reportDefect.ts
app/actions/storageActions.ts
app/actions/updateItemStatus.ts
app/actions/updateProcess.ts
app/api/import-stl/route.ts
app/api/preview-filenames/route.ts
app/components/CartModal.tsx
app/components/common/FileDownloadButton.tsx
app/components/ModelViewer.tsx
app/components/PreviewModal.tsx
app/components/StlImportModal.tsx
app/components/SummaryCard.tsx
app/components/swimlane/SwimlaneCell.tsx
app/components/swimlane/SwimlaneColumn.tsx
app/components/swimlane/SwimlaneItem.tsx
app/constants.ts
app/data.ts
app/globals.css
app/item/[id]/page.tsx
app/layout.tsx
app/page.tsx
app/print/page.tsx
app/project/[id]/page.tsx
app/project/[id]/ProjectClientContent.tsx
app/storage/page.tsx
app/storage/StorageBoxGrid.tsx
app/types.ts
app/utils.ts
docs/INTEGRATION_EXAMPLE.md
docs/STL_IMPORT_GUIDE.md
firebase-data/auth_export/accounts.json
firebase-data/auth_export/config.json
firebase-data/firebase-export-metadata.json
firebase-data/firestore_export/all_namespaces/all_kinds/all_namespaces_all_kinds.export_metadata
firebase-data/firestore_export/all_namespaces/all_kinds/output-0
firebase-data/firestore_export/firestore_export.overall_export_metadata
firebase-data/storage_export/blobs/07329d3c-7ade-4d04-878b-cba2ed959f4f
firebase-data/storage_export/blobs/2299a94e-5a1b-4750-87a0-8d2887f35a28
firebase-data/storage_export/blobs/30adc946-cbad-412f-aed8-904867ee12ef
firebase-data/storage_export/blobs/4fa0f39a-bcd1-472f-a1ef-92bd3a120904
firebase-data/storage_export/blobs/8a1ed49f-88fe-4c0e-a2a0-dd168182efe6
firebase-data/storage_export/buckets.json
firebase-data/storage_export/metadata/07329d3c-7ade-4d04-878b-cba2ed959f4f.json
firebase-data/storage_export/metadata/2299a94e-5a1b-4750-87a0-8d2887f35a28.json
firebase-data/storage_export/metadata/30adc946-cbad-412f-aed8-904867ee12ef.json
firebase-data/storage_export/metadata/4fa0f39a-bcd1-472f-a1ef-92bd3a120904.json
firebase-data/storage_export/metadata/8a1ed49f-88fe-4c0e-a2a0-dd168182efe6.json
firebase-export-1770456349158PyqgDy/firestore_export/all_namespaces/all_kinds/all_namespaces_all_kinds.export_metadata
firebase-export-1770456349158PyqgDy/firestore_export/all_namespaces/all_kinds/output-0
firebase-export-1770456349158PyqgDy/firestore_export/firestore_export.overall_export_metadata
firebase-export-1770545049902UW2hwo/firestore_export/all_namespaces/all_kinds/all_namespaces_all_kinds.export_metadata
firebase-export-1770545049902UW2hwo/firestore_export/all_namespaces/all_kinds/output-0
firebase-export-1770545049902UW2hwo/firestore_export/firestore_export.overall_export_metadata
firebase.json
firestore.indexes.json
firestore.rules
lib/firebase.ts
lib/mockStore.ts
lib/utils/parseFileName.ts
next.config.js
package.json
postcss.config.js
public/models/PART-A.stl
README.md
scripts/seed-emulator.ts
tailwind.config.js
tsconfig.json
tsconfig.node.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".continue/agents/new-config.yaml">
# This is an example configuration file
# To learn more, see the full config.yaml reference: https://docs.continue.dev/reference

name: Example Config
version: 1.0.0
schema: v1

# Define which models can be used
# https://docs.continue.dev/customization/models
models:
  - name: my gpt-5
    provider: openai
    model: gpt-5
    apiKey: YOUR_OPENAI_API_KEY_HERE
  - uses: ollama/qwen2.5-coder-7b
  - uses: anthropic/claude-4-sonnet
    with:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

# MCP Servers that Continue can access
# https://docs.continue.dev/customization/mcp-tools
mcpServers:
  - uses: anthropic/memory-mcp
</file>

<file path=".env,local">
# Firebase Project ID (Emulatorç”¨ã« 'demo-' ã‚’ä»˜ã‘ã‚‹)
NEXT_PUBLIC_FIREBASE_PROJECT_ID=demo-bom3d-sn923

# å„ç¨®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®ãƒãƒ¼ãƒˆç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
NEXT_PUBLIC_FIREBASE_FIRESTORE_EMULATOR_HOST=localhost:8080
NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST=http://localhost:9099
</file>

<file path=".gitignore">
# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local
.env

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
Thumbs.db
</file>

<file path="app/actions/storageActions.ts">
'use server'

import { mockStore } from '@/lib/mockStore'
import { revalidatePath } from 'next/cache'

/**
 * ç‰¹å®šã®ã‚¢ã‚¤ãƒ†ãƒ ã®ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ã‚’å¼·åˆ¶çš„ã«è§£æ”¾ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 * @param itemId - éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã®ID
 */
export async function releaseStorageCase(itemId: number) {
    try {
        await mockStore.updatePartItem(itemId, {
            storage_case: ''
        });

        console.log(`Forcefully released storage box for item ${itemId}`);

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ã¦UIã«åæ˜ 
        revalidatePath('/');
        revalidatePath('/storage');

        return { success: true };
    } catch (error) {
        console.error('Failed to release storage case:', error);
        return { success: false, error: (error as Error).message };
    }
}

/**
 * ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ã®ä½¿ç”¨çŠ¶æ³ã‚’å–å¾—ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 * @param maxBoxNumber - æœ€å¤§ãƒœãƒƒã‚¯ã‚¹ç•ªå·ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100ï¼‰
 */
export async function getStorageBoxStatus(maxBoxNumber: number = 100) {
    try {
        const allItems = await mockStore.getPartItems();

        // ãƒœãƒƒã‚¯ã‚¹ç•ªå·ã”ã¨ã«ä½¿ç”¨çŠ¶æ³ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
        const boxMap = new Map<string, { itemId: number; partNumber: string; status: string }>();

        // Partsãƒ‡ãƒ¼ã‚¿ã‚‚å–å¾—ã—ã¦éƒ¨å“ç•ªå·ã‚’è§£æ±º
        const parts = await mockStore.getParts();
        const partMap = new Map(parts.map(p => [p.id, p.part_number]));

        allItems.forEach(item => {
            if (item.storage_case && item.storage_case.trim() !== '') {
                const partNumber = partMap.get(item.part_id) || 'Unknown';
                boxMap.set(item.storage_case, {
                    itemId: item.id,
                    partNumber,
                    status: item.status
                });
            }
        });

        // BOX-001 ã‹ã‚‰ BOX-{maxBoxNumber} ã¾ã§ã®çŠ¶æ…‹ã‚’ç”Ÿæˆ
        const boxes = [];
        for (let i = 1; i <= maxBoxNumber; i++) {
            const boxId = `BOX-${String(i).padStart(3, '0')}`;
            const usage = boxMap.get(boxId);

            boxes.push({
                boxId,
                isUsed: !!usage,
                itemId: usage?.itemId || null,
                partNumber: usage?.partNumber || null,
                status: usage?.status || null
            });
        }

        return { success: true, boxes };
    } catch (error) {
        console.error('Failed to get storage box status:', error);
        return { success: false, error: (error as Error).message, boxes: [] };
    }
}
</file>

<file path="app/api/import-stl/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { importMultipleStl } from '@/app/actions/importStl';
import { ProcessStatus } from '@/app/types';

export async function POST(request: NextRequest) {
    try {
        const { projectId, defaultStatus, filesData } = await request.json();

        if (!projectId || !filesData || !Array.isArray(filesData)) {
            return NextResponse.json(
                { error: 'Invalid request parameters' },
                { status: 400 }
            );
        }

        // Uint8Array ã‚’ ArrayBuffer ã«å¤‰æ›
        const convertedFilesData = filesData.map((fd: any) => ({
            name: fd.name,
            buffer: new Uint8Array(fd.buffer).buffer
        }));

        const results = await importMultipleStl(
            convertedFilesData,
            projectId,
            (defaultStatus as ProcessStatus) || 'CUTTING'
        );

        return NextResponse.json(results);
    } catch (error) {
        console.error('Error in import-stl API:', error);
        return NextResponse.json(
            { error: error instanceof Error ? error.message : 'Internal server error' },
            { status: 500 }
        );
    }
}
</file>

<file path="app/components/common/FileDownloadButton.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { ref, getDownloadURL } from 'firebase/storage';
import { storage } from '@/lib/firebase';

interface FileDownloadButtonProps {
    storagePath: string;
    fileName: string;
    label?: string;
    variant?: 'primary' | 'outline' | 'ghost';
    icon?: React.ReactNode;
}

export default function FileDownloadButton({
    storagePath,
    fileName,
    label,
    variant = 'outline',
    icon
}: FileDownloadButtonProps) {
    const [downloadUrl, setDownloadUrl] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [isError, setIsError] = useState(false);

    useEffect(() => {
        const fetchUrl = async () => {
            setIsLoading(true);
            setIsError(false);
            try {
                const fileRef = ref(storage, storagePath);
                const url = await getDownloadURL(fileRef);
                setDownloadUrl(url);
            } catch (error: any) {
                console.error(`Error fetching download URL for ${storagePath}:`, error);
                if (error.code === 'storage/object-not-found') {
                    setIsError(true);
                } else {
                    setIsError(true);
                }
            } finally {
                setIsLoading(false);
            }
        };

        if (storagePath) {
            fetchUrl();
        }
    }, [storagePath]);

    const handleDownload = () => {
        if (!downloadUrl) return;

        // Use a hidden anchor tag to trigger download with fileName
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = fileName;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const baseStyles = "inline-flex items-center justify-center gap-2 px-3 py-1.5 rounded-md text-xs font-bold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed";

    const variants = {
        primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-sm",
        outline: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
        ghost: "bg-transparent text-gray-600 hover:bg-gray-100"
    };

    const defaultIcon = (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
    );

    if (isLoading) {
        return (
            <button disabled className={`${baseStyles} ${variants[variant]}`}>
                <span className="animate-spin rounded-full h-3.5 w-3.5 border-b-2 border-current"></span>
                {label || 'Loading...'}
            </button>
        );
    }

    if (isError) {
        return (
            <button disabled title="ãƒ•ã‚¡ã‚¤ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“" className={`${baseStyles} ${variants[variant]} opacity-40`}>
                {icon || defaultIcon}
                {label ? `${label} (æœªç™»éŒ²)` : 'æœªç™»éŒ²'}
            </button>
        );
    }

    return (
        <button
            onClick={handleDownload}
            className={`${baseStyles} ${variants[variant]}`}
        >
            {icon || defaultIcon}
            {label}
        </button>
    );
}
</file>

<file path="app/components/SummaryCard.tsx">
// app/dashboard/components/SummaryCard.tsx
import React from 'react';

interface SummaryCardProps {
  title: string;
  value: number | string;
  valueColor?: string;
}

export function SummaryCard({ title, value, valueColor = 'text-gray-800' }: SummaryCardProps) {
  return (
    <div className="bg-white p-6 rounded-xl shadow-lg flex items-center">
      <div>
        <p className="text-lg text-gray-500">{title}</p>
        <p className={`text-5xl font-extrabold ${valueColor}`}>{value}</p>
      </div>
    </div>
  );
}
</file>

<file path="app/storage/page.tsx">
import { getStorageBoxStatus } from '@/app/actions/storageActions';
import StorageBoxGrid from './StorageBoxGrid';

export const dynamic = 'force-dynamic';

export default async function StoragePage() {
    const result = await getStorageBoxStatus(100);

    if (!result.success) {
        return (
            <div className="min-h-screen bg-gray-50 p-8">
                <div className="max-w-7xl mx-auto">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ç®¡ç†</h1>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p className="text-red-800">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {result.error}</p>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-50 p-8">
            <div className="max-w-7xl mx-auto">
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ç®¡ç†</h1>
                    <p className="text-gray-600">
                        ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ã®ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦å¼·åˆ¶è§£æ”¾ã§ãã¾ã™ã€‚
                    </p>
                </div>

                <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <div className="flex items-center gap-6">
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-blue-500 rounded"></div>
                            <span className="text-sm text-gray-700">ä½¿ç”¨ä¸­</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-gray-200 rounded"></div>
                            <span className="text-sm text-gray-700">ç©ºã</span>
                        </div>
                    </div>
                </div>

                <StorageBoxGrid boxes={result.boxes} />
            </div>
        </div>
    );
}
</file>

<file path="app/storage/StorageBoxGrid.tsx">
'use client'

import { useState } from 'react';
import { releaseStorageCase } from '@/app/actions/storageActions';

interface Box {
    boxId: string;
    isUsed: boolean;
    itemId: number | null;
    partNumber: string | null;
    status: string | null;
}

interface StorageBoxGridProps {
    boxes: Box[];
}

export default function StorageBoxGrid({ boxes }: StorageBoxGridProps) {
    const [releasing, setReleasing] = useState<string | null>(null);

    const handleRelease = async (boxId: string, itemId: number) => {
        if (!confirm(`ãƒœãƒƒã‚¯ã‚¹ ${boxId} ã‚’å¼·åˆ¶è§£æ”¾ã—ã¾ã™ã‹ï¼Ÿ`)) {
            return;
        }

        setReleasing(boxId);
        try {
            const result = await releaseStorageCase(itemId);
            if (result.success) {
                // revalidatePathã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«ãƒšãƒ¼ã‚¸ãŒæ›´æ–°ã•ã‚Œã‚‹
            } else {
                alert(`è§£æ”¾ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error}`);
            }
        } catch (error) {
            alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`);
        } finally {
            setReleasing(null);
        }
    };

    return (
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            {boxes.map((box) => (
                <div
                    key={box.boxId}
                    className={`
                        rounded-lg border-2 p-4 transition-all
                        ${box.isUsed
                            ? 'bg-blue-50 border-blue-300 shadow-sm'
                            : 'bg-gray-50 border-gray-200'
                        }
                    `}
                >
                    <div className="text-center">
                        <div className="font-bold text-lg mb-2 text-gray-800">
                            {box.boxId}
                        </div>

                        {box.isUsed ? (
                            <div className="space-y-2">
                                <div className="text-sm">
                                    <div className="text-gray-600 font-medium">
                                        {box.partNumber}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        {box.status}
                                    </div>
                                </div>

                                <button
                                    onClick={() => handleRelease(box.boxId, box.itemId!)}
                                    disabled={releasing === box.boxId}
                                    className="
                                        w-full px-3 py-1.5 text-xs font-medium
                                        bg-red-500 text-white rounded
                                        hover:bg-red-600 
                                        disabled:bg-gray-400 disabled:cursor-not-allowed
                                        transition-colors
                                    "
                                >
                                    {releasing === box.boxId ? 'è§£æ”¾ä¸­...' : 'å¼·åˆ¶è§£æ”¾'}
                                </button>
                            </div>
                        ) : (
                            <div className="text-sm text-gray-400 py-2">
                                ç©ºã
                            </div>
                        )}
                    </div>
                </div>
            ))}
        </div>
    );
}
</file>

<file path="docs/INTEGRATION_EXAMPLE.md">
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã¸ã®STLã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½çµ±åˆä¾‹

## çµ±åˆæ–¹æ³•

`app/project/[id]/page.tsx` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã€STLã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```tsx
import Link from 'next/link';
import { notFound } from 'next/navigation';
import { aggregateProgress } from '@/app/utils';
import { SummaryCard } from '@/app/components/SummaryCard';
import { mockStore } from '@/lib/mockStore';
import ProjectClientContent from './ProjectClientContent';
// â†“ è¿½åŠ 
import ProjectPageClient from './ProjectPageClient';

interface PageProps {
    params: Promise<{
        id: string;
    }>;
}

export default async function ProjectDetailPage(props: PageProps) {
    const params = await props.params;
    const projectId = parseInt(params.id);
    if (isNaN(projectId)) {
        notFound();
    }

    const project = await mockStore.getProject(projectId);
    if (!project) {
        notFound();
    }

    const parts = await mockStore.getParts(projectId);
    const partItems = await mockStore.getPartItems(projectId);

    const totalInventory = partItems.length;
    const inProgress = partItems.filter(item => item.status !== 'READY').length;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const completedToday = partItems.filter(item =>
        item.completed_at && new Date(item.completed_at) >= today
    ).length;

    const progressData = aggregateProgress(parts, partItems);

    return (
        <ProjectPageClient
            project={project}
            projectId={projectId}
            totalInventory={totalInventory}
            inProgress={inProgress}
            completedToday={completedToday}
            progressData={progressData}
            parts={parts}
            partItems={partItems}
        />
    );
}
```

## æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆ

`app/project/[id]/ProjectPageClient.tsx` ã‚’ä½œæˆ:

```tsx
'use client';

import Link from 'next/link';
import { useState } from 'react';
import { SummaryCard } from '@/app/components/SummaryCard';
import { StlImportModal } from '@/app/components/StlImportModal';
import ProjectClientContent from './ProjectClientContent';
import { Part, PartItem, Project } from '@/app/types';

interface ProjectPageClientProps {
    project: Project;
    projectId: number;
    totalInventory: number;
    inProgress: number;
    completedToday: number;
    progressData: any[];
    parts: Part[];
    partItems: PartItem[];
}

export default function ProjectPageClient({
    project,
    projectId,
    totalInventory,
    inProgress,
    completedToday,
    progressData,
    parts,
    partItems
}: ProjectPageClientProps) {
    const [isImportModalOpen, setIsImportModalOpen] = useState(false);

    const handleImportComplete = () => {
        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
        window.location.reload();
    };

    return (
        <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <div>
                    <Link href="/" className="text-blue-600 hover:text-blue-800 mb-2 inline-block font-medium">
                        â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¸æˆ»ã‚‹
                    </Link>
                    <h1 className="text-3xl font-bold text-gray-800">
                        {project.name}
                    </h1>
                    <p className="text-gray-600 mt-1">{project.description}</p>
                </div>
                <div className="flex gap-3">
                    {/* STLã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆæ–°è¦è¿½åŠ ï¼‰ */}
                    <button
                        onClick={() => setIsImportModalOpen(true)}
                        className="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all"
                    >
                        ğŸ“ STLã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    
                    <Link href={`/print?project_id=${projectId}`}>
                        <span className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all cursor-pointer inline-block">
                            3Dãƒ—ãƒªãƒ³ãƒˆç™»éŒ²
                        </span>
                    </Link>
                </div>
            </header>

            {/* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <SummaryCard title="ç·åœ¨åº«æ•°" value={totalInventory} />
                <SummaryCard title="ä»•æ›å“æ•°" value={inProgress} valueColor="text-orange-500" />
                <SummaryCard title="æœ¬æ—¥å®Œäº†æ•°" value={completedToday} valueColor="text-green-500" />
            </div>

            {/* ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä¸€è¦§ãƒ»ã‚«ãƒ¼ãƒˆæ©Ÿèƒ½ */}
            <ProjectClientContent
                progressData={progressData}
                parts={parts}
                partItems={partItems}
                projectId={projectId}
            />

            {/* STLã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */}
            <StlImportModal
                isOpen={isImportModalOpen}
                onClose={() => setIsImportModalOpen(false)}
                projectId={projectId}
                onImportComplete={handleImportComplete}
            />
        </div>
    );
}
```

## å¤‰æ›´ç‚¹ã®èª¬æ˜

### 1. ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®åˆ†é›¢
- `page.tsx`: ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã®ã¿ï¼‰
- `ProjectPageClient.tsx`: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆUI + ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

### 2. STLã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¿½åŠ 
- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã«ç·‘è‰²ã®ã€ŒSTLã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
- ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã

### 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çµ±åˆ
- `StlImportModal` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- `isImportModalOpen` ã‚¹ãƒ†ãƒ¼ãƒˆã§è¡¨ç¤º/éè¡¨ç¤ºã‚’ç®¡ç†
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†å¾Œã¯ `window.location.reload()` ã§ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥

## ä½¿ç”¨ãƒ•ãƒ­ãƒ¼

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. ã€ŒSTLã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠ
4. ãƒ•ã‚¡ã‚¤ãƒ«åãŒè‡ªå‹•è§£æã•ã‚Œã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
5. åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: CUTTINGï¼‰
6. ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
7. Firebase Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ + Firestore ã«ä¿å­˜
8. å®Œäº†å¾Œã€ãƒšãƒ¼ã‚¸ãŒè‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€æ–°ã—ã„éƒ¨å“ãŒè¡¨ç¤ºã•ã‚Œã‚‹

## ã‚ˆã‚Šè‰¯ã„å®Ÿè£…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã®ä»£ã‚ã‚Šã«ã€SWRã‚„React Queryã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™:

```tsx
import { useRouter } from 'next/navigation';

const router = useRouter();

const handleImportComplete = () => {
    // Next.jsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    router.refresh();
};
```

ã“ã®æ–¹æ³•ãªã‚‰ã€ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å†å–å¾—ã§ãã¾ã™ã€‚
</file>

<file path="docs/STL_IMPORT_GUIDE.md">
# STLã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ä½¿ç”¨ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

STLãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰éƒ¨å“ç•ªå·ã¨å€‹æ•°ã‚’è‡ªå‹•è§£æã—ã€Firebase Storageã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨åŒæ™‚ã«Firestoreã«éƒ¨å“ï¼ˆPartï¼‰ã¨å·¥ç¨‹ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆPartItemï¼‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

## å®Ÿè£…ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

### 1. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- **`lib/utils/parseFileName.ts`**: ãƒ•ã‚¡ã‚¤ãƒ«åè§£æã‚¨ãƒ³ã‚¸ãƒ³

### 2. ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- **`app/actions/importStl.ts`**: ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ã®ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### 3. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- **`app/components/StlImportModal.tsx`**: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«

### 4. APIãƒ«ãƒ¼ãƒˆ
- **`app/api/preview-filenames/route.ts`**: ãƒ•ã‚¡ã‚¤ãƒ«åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨API
- **`app/api/import-stl/route.ts`**: ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œç”¨API

## ãƒ•ã‚¡ã‚¤ãƒ«åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œã—ã¦ã„ã¾ã™:

| ãƒ•ã‚¡ã‚¤ãƒ«å | éƒ¨å“ç•ªå· | å€‹æ•° |
|-----------|---------|------|
| `PART123.stl` | PART123 | 1 |
| `PART123_x5.stl` | PART123 | 5 |
| `ABC-456_X10.stl` | ABC-456 | 10 |
| `ITEM_789_x3.stl` | ITEM_789 | 3 |

### ãƒ«ãƒ¼ãƒ«
- æ‹¡å¼µå­ã¯ `.stl` ã¾ãŸã¯ `.STL`
- å€‹æ•°æŒ‡å®šã¯ `_xæ•°å­—` ã¾ãŸã¯ `_Xæ•°å­—` ã®å½¢å¼
- å€‹æ•°æŒ‡å®šãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1å€‹
- å€‹æ•°ã®ç¯„å›²ã¯ 1ã€œ1000

## ä½¿ç”¨æ–¹æ³•

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã«çµ„ã¿è¾¼ã‚€ä¾‹

```tsx
'use client';

import { useState } from 'react';
import { StlImportModal } from '@/app/components/StlImportModal';

export default function ProjectPage({ projectId }: { projectId: number }) {
  const [isImportModalOpen, setIsImportModalOpen] = useState(false);

  const handleImportComplete = () => {
    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†å¾Œã®å‡¦ç†ï¼ˆä¾‹: ãƒ‡ãƒ¼ã‚¿å†å–å¾—ï¼‰
    window.location.reload();
  };

  return (
    <div>
      {/* ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ */}
      <button
        onClick={() => setIsImportModalOpen(true)}
        className="bg-green-600 text-white font-bold py-3 px-6 rounded-lg"
      >
        STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      </button>

      {/* ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */}
      <StlImportModal
        isOpen={isImportModalOpen}
        onClose={() => setIsImportModalOpen(false)}
        projectId={projectId}
        onImportComplete={handleImportComplete}
      />
    </div>
  );
}
```

## å‡¦ç†ãƒ•ãƒ­ãƒ¼

1. **ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ/ãƒ‰ãƒ­ãƒƒãƒ—**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒSTLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
   - è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®åŒæ™‚é¸æŠãŒå¯èƒ½

2. **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è§£æ**
   - `/api/preview-filenames` ã‚’å‘¼ã³å‡ºã—
   - ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰éƒ¨å“ç•ªå·ã¨å€‹æ•°ã‚’æŠ½å‡º
   - è§£æçµæœã‚’ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºï¼ˆæœ‰åŠ¹/ç„¡åŠ¹ã‚’è‰²åˆ†ã‘ï¼‰

3. **åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: CUTTINGï¼‰
   - é¸æŠè‚¢: UNPRINTED, PRINTED, SURFACE_TREATMENT, CUTTING, PAINTING, READY

4. **ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ**
   - ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - `/api/import-stl` ã‚’å‘¼ã³å‡ºã—
   - å„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œ:
     - Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‘ã‚¹: `projects/{projectId}/stl/{partNumber}_{timestamp}.stl`ï¼‰
     - Firestoreã§éƒ¨å“ç•ªå·ã‚’æ¤œç´¢
     - è©²å½“ã™ã‚‹éƒ¨å“ãŒãªã‘ã‚Œã°æ–°è¦ä½œæˆ
     - æŒ‡å®šå€‹æ•°åˆ†ã®PartItemã‚’ä½œæˆ

5. **å®Œäº†é€šçŸ¥**
   - æˆåŠŸ/å¤±æ•—ä»¶æ•°ã‚’è¡¨ç¤º
   - `onImportComplete` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
   - ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### Partï¼ˆéƒ¨å“ï¼‰
```typescript
{
  id: number;
  part_number: string;  // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æŠ½å‡º
  project_id: number;
}
```

### PartItemï¼ˆå·¥ç¨‹ã‚¢ã‚¤ãƒ†ãƒ ï¼‰
```typescript
{
  id: number;
  part_id: number;
  storage_case: string;  // è‡ªå‹•ç”Ÿæˆ: "AUTO-{partNumber}-{é€£ç•ª}"
  status: ProcessStatus;  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸåˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  completed_at: Date | null;
  updated_at: Timestamp;
}
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- **ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã«èµ¤è‰²ã§è¡¨ç¤ºã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
- **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—**: å€‹åˆ¥ã«ã‚¨ãƒ©ãƒ¼ã‚’è¨˜éŒ²ã—ã€çµæœãƒ¬ãƒãƒ¼ãƒˆã«å«ã‚ã‚‹
- **é‡è¤‡éƒ¨å“ç•ªå·**: æ—¢å­˜ã®éƒ¨å“ã‚’ä½¿ç”¨ï¼ˆæ–°è¦ä½œæˆã—ãªã„ï¼‰
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ãƒªãƒˆãƒ©ã‚¤ã‚’ä¿ƒã™

## ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ‹¡å¼µ

`lib/utils/parseFileName.ts` ã® `parseFileName` é–¢æ•°ã‚’ç·¨é›†:

```typescript
// ä¾‹: ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ããƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œ
const prefixPattern = /^PREFIX_(.+?)_x(\d+)$/;
```

### åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´

`app/components/StlImportModal.tsx` ã® `defaultStatus` ã®åˆæœŸå€¤ã‚’å¤‰æ›´:

```typescript
const [defaultStatus, setDefaultStatus] = useState<ProcessStatus>('PRINTED');
```

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‘ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

`app/actions/importStl.ts` ã® `storagePath` ã‚’å¤‰æ›´:

```typescript
const storagePath = `custom/path/${partNumber}.stl`;
```

## ãƒ†ã‚¹ãƒˆæ–¹æ³•

1. Firebase Emulatorã‚’èµ·å‹•
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ã
3. ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™:
   - `TEST001.stl`
   - `TEST002_x3.stl`
   - `INVALID_NAME.txt` (ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆç”¨)
4. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
5. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèª
6. ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
7. Firestore Emulator UIã§ç¢ºèª:
   - `parts` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
   - `partItems` ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
8. Storage Emulator UIã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„
- Firebase EmulatorãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
- `lib/firebase.ts` ã®æ¥ç¶šè¨­å®šã‚’ç¢ºèª
- ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª

### éƒ¨å“ãŒé‡è¤‡ã—ã¦ä½œæˆã•ã‚Œã‚‹
- Firestoreã®ã‚¯ã‚¨ãƒªãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
- `part_number` ã¨ `project_id` ã®ä¸¡æ–¹ã§æ¤œç´¢ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„
- `/api/preview-filenames` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
- ãƒ•ã‚¡ã‚¤ãƒ«åãŒ `.stl` ã§çµ‚ã‚ã£ã¦ã„ã‚‹ã‹ç¢ºèª

## ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

- [ ] ãƒãƒƒãƒã‚¤ãƒ³ãƒãƒ¼ãƒˆã®é€²æ—ãƒãƒ¼è¡¨ç¤º
- [ ] ã‚¤ãƒ³ãƒãƒ¼ãƒˆå±¥æ­´ã®è¨˜éŒ²
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒ è¨­å®šUI
- [ ] STLãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
- [ ] é‡è¤‡ãƒã‚§ãƒƒã‚¯æ™‚ã®ä¸Šæ›¸ã/ã‚¹ã‚­ãƒƒãƒ—é¸æŠ
- [ ] CSVã«ã‚ˆã‚‹ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
</file>

<file path="firebase-data/auth_export/accounts.json">
{"kind":"identitytoolkit#DownloadAccountResponse","users":[]}
</file>

<file path="firebase-data/auth_export/config.json">
{"signIn":{"allowDuplicateEmails":false},"emailPrivacyConfig":{"enableImprovedEmailPrivacy":false}}
</file>

<file path="firebase-data/firebase-export-metadata.json">
{
  "version": "15.5.1",
  "firestore": {
    "version": "1.20.2",
    "path": "firestore_export",
    "metadata_file": "firestore_export/firestore_export.overall_export_metadata"
  },
  "database": {
    "version": "4.11.2",
    "path": "database_export"
  },
  "auth": {
    "version": "15.5.1",
    "path": "auth_export"
  },
  "storage": {
    "version": "15.5.1",
    "path": "storage_export"
  }
}
</file>

<file path="firebase-data/storage_export/metadata/07329d3c-7ade-4d04-878b-cba2ed959f4f.json">
{
  "name": "projects/1/stl/ãƒœãƒ‡ã‚£187_1770448719111.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770448719129,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "0d5b873f-5566-41c8-9aed-2966cb89c568"
  ],
  "etag": "/8CRwCb9eSxkxd1bg1VpEt1L/RM",
  "customMetadata": {},
  "timeCreated": "2026-02-07T07:18:39.129Z",
  "updated": "2026-02-07T07:18:39.129Z",
  "size": 39684,
  "md5Hash": "jZtKIN6hQiBgTaoJmooYZg==",
  "crc32c": "166781100"
}
</file>

<file path="firebase-data/storage_export/metadata/2299a94e-5a1b-4750-87a0-8d2887f35a28.json">
{
  "name": "projects/1/stl/ãƒœãƒ‡ã‚£179_1770529445795.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529445803,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "c8356d83-1b71-492e-ad9e-1e08a7059152"
  ],
  "etag": "G7O4LY1yNWn2fz3aAjD0WA4xnlE",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:05.803Z",
  "updated": "2026-02-08T05:44:05.803Z",
  "size": 35684,
  "md5Hash": "r+kYllHl14flvVDvPfPe6A==",
  "crc32c": "1892013277"
}
</file>

<file path="firebase-data/storage_export/metadata/30adc946-cbad-412f-aed8-904867ee12ef.json">
{
  "name": "projects/1/stl/ãƒœãƒ‡ã‚£180_1770529445567.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529445576,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "b9e90764-c8ed-4ed1-9e5b-aea9489bee1a"
  ],
  "etag": "LBOEOOSnr8Nd2AocdQ224yyApQ8",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:05.576Z",
  "updated": "2026-02-08T05:44:05.576Z",
  "size": 25284,
  "md5Hash": "bc0DrlnmuANN4871E26lxw==",
  "crc32c": "694601673"
}
</file>

<file path="firebase-data/storage_export/metadata/4fa0f39a-bcd1-472f-a1ef-92bd3a120904.json">
{
  "name": "projects/1/stl/ãƒœãƒ‡ã‚£186_1770529445301.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529445312,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "22f50b40-1c42-486a-a476-ad04f0ce8618"
  ],
  "etag": "ivhmcEfZc6mELCYhaybXm8I2Mo8",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:05.312Z",
  "updated": "2026-02-08T05:44:05.312Z",
  "size": 22884,
  "md5Hash": "o4PfDl24x7AjTrkMvz7cQQ==",
  "crc32c": "2880207178"
}
</file>

<file path="firebase-data/storage_export/metadata/8a1ed49f-88fe-4c0e-a2a0-dd168182efe6.json">
{
  "name": "projects/1/stl/ãƒœãƒ‡ã‚£183_1770529444757.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529444789,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "b24bc10e-e721-4980-b3b5-d8bdca2345f0"
  ],
  "etag": "g12pRYleuMn2JZKWrge4QO4vElQ",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:04.789Z",
  "updated": "2026-02-08T05:44:04.789Z",
  "size": 29384,
  "md5Hash": "OEi71t0ezdb9aZB3RXtkcw==",
  "crc32c": "115996729"
}
</file>

<file path="firebase.json">
{
  "firestore": {
    "database": "(default)",
    "location": "nam5",
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "emulators": {
    "auth": {
      "port": 9099
    },
    "firestore": {
      "port": 8080
    },
    "database": {
      "port": 9000
    },
    "hosting": {
      "port": 5000
    },
    "storage": {
      "port": 9199
    },
    "ui": {
      "enabled": true
    },
    "singleProjectMode": true
  }
}
</file>

<file path="firestore.indexes.json">
{
  // Example (Standard Edition):
  //
  // "indexes": [
  //   {
  //     "collectionGroup": "widgets",
  //     "queryScope": "COLLECTION",
  //     "fields": [
  //       { "fieldPath": "foo", "arrayConfig": "CONTAINS" },
  //       { "fieldPath": "bar", "mode": "DESCENDING" }
  //     ]
  //   },
  //
  //  "fieldOverrides": [
  //    {
  //      "collectionGroup": "widgets",
  //      "fieldPath": "baz",
  //      "indexes": [
  //        { "order": "ASCENDING", "queryScope": "COLLECTION" }
  //      ]
  //    },
  //   ]
  // ]
  //
  // Example (Enterprise Edition):
  //
  // "indexes": [
  //   {
  //     "collectionGroup": "reviews",
  //     "queryScope": "COLLECTION_GROUP",
  //     "apiScope": "MONGODB_COMPATIBLE_API",
  //     "density": "DENSE",
  //     "multikey": false,
  //     "fields": [
  //       { "fieldPath": "baz", "mode": "ASCENDING" }
  //     ]
  //   },
  //   {
  //     "collectionGroup": "items",
  //     "queryScope": "COLLECTION_GROUP",
  //     "apiScope": "MONGODB_COMPATIBLE_API",
  //     "density": "SPARSE_ANY",
  //     "multikey": true,
  //     "fields": [
  //       { "fieldPath": "baz", "mode": "ASCENDING" }
  //     ]
  //   },
  // ]
  "indexes": [],
  "fieldOverrides": []
}
</file>

<file path="firestore.rules">
rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      // This rule allows anyone with your database reference to view, edit,
      // and delete all data in your database. It is useful for getting
      // started, but it is configured to expire after 30 days because it
      // leaves your app open to attackers. At that time, all client
      // requests to your database will be denied.
      //
      // Make sure to write security rules for your app before that time, or
      // else all client requests to your database will be denied until you
      // update your rules.
      allow read, write: if request.time < timestamp.date(2026, 3, 5);
    }
  }
}
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
}

module.exports = nextConfig
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
  },
}
</file>

<file path="README.md">
# SN-923
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path=".firebaserc">
{
  "projects": {
    "default": "demo-bom3d-sn923"
  }
}
</file>

<file path="app/actions/importStl.ts">
'use server'

import { storage, db } from '@/lib/firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import {
    collection,
    getDocs,
    doc,
    setDoc,
    query,
    where,
    serverTimestamp
} from 'firebase/firestore';
import { revalidatePath } from 'next/cache';
import { parseFileName, ParsedFileInfo } from '@/lib/utils/parseFileName';
import { Part, PartItem, ProcessStatus } from '@/app/types';

export interface ImportResult {
    success: boolean;
    fileName: string;
    partNumber?: string;
    partId?: number;
    itemsCreated?: number;
    error?: string;
}

/**
 * å˜ä¸€ã®STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹
 * 
 * @param file - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆFormDataçµŒç”±ï¼‰
 * @param projectId - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
 * @param defaultStatus - åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'CUTTING'ï¼‰
 * @returns ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ
 */
export async function importSingleStl(
    fileBuffer: ArrayBuffer,
    fileName: string,
    projectId: number,
    defaultStatus: ProcessStatus = 'CUTTING'
): Promise<ImportResult> {
    try {
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è§£æ
        const parsed = parseFileName(fileName);

        if (!parsed.isValid) {
            return {
                success: false,
                fileName,
                error: parsed.errorMessage || 'ãƒ•ã‚¡ã‚¤ãƒ«åã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'
            };
        }

        const { partNumber, quantity } = parsed;

        // 2. Firebase Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const timestamp = Date.now();
        const storagePath = `projects/${projectId}/stl/${partNumber}_${timestamp}.stl`;
        const storageRef = ref(storage, storagePath);

        await uploadBytes(storageRef, fileBuffer);
        const downloadUrl = await getDownloadURL(storageRef);

        // 3. Firestore ã§è©²å½“ã™ã‚‹ part_number ã‚’æ¤œç´¢
        const partsRef = collection(db, 'parts');
        const q = query(
            partsRef,
            where('part_number', '==', partNumber),
            where('project_id', '==', projectId)
        );
        const snapshot = await getDocs(q);

        let partId: number;

        if (snapshot.empty) {
            // 4a. è©²å½“ã™ã‚‹ Part ãŒãªã‘ã‚Œã°æ–°è¦ä½œæˆ
            const allPartsSnapshot = await getDocs(collection(db, 'parts'));
            const existingIds = allPartsSnapshot.docs.map(d => Number(d.id));
            partId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;

            const newPart: Part = {
                id: partId,
                part_number: partNumber,
                project_id: projectId
            };

            await setDoc(doc(db, 'parts', String(partId)), newPart);
            console.log(`Created new Part: ${partNumber} (ID: ${partId})`);
        } else {
            // 4b. æ—¢å­˜ã® Part ã‚’ä½¿ç”¨
            partId = Number(snapshot.docs[0].id);
            console.log(`Using existing Part: ${partNumber} (ID: ${partId})`);
        }

        // 5. æŒ‡å®šã•ã‚ŒãŸå€‹æ•°åˆ†ã® PartItem ã‚’ä½œæˆ
        const allItemsSnapshot = await getDocs(collection(db, 'partItems'));
        const existingItemIds = allItemsSnapshot.docs.map(d => Number(d.id));
        let nextItemId = existingItemIds.length > 0 ? Math.max(...existingItemIds) + 1 : 1;

        // ä½¿ç”¨ä¸­ã®ãƒœãƒƒã‚¯ã‚¹ç•ªå·ã‚’å–å¾—
        const usedBoxes = new Set<string>();
        allItemsSnapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.storage_case && data.storage_case.trim() !== '') {
                usedBoxes.add(data.storage_case);
            }
        });

        // ç©ºããƒœãƒƒã‚¯ã‚¹ç•ªå·ã‚’æ¢ã™é–¢æ•°
        const findNextAvailableBox = (): string => {
            let boxNumber = 1;
            while (true) {
                const boxId = `BOX-${String(boxNumber).padStart(3, '0')}`;
                if (!usedBoxes.has(boxId)) {
                    usedBoxes.add(boxId); // æ¬¡ã®æ¤œç´¢ã§é‡è¤‡ã—ãªã„ã‚ˆã†ã«è¿½åŠ 
                    return boxId;
                }
                boxNumber++;
            }
        };

        for (let i = 0; i < quantity; i++) {
            const assignedBox = findNextAvailableBox();

            const newItem: PartItem = {
                id: nextItemId,
                part_id: partId,
                storage_case: assignedBox,
                status: defaultStatus,
                completed_at: null,
                updated_at: serverTimestamp()
            };

            await setDoc(doc(db, 'partItems', String(nextItemId)), newItem);
            nextItemId++;
        }

        console.log(`Created ${quantity} PartItems for Part ${partId}`);

        // 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å†æ¤œè¨¼
        revalidatePath('/');
        revalidatePath(`/project/${projectId}`);

        return {
            success: true,
            fileName,
            partNumber,
            partId,
            itemsCreated: quantity
        };

    } catch (error) {
        console.error('Error importing STL:', error);
        return {
            success: false,
            fileName,
            error: error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
        };
    }
}

/**
 * è¤‡æ•°ã®STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹
 * 
 * @param files - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®é…åˆ—
 * @param projectId - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
 * @param defaultStatus - åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 * @returns ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœã®é…åˆ—
 */
export async function importMultipleStl(
    filesData: Array<{ buffer: ArrayBuffer; name: string }>,
    projectId: number,
    defaultStatus: ProcessStatus = 'CUTTING'
): Promise<ImportResult[]> {
    const results: ImportResult[] = [];

    for (const fileData of filesData) {
        const result = await importSingleStl(
            fileData.buffer,
            fileData.name,
            projectId,
            defaultStatus
        );
        results.push(result);
    }

    return results;
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è§£æï¼ˆå®Ÿéš›ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯è¡Œã‚ãªã„ï¼‰
 * 
 * @param fileNames - ãƒ•ã‚¡ã‚¤ãƒ«åã®é…åˆ—
 * @returns è§£æçµæœã®é…åˆ—
 */
export async function previewFileNames(fileNames: string[]): Promise<ParsedFileInfo[]> {
    // 1. å„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è§£æ
    const parsedResults = fileNames.map(parseFileName);

    // 2. ç¾åœ¨ã®ä¿ç®¡ã‚±ãƒ¼ã‚¹ã®ä½¿ç”¨çŠ¶æ³ã‚’å–å¾—
    const allItemsSnapshot = await getDocs(collection(db, 'partItems'));
    const usedBoxes = new Set<string>();
    allItemsSnapshot.docs.forEach(doc => {
        const data = doc.data();
        if (data.storage_case && data.storage_case.trim() !== '') {
            usedBoxes.add(data.storage_case);
        }
    });

    // 3. ç©ºããƒœãƒƒã‚¯ã‚¹ç•ªå·ã‚’æ¢ã™é–¢æ•°
    const findNextAvailableBox = (): string => {
        let boxNumber = 1;
        while (true) {
            const boxId = `BOX-${String(boxNumber).padStart(3, '0')}`;
            if (!usedBoxes.has(boxId)) {
                usedBoxes.add(boxId); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«é‡è¤‡ã—ãªã„ã‚ˆã†ã«è¿½åŠ 
                return boxId;
            }
            boxNumber++;
        }
    };

    // 4. è§£æçµæœã”ã¨ã«ãƒœãƒƒã‚¯ã‚¹ã‚’å‰²ã‚Šå½“ã¦
    return parsedResults.map(parsed => {
        if (!parsed.isValid) return parsed;

        const storageBoxes: string[] = [];
        for (let i = 0; i < parsed.quantity; i++) {
            storageBoxes.push(findNextAvailableBox());
        }

        return {
            ...parsed,
            storageBoxes
        };
    });
}
</file>

<file path="app/actions/reportDefect.ts">
'use server'

import { mockStore } from '@/lib/mockStore'
import { revalidatePath } from 'next/cache'

/**
 * ä¸è‰¯ã‚’å ±å‘Šã—ã€å†è£½ä½œã‚¸ãƒ§ãƒ–ã‚’ç”Ÿæˆã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 * @param itemId - ä¸è‰¯ãŒç™ºç”Ÿã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ID
 * @param reason - ä¸è‰¯ã®ç†ç”±
 */
export async function reportDefect(itemId: number | string, reason: string) {
    const id = typeof itemId === 'string' ? parseInt(itemId, 10) : itemId;

    const item = await mockStore.getPartItem(id);
    if (!item) {
        console.error(`Item ${id} not found`);
        return;
    }

    // 1. ç¾çŠ¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã€Œä¸è‰¯(DEFECTIVE)ã€ã«ã™ã‚‹
    await mockStore.updatePartItem(id, {
        status: 'DEFECTIVE'
    });

    // 2. æ–°ã—ã„ã‚¸ãƒ§ãƒ–ï¼ˆå†è£½ä½œï¼‰ã‚’ç”Ÿæˆã™ã‚‹
    // å…ƒã®ã‚¢ã‚¤ãƒ†ãƒ ã®æƒ…å ±ã‚’å¼•ãç¶™ãã¤ã¤ã€å·¥ç¨‹ã‚’ã€Œæœªãƒ—ãƒªãƒ³ãƒˆã€ã«æˆ»ã™
    await mockStore.addPartItem({
        part_id: item.part_id,
        storage_case: `${item.storage_case} (RE)`, // å†è£½ä½œã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
        status: 'UNPRINTED',
        completed_at: null
    });

    console.log(`Reported defect for item ${id}: ${reason}`);

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
    revalidatePath('/');
    revalidatePath(`/item/${id}`);
    revalidatePath(`/project/${item.parts.project_id}`);
}
</file>

<file path="app/actions/updateItemStatus.ts">
'use server'

import { mockStore } from '@/lib/mockStore'
import { revalidatePath } from 'next/cache'

/**
 * éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 * @param itemId - éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã®ID
 * @param newStatus - æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆå·¥ç¨‹ï¼‰
 */
export async function updateItemStatus(itemId: string | number, newStatus: string) {
    try {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        await mockStore.updatePartItemStatus(itemId, newStatus);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒASSEMBLEDï¼ˆå®Œæˆï¼‰ã®å ´åˆã€ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ã‚’è§£æ”¾
        if (newStatus === 'ASSEMBLED') {
            await mockStore.updatePartItem(Number(itemId), {
                storage_case: ''
            });
            console.log(`Released storage box for item ${itemId}`);
        }

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ã¦UIã«åæ˜ 
        revalidatePath('/');
        revalidatePath('/storage');

        return { success: true };
    } catch (error) {
        console.error('Failed to update item status:', error);
        return { success: false, error: (error as Error).message };
    }
}
</file>

<file path="app/api/preview-filenames/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { previewFileNames } from '@/app/actions/importStl';

export async function POST(request: NextRequest) {
    try {
        const { fileNames } = await request.json();

        if (!Array.isArray(fileNames)) {
            return NextResponse.json(
                { error: 'fileNames must be an array' },
                { status: 400 }
            );
        }

        const results = await previewFileNames(fileNames);
        return NextResponse.json(results);
    } catch (error) {
        console.error('Error in preview-filenames API:', error);
        return NextResponse.json(
            { error: 'Internal server error' },
            { status: 500 }
        );
    }
}
</file>

<file path="app/components/CartModal.tsx">
import { ProcessStatus } from '../types';
import { PROCESSES } from '../constants';

interface CartItem {
    id: number;
    part_number: string;
    status: ProcessStatus;
    count: number;
}

interface CartModalProps {
    isOpen: boolean;
    onClose: () => void;
    items: CartItem[];
    onDownload: () => void;
}

export function CartModal({ isOpen, onClose, items, onDownload }: CartModalProps) {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[85vh]">
                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <span className="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm">
                                {items.length}
                            </span>
                            Selected Items
                        </h2>
                        <p className="text-xs text-gray-500 mt-1">Ready for batch download</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div className="p-0 overflow-y-auto flex-1">
                    {items.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-16 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <p>No items selected</p>
                        </div>
                    ) : (
                        <table className="w-full text-sm">
                            <thead className="text-xs text-gray-400 uppercase bg-gray-50/50 sticky top-0 z-10">
                                <tr>
                                    <th className="text-left py-3 px-6 font-medium">Part Number</th>
                                    <th className="text-left py-3 px-6 font-medium">Current Status</th>
                                    <th className="text-right py-3 px-6 font-medium">Format</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {items.map((item) => {
                                    const processName = PROCESSES.find(p => p.key === item.status)?.name || item.status;
                                    return (
                                        <tr key={item.id} className="group hover:bg-blue-50/30 transition-colors">
                                            <td className="py-3 px-6 font-bold text-gray-800">
                                                {item.part_number}
                                                <div className="text-[10px] text-gray-400 font-normal">ID: {item.id}</div>
                                            </td>
                                            <td className="py-3 px-6">
                                                <span className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-medium border border-gray-200">
                                                    {processName}
                                                </span>
                                            </td>
                                            <td className="py-3 px-6 text-right text-gray-500 font-mono text-xs">
                                                .stl
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    )}
                </div>

                <div className="p-6 bg-gray-50 flex gap-4">
                    <button
                        onClick={onClose}
                        className="flex-1 px-6 py-3 rounded-xl border border-gray-300 font-bold text-gray-600 hover:bg-white transition-colors"
                    >
                        æˆ»ã‚‹
                    </button>
                    <button
                        onClick={onDownload}
                        disabled={items.length === 0}
                        className="flex-1 px-6 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 transition-colors shadow-lg disabled:bg-gray-300"
                    >
                        Zipã§ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="app/components/ModelViewer.tsx">
'use client';

import { Canvas, useLoader } from '@react-three/fiber';
import { OrbitControls, Stage } from '@react-three/drei';
import { useState, useEffect, Suspense } from 'react';
import { STLLoader } from 'three-stdlib';

function STLModel({ url }: { url: string }) {
    if (!url) return null;

    const geom = useLoader(STLLoader, url);

    return (
        /* rotation: [x, y, z] 
           Math.PI / 2 ã¯ 90åº¦ã§ã™ã€‚
           CADã®Zä¸Šã‚’Three.jsã®Yä¸Šã«åˆã‚ã›ã‚‹ãŸã‚ã€Xè»¸ã‚’è»¸ã«ãƒã‚¤ãƒŠã‚¹90åº¦å›è»¢ã•ã›ã¾ã™ã€‚
        */
        <mesh
            geometry={geom}
            rotation={[-Math.PI / 2, 0, 0]}
        >
            <meshStandardMaterial color="#3b82f6" />
        </mesh>
    );
}

export function ModelViewer({ url }: { url: string }) {
    const [mounted, setMounted] = useState(false);

    useEffect(() => {
        setMounted(true);
    }, []);

    if (!mounted) {
        return <div className="w-full h-[400px] bg-gray-900 rounded-lg" />;
    }

    return (
        <div className="w-full h-[400px] bg-gray-900 rounded-lg">
            <Canvas shadows camera={{ position: [0, 0, 20], fov: 50 }}>
                <Suspense fallback={null}>
                    <Stage environment="city" intensity={0.5}>
                        <STLModel url={url} />
                    </Stage>
                </Suspense>
                <OrbitControls autoRotate />
            </Canvas>
        </div>
    );
}
</file>

<file path="app/components/StlImportModal.tsx">
'use client';

import React, { useState, useCallback } from 'react';
import { ParsedFileInfo } from '@/lib/utils/parseFileName';
import { ProcessStatus } from '@/app/types';

interface StlImportModalProps {
    isOpen: boolean;
    onClose: () => void;
    projectId: number;
    onImportComplete?: () => void;
}

interface FileWithPreview {
    file: File;
    parsed: ParsedFileInfo;
}

export function StlImportModal({ isOpen, onClose, projectId, onImportComplete }: StlImportModalProps) {
    const [files, setFiles] = useState<FileWithPreview[]>([]);
    const [isDragging, setIsDragging] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const [uploadProgress, setUploadProgress] = useState<string>('');
    const [defaultStatus, setDefaultStatus] = useState<ProcessStatus>('CUTTING');

    // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è§£æã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆã«è¿½åŠ 
    const handleFiles = useCallback(async (fileList: FileList | File[]) => {
        const stlFiles = Array.from(fileList).filter(
            file => file.name.toLowerCase().endsWith('.stl')
        );

        if (stlFiles.length === 0) {
            alert('STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®è§£æé–¢æ•°ã‚’å‘¼ã³å‡ºã™
        const fileNames = stlFiles.map(f => f.name);
        const response = await fetch('/api/preview-filenames', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileNames })
        });

        const parsedInfos: ParsedFileInfo[] = await response.json();

        const filesWithPreview: FileWithPreview[] = stlFiles.map((file, index) => ({
            file,
            parsed: parsedInfos[index]
        }));

        setFiles(prev => [...prev, ...filesWithPreview]);
    }, []);

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    const handleDragEnter = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(true);
    }, []);

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
    }, []);

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
    }, []);

    const handleDrop = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);

        const droppedFiles = e.dataTransfer.files;
        if (droppedFiles.length > 0) {
            handleFiles(droppedFiles);
        }
    }, [handleFiles]);

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files.length > 0) {
            handleFiles(e.target.files);
        }
    }, [handleFiles]);

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    const removeFile = useCallback((index: number) => {
        setFiles(prev => prev.filter((_, i) => i !== index));
    }, []);

    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
    const handleImport = useCallback(async () => {
        if (files.length === 0) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        // ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const invalidFiles = files.filter(f => !f.parsed.isValid);
        if (invalidFiles.length > 0) {
            const confirm = window.confirm(
                `${invalidFiles.length}ä»¶ã®ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹?`
            );
            if (!confirm) return;
        }

        setIsUploading(true);
        setUploadProgress('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');

        try {
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã«å¤‰æ›
            const filesData = await Promise.all(
                files
                    .filter(f => f.parsed.isValid)
                    .map(async ({ file }) => ({
                        buffer: await file.arrayBuffer(),
                        name: file.name
                    }))
            );

            // ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã™
            const response = await fetch('/api/import-stl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    projectId,
                    defaultStatus,
                    filesData: filesData.map(fd => ({
                        name: fd.name,
                        buffer: Array.from(new Uint8Array(fd.buffer))
                    }))
                })
            });

            const results = await response.json();

            const successCount = results.filter((r: any) => r.success).length;
            const failCount = results.filter((r: any) => !r.success).length;

            setUploadProgress(`å®Œäº†: ${successCount}ä»¶æˆåŠŸ, ${failCount}ä»¶å¤±æ•—`);

            setTimeout(() => {
                setFiles([]);
                setUploadProgress('');
                setIsUploading(false);
                onImportComplete?.();
                onClose();
            }, 2000);

        } catch (error) {
            console.error('Import error:', error);
            setUploadProgress('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            setIsUploading(false);
        }
    }, [files, projectId, defaultStatus, onImportComplete, onClose]);

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden">
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-700">
                    <h2 className="text-2xl font-bold text-white">STLãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                    <button
                        onClick={onClose}
                        disabled={isUploading}
                        className="text-white/80 hover:text-white disabled:opacity-50"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                {/* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */}
                <div className="p-6">
                    <div
                        onDragEnter={handleDragEnter}
                        onDragLeave={handleDragLeave}
                        onDragOver={handleDragOver}
                        onDrop={handleDrop}
                        className={`border-2 border-dashed rounded-xl p-12 text-center transition-all ${isDragging
                            ? 'border-blue-500 bg-blue-50'
                            : 'border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50/50'
                            }`}
                    >
                        <svg
                            className="mx-auto h-16 w-16 text-gray-400 mb-4"
                            stroke="currentColor"
                            fill="none"
                            viewBox="0 0 48 48"
                            aria-hidden="true"
                        >
                            <path
                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                strokeWidth={2}
                                strokeLinecap="round"
                                strokeLinejoin="round"
                            />
                        </svg>
                        <p className="text-lg font-semibold text-gray-700 mb-2">
                            STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                        </p>
                        <p className="text-sm text-gray-500 mb-4">ã¾ãŸã¯</p>
                        <label className="inline-block px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors cursor-pointer shadow-lg">
                            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                            <input
                                type="file"
                                multiple
                                accept=".stl"
                                onChange={handleFileSelect}
                                className="hidden"
                                disabled={isUploading}
                            />
                        </label>
                    </div>

                    {/* åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ */}
                    <div className="mt-6 flex items-center gap-4">
                        <label className="font-semibold text-gray-700">åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                        <select
                            value={defaultStatus}
                            onChange={(e) => setDefaultStatus(e.target.value as ProcessStatus)}
                            disabled={isUploading}
                            className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="UNPRINTED">æœªãƒ—ãƒªãƒ³ãƒˆ</option>
                            <option value="PRINTED">ãƒ—ãƒªãƒ³ãƒˆæ¸ˆã¿</option>
                            <option value="SURFACE_TREATMENT">è¡¨é¢å‡¦ç†</option>
                            <option value="CUTTING">åˆ‡å‰Š</option>
                            <option value="PAINTING">å¡—è£…</option>
                            <option value="READY">å®Œæˆ</option>
                        </select>
                    </div>
                </div>

                {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ */}
                {files.length > 0 && (
                    <div className="px-6 pb-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">
                            æŠ½å‡ºã•ã‚ŒãŸéƒ¨å“ç•ªå· ({files.length}ä»¶)
                        </h3>
                        <div className="max-h-[40vh] overflow-y-auto border border-gray-200 rounded-xl">
                            <table className="w-full">
                                <thead className="bg-gray-100 sticky top-0">
                                    <tr className="text-xs text-gray-600 uppercase">
                                        <th className="text-left p-3">ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                        <th className="text-left p-3">éƒ¨å“ç•ªå·</th>
                                        <th className="text-center p-3">å€‹æ•°</th>
                                        <th className="text-left p-3">ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹</th>
                                        <th className="text-left p-3">çŠ¶æ…‹</th>
                                        <th className="text-center p-3">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {files.map((fileWithPreview, index) => (
                                        <tr key={index} className={fileWithPreview.parsed.isValid ? '' : 'bg-red-50'}>
                                            <td className="p-3 text-sm font-mono text-gray-700">
                                                {fileWithPreview.file.name}
                                            </td>
                                            <td className="p-3 font-semibold text-gray-800">
                                                {fileWithPreview.parsed.partNumber || '-'}
                                            </td>
                                            <td className="p-3 text-center font-bold text-blue-600">
                                                {fileWithPreview.parsed.quantity}
                                            </td>
                                            <td className="p-3">
                                                <div className="flex flex-wrap gap-1 max-w-[200px]">
                                                    {fileWithPreview.parsed.storageBoxes?.map((box, i) => (
                                                        <span key={i} className="text-[10px] px-1.5 py-0.5 bg-blue-50 text-blue-600 font-bold rounded border border-blue-100">
                                                            {box}
                                                        </span>
                                                    )) || '-'}
                                                </div>
                                            </td>
                                            <td className="p-3">
                                                {fileWithPreview.parsed.isValid ? (
                                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                                        âœ“ æœ‰åŠ¹
                                                    </span>
                                                ) : (
                                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                                        âœ— {fileWithPreview.parsed.errorMessage}
                                                    </span>
                                                )}
                                            </td>
                                            <td className="p-3 text-center">
                                                <button
                                                    onClick={() => removeFile(index)}
                                                    disabled={isUploading}
                                                    className="text-red-500 hover:text-red-700 disabled:opacity-50"
                                                >
                                                    å‰Šé™¤
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {/* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ— */}
                {uploadProgress && (
                    <div className="px-6 pb-4">
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <p className="text-blue-800 font-semibold">{uploadProgress}</p>
                        </div>
                    </div>
                )}

                {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
                <div className="p-6 bg-gray-50 flex gap-4">
                    <button
                        onClick={onClose}
                        disabled={isUploading}
                        className="flex-1 px-6 py-3 rounded-xl border border-gray-300 font-bold text-gray-600 hover:bg-white transition-colors disabled:opacity-50"
                    >
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button
                        onClick={handleImport}
                        disabled={files.length === 0 || isUploading}
                        className="flex-1 px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        {isUploading ? 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...' : `ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ (${files.filter(f => f.parsed.isValid).length}ä»¶)`}
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="app/globals.css">
@import "tailwindcss";
</file>

<file path="app/layout.tsx">
import './globals.css'
import type { Metadata } from "next"

export const metadata: Metadata = {
  title: "SN-923",
  description: "åœ¨åº«ç®¡ç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³",
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  )
}
</file>

<file path="firebase-data/storage_export/buckets.json">
{
  "buckets": [
    {
      "id": "demo-no-project.appspot.com"
    },
    {
      "id": "demo-bom3d-sn923.appspot.com"
    }
  ]
}
</file>

<file path="lib/utils/parseFileName.ts">
/**
 * STLãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰éƒ¨å“æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */

export interface ParsedFileInfo {
    /** å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å */
    originalFileName: string;
    /** æŠ½å‡ºã•ã‚ŒãŸéƒ¨å“ç•ªå· */
    partNumber: string;
    /** å€‹æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰ */
    quantity: number;
    /** è§£æãŒæˆåŠŸã—ãŸã‹ */
    isValid: boolean;
    /** ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆè§£æå¤±æ•—æ™‚ï¼‰ */
    errorMessage?: string;
    /** å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ã®ãƒªã‚¹ãƒˆ */
    storageBoxes?: string[];
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰éƒ¨å“ç•ªå·ã¨å€‹æ•°ã‚’æŠ½å‡ºã™ã‚‹
 * 
 * å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
 * - PART123.stl â†’ éƒ¨å“ç•ªå·: PART123, å€‹æ•°: 1
 * - PART123_x5.stl â†’ éƒ¨å“ç•ªå·: PART123, å€‹æ•°: 5
 * - PART123_X10.stl â†’ éƒ¨å“ç•ªå·: PART123, å€‹æ•°: 10
 * - ABC-456_x3.stl â†’ éƒ¨å“ç•ªå·: ABC-456, å€‹æ•°: 3
 * 
 * @param fileName - è§£æã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­å«ã‚€ï¼‰
 * @returns è§£æçµæœ
 */
export function parseFileName(fileName: string): ParsedFileInfo {
    // æ‹¡å¼µå­ã‚’é™¤å»
    const nameWithoutExt = fileName.replace(/\.(stl|STL)$/, '');

    if (!nameWithoutExt) {
        return {
            originalFileName: fileName,
            partNumber: '',
            quantity: 1,
            isValid: false,
            errorMessage: 'ãƒ•ã‚¡ã‚¤ãƒ«åãŒç©ºã§ã™'
        };
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: éƒ¨å“ç•ªå·_xå€‹æ•° ã¾ãŸã¯ éƒ¨å“ç•ªå·_Xå€‹æ•°
    const quantityPattern = /^(.+?)_[xX](\d+)$/;
    const match = nameWithoutExt.match(quantityPattern);

    if (match) {
        const partNumber = match[1].trim();
        const quantity = parseInt(match[2], 10);

        if (!partNumber) {
            return {
                originalFileName: fileName,
                partNumber: '',
                quantity: 1,
                isValid: false,
                errorMessage: 'éƒ¨å“ç•ªå·ãŒç©ºã§ã™'
            };
        }

        if (quantity <= 0 || quantity > 1000) {
            return {
                originalFileName: fileName,
                partNumber,
                quantity: 1,
                isValid: false,
                errorMessage: `å€‹æ•°ãŒç¯„å›²å¤–ã§ã™ï¼ˆ1-1000ï¼‰: ${quantity}`
            };
        }

        return {
            originalFileName: fileName,
            partNumber,
            quantity,
            isValid: true
        };
    }

    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: éƒ¨å“ç•ªå·ã®ã¿ï¼ˆå€‹æ•°æŒ‡å®šãªã—ï¼‰
    const partNumber = nameWithoutExt.trim();

    if (!partNumber) {
        return {
            originalFileName: fileName,
            partNumber: '',
            quantity: 1,
            isValid: false,
            errorMessage: 'éƒ¨å“ç•ªå·ãŒç©ºã§ã™'
        };
    }

    return {
        originalFileName: fileName,
        partNumber,
        quantity: 1,
        isValid: true
    };
}

/**
 * è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¸€æ‹¬è§£æã™ã‚‹
 * 
 * @param fileNames - ãƒ•ã‚¡ã‚¤ãƒ«åã®é…åˆ—
 * @returns è§£æçµæœã®é…åˆ—
 */
export function parseFileNames(fileNames: string[]): ParsedFileInfo[] {
    return fileNames.map(parseFileName);
}

/**
 * è§£æçµæœã‹ã‚‰æœ‰åŠ¹ãªã‚‚ã®ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
 * 
 * @param parsedInfos - è§£æçµæœã®é…åˆ—
 * @returns æœ‰åŠ¹ãªè§£æçµæœã®ã¿ã®é…åˆ—
 */
export function filterValidParsedInfos(parsedInfos: ParsedFileInfo[]): ParsedFileInfo[] {
    return parsedInfos.filter(info => info.isValid);
}
</file>

<file path="scripts/seed-emulator.ts">
import { db } from '../lib/firebase';
import { projects, parts, partItems } from '../app/data';
import { collection, doc, setDoc, serverTimestamp } from 'firebase/firestore';

// @ts-ignore
process.env.NODE_ENV = 'development';

async function seed() {
    console.log('Seeding Firestore Emulator...');
    console.log('Connecting to Firestore (ensure Emulator is running on localhost:8080)...');

    // Projects
    console.log('Seeding Projects...');
    for (const project of projects) {
        const projectRef = doc(db, 'projects', String(project.id));
        await setDoc(projectRef, {
            ...project,
            // Ensure dates are compatible if strings
        });
    }

    // Parts
    console.log('Seeding Parts...');
    for (const part of parts) {
        const partRef = doc(db, 'parts', String(part.id));
        await setDoc(partRef, part);
    }

    // PartItems
    console.log('Seeding PartItems...');
    for (const item of partItems) {
        const itemRef = doc(db, 'partItems', String(item.id));
        await setDoc(itemRef, {
            ...item,
            // Convert Date object to Timestamp or keep as Date
            completed_at: item.completed_at ? item.completed_at : null,
            updated_at: serverTimestamp()
        });
    }

    console.log('Seeding completed!');
    process.exit(0);
}

seed().catch((error) => {
    console.error('Seeding failed:', error);
    process.exit(1);
});
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "es2017",
    "useDefineForClassFields": true,
    "lib": [
      "es2020",
      "dom",
      "dom.iterable"
    ],
    "module": "esnext",
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "forceConsistentCasingInFileNames": true,
    /* Next.js */
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "incremental": true,
    /* Path mapping */
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowJs": true,
    "strict": false,
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="app/components/PreviewModal.tsx">
'use client'

import { useState, useTransition } from 'react'
import { ModelViewer } from './ModelViewer'
import { PROCESSES } from '@/app/constants'
import { updateProcess } from '@/app/actions/updateProcess'
import { reportDefect } from '@/app/actions/reportDefect'

interface PreviewModalProps {
    isOpen: boolean
    onClose: () => void
    partNumber: string
    itemId?: number
    status?: string
    projectId?: number
}

export function PreviewModal({
    isOpen,
    onClose,
    partNumber,
    itemId,
    status,
    projectId
}: PreviewModalProps) {
    const [isPending, startTransition] = useTransition()
    const [defectReason, setDefectReason] = useState('')

    if (!isOpen) return null

    // ç¾åœ¨ã®å·¥ç¨‹ã‚ˆã‚Šã€Œå‰ã€ã®å·¥ç¨‹ã‚’æŠ½å‡ºï¼ˆå·®ã—æˆ»ã—ç”¨ï¼‰
    const currentIndex = PROCESSES.findIndex(p => p.key === status)
    const previousProcesses = PROCESSES.slice(0, currentIndex)

    const handleUpdateStatus = (statusKey: string) => {
        if (!itemId || !projectId) return
        startTransition(async () => {
            await updateProcess(itemId, statusKey, projectId)
            onClose()
        })
    }

    const handleReportDefect = () => {
        if (!itemId || !defectReason) return
        startTransition(async () => {
            await reportDefect(itemId, defectReason)
            setDefectReason('')
            onClose()
        })
    }

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[110] p-4">
            <div className="bg-white rounded-3xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">

                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                    <div>
                        <h3 className="text-2xl font-black text-gray-900">{partNumber}</h3>
                        <p className="text-sm text-gray-500 font-bold">ITEM ID: {itemId} / CURRENT: {status}</p>
                    </div>
                    <button
                        onClick={onClose}
                        className="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors text-2xl font-bold"
                    >
                        &times;
                    </button>
                </div>

                <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                    {/* å·¦å´ï¼š3Dãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */}
                    <div className="flex-[2] bg-gray-100 relative min-h-[300px]">
                        <ModelViewer url={`/models/${partNumber}.stl`} />
                        <div className="absolute bottom-4 left-4 bg-white/80 px-3 py-1 rounded text-xs font-bold text-gray-500">
                            3D PREVIEW MODE
                        </div>
                    </div>

                    {/* å³å´ï¼šæ“ä½œãƒ‘ãƒãƒ« */}
                    <div className="flex-1 border-l bg-white p-6 overflow-y-auto space-y-8">

                        {/* 1. å·¥ç¨‹ã®å·®ã—æˆ»ã— */}
                        <section>
                            <h4 className="text-sm font-black text-gray-400 uppercase tracking-widest mb-4">å·¥ç¨‹ã‚’å·®ã—æˆ»ã™ (æ‰‹æˆ»ã‚Š)</h4>
                            <div className="grid grid-cols-1 gap-2">
                                {previousProcesses.length > 0 ? (
                                    previousProcesses.map((proc) => (
                                        <button
                                            key={proc.key}
                                            onClick={() => handleUpdateStatus(proc.key)}
                                            disabled={isPending}
                                            className="text-left px-4 py-3 border-2 border-orange-100 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition-all group"
                                        >
                                            <span className="text-xs font-bold text-orange-400 block uppercase">{proc.key}ã¸æˆ»ã™</span>
                                            <span className="font-bold text-gray-700 group-hover:text-orange-700">{proc.name}</span>
                                        </button>
                                    ))
                                ) : (
                                    <p className="text-sm text-gray-400 italic">å·®ã—æˆ»ã›ã‚‹å‰ã®å·¥ç¨‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                                )}
                            </div>
                        </section>

                        <hr className="border-gray-100" />

                        {/* 2. ä¸è‰¯å ±å‘Š */}
                        <section className="p-5 border-2 border-red-100 rounded-2xl bg-red-50/30">
                            <h4 className="text-lg font-black text-red-700 mb-2">ä¸è‰¯ã‚’å ±å‘Šã™ã‚‹</h4>
                            <p className="text-xs text-red-600 mb-4 leading-relaxed font-medium">
                                å€‹ä½“ã«æ¬ é™¥ãŒã‚ã‚‹å ´åˆã€ä¸è‰¯ã¨ã—ã¦ç¢ºå®šã•ã›ã¾ã™ã€‚å®Ÿè¡Œã™ã‚‹ã¨è‡ªå‹•çš„ã«å†è£½ä½œã‚¸ãƒ§ãƒ–ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
                            </p>
                            <div className="space-y-3">
                                <textarea
                                    value={defectReason}
                                    onChange={(e) => setDefectReason(e.target.value)}
                                    placeholder="ä¸è‰¯ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                                    className="w-full p-3 border-2 border-red-100 rounded-xl text-sm focus:border-red-500 outline-none resize-none h-24 font-medium"
                                />
                                <button
                                    onClick={handleReportDefect}
                                    disabled={isPending || !defectReason}
                                    className={`w-full py-4 rounded-xl font-black transition-all shadow-md ${isPending || !defectReason
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        : 'bg-red-600 text-white hover:bg-red-700 active:scale-95'
                                        }`}
                                >
                                    {isPending ? 'å‡¦ç†ä¸­...' : 'ä¸è‰¯ç¢ºå®š & å†è£½ä½œä¾é ¼'}
                                </button>
                            </div>
                        </section>

                    </div>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="app/components/swimlane/SwimlaneCell.tsx">
import React from 'react';
import { useDroppable } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { PartItem, ProcessStatus } from '@/app/types';
import { SwimlaneItem } from './SwimlaneItem';

interface SwimlaneCellProps {
    partId: number;
    status: ProcessStatus;
    items: PartItem[];
    isLast: boolean;
    selectedIds: number[];
    onToggleSelect: (itemId: number) => void;
    onPreview: (item: any) => void;
}

export function SwimlaneCell({ partId, status, items, isLast, selectedIds, onToggleSelect, onPreview }: SwimlaneCellProps) {
    const droppableId = `container-${partId}-${status}`;
    const { setNodeRef, isOver } = useDroppable({ id: droppableId });

    return (
        <div
            ref={setNodeRef}
            className={`
        relative w-full h-[80px] border-b border-gray-100 p-2.5 transition-colors
        ${isOver ? 'bg-blue-50/50' : 'bg-white'}
        ${isLast ? 'border-b-0' : ''}
      `}
        >
            <SortableContext
                items={items.map(i => `item-${i.id}`)}
                strategy={verticalListSortingStrategy}
            >
                <div className="flex flex-col gap-2 h-full">
                    {items.map(item => (
                        <SwimlaneItem
                            key={item.id}
                            item={item}
                            isSelected={selectedIds.includes(item.id)}
                            onToggleSelect={onToggleSelect}
                            onPreview={onPreview}
                        />
                    ))}

                    {/* Placeholder when empty */}
                    {items.length === 0 && (
                        <div className="flex-1 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <span className="text-[10px] text-gray-300 font-medium border border-dashed border-gray-200 rounded px-2 py-1">
                                Drop
                            </span>
                        </div>
                    )}
                </div>
            </SortableContext>
        </div>
    );
}
</file>

<file path="app/constants.ts">
import { ProcessStatus } from './types';

export const PROCESSES: { key: ProcessStatus; name: string }[] = [
  { key: 'UNPRINTED', name: 'æœªãƒ—ãƒªãƒ³ãƒˆ' },
  { key: 'PRINTED', name: 'ãƒ—ãƒªãƒ³ãƒˆæ¸ˆ' },
  { key: 'CUTTING', name: 'åˆ‡å‰Š' },
  { key: 'SURFACE_TREATMENT', name: 'è¡¨é¢å‡¦ç†' },
  { key: 'PAINTING', name: 'å¡—è£…' },
  { key: 'ASSEMBLED', name: 'çµ„ä»˜ã‘æ¸ˆã¿' },
];
</file>

<file path="app/utils.ts">
// app/utils.ts
import { Part, PartItem, ProgressData, ProcessStatus } from './types';
import { PROCESSES } from './constants';

export const aggregateProgress = (parts: Part[], partItems: PartItem[]): any[] => {
  return parts.map(part => {
    const items = partItems.filter(item => item.part_id === part.id);

    // ã“ã®éƒ¨å“ã®ä¸­ã§æœ€ã‚‚ã€Œé€²ã‚“ã§ã„ãªã„ã€å·¥ç¨‹ã‚’ç¾åœ¨ã®å·¥ç¨‹ã¨ã™ã‚‹
    // (å…¨ã¦å®Œäº†ã—ã¦ã„ã‚Œã° READY ã¨ãªã‚‹)
    const processOrder = PROCESSES.map(p => p.key);
    const currentProcess = items.length > 0
      ? items.reduce((earliest, item) => {
        return processOrder.indexOf(item.status) < processOrder.indexOf(earliest)
          ? item.status
          : earliest;
      }, 'READY' as ProcessStatus)
      : 'UNPRINTED';

    return {
      id: part.id,
      part_number: part.part_number,
      status: currentProcess, // Rename field
      storage_cases: Array.from(new Set(items.map(i => i.storage_case))),
      count: items.length
    };
  });
};
</file>

<file path="lib/firebase.ts">
import { initializeApp, getApps } from "firebase/app";
import { getFirestore, connectFirestoreEmulator } from "firebase/firestore";
import { getAuth, connectAuthEmulator } from "firebase/auth";
import { getStorage, connectStorageEmulator } from "firebase/storage";

const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || "demo-bom3d-sn923";

const firebaseConfig = {
    apiKey: "fake-api-key", // Emulatorç”¨ãƒ€ãƒŸãƒ¼
    authDomain: `${projectId}.firebaseapp.com`,
    projectId: projectId,
    storageBucket: `${projectId}.appspot.com`,
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef"
};

const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const isEmulator = process.env.NODE_ENV === 'development' || projectId.startsWith('demo-');

if (isEmulator) {
    const g = global as any;
    if (!g._firebase_emulators_connected) {
        // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ãƒãƒ¼ãƒˆã‚’å–å¾—ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        // localhost ã‚ˆã‚Šã‚‚ 127.0.0.1 ã®ã»ã†ãŒå®‰å®šã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ãŸã‚å¤‰æ›´
        connectFirestoreEmulator(db, '127.0.0.1', 8080);
        connectAuthEmulator(auth, "http://127.0.0.1:9099");
        connectStorageEmulator(storage, '127.0.0.1', 9199);
        g._firebase_emulators_connected = true;
        console.log(`Connected to Firebase Emulators: ${projectId}`);
    }
}

export { db, auth, storage };
</file>

<file path="app/actions/consumeItem.ts">
'use server'

import { mockStore } from '@/lib/mockStore'
import { revalidatePath } from 'next/cache'

/**
 * éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¶ˆè²»æ¸ˆã¿ã«ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 * @param itemId - æ¶ˆè²»ã™ã‚‹éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã®ID
 */
export async function consumeItem(itemId: string | number) {
  const id = typeof itemId === 'string' ? parseInt(itemId, 10) : itemId;

  await mockStore.updatePartItem(id, {
    status: 'READY', // æœ¬æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã¦READYã«ã™ã‚‹ã‹ã€ã¾ãŸã¯åˆ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    completed_at: new Date(),
    storage_case: 'CONSUMED' // ä¾¿å®œä¸Šã®è¡¨è¨˜
  });

  console.log(`Consumed item ${id}`);

  revalidatePath('/');
  revalidatePath(`/item/${id}`);
}
</file>

<file path="app/components/swimlane/SwimlaneColumn.tsx">
import React from 'react';
import { Part, PartItem } from '@/app/types';
import { PROCESSES } from '@/app/constants';
import { SwimlaneCell } from './SwimlaneCell';
import FileDownloadButton from '@/app/components/common/FileDownloadButton';

interface SwimlaneColumnProps {
    part: Part;
    items: PartItem[];
    selectedIds: number[];
    onToggleSelect: (itemId: number) => void;
    onPreview: (item: any) => void;
}

export function SwimlaneColumn({ part, items, selectedIds, onToggleSelect, onPreview }: SwimlaneColumnProps) {
    // Find the "furthest" process index that has items
    const lastActiveIndex = items.reduce((max, item) => {
        const idx = PROCESSES.findIndex(p => p.key === item.status);
        return Math.max(max, idx);
    }, -1);

    return (
        <div className="
      relative flex flex-col
      w-[85vw] md:w-64 shrink-0 snap-center
      border-r border-gray-200 bg-white
    ">
            {/* Column Header - Part Info */}
            <div className="sticky top-0 z-20 h-24 bg-white/80 backdrop-blur-md border-b border-gray-200 p-4 flex flex-col justify-between group-hover:bg-white transition-colors">
                <div className="min-w-0">
                    <h3 className="font-black text-gray-900 text-xs tracking-tight truncate uppercase" title={part.part_number}>
                        {part.part_number}
                    </h3>
                    <div className="flex items-center gap-1.5 mt-1">
                        <div className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse" />
                        <p className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">
                            Active
                        </p>
                    </div>
                </div>

                <div className="flex items-center justify-between gap-2 mt-2">
                    <div className="flex flex-wrap gap-1">
                        {Array.from(new Set(items.map(i => i.storage_case).filter(Boolean))).map(sc => (
                            <span key={sc} className="text-[9px] px-1.5 py-0.5 bg-blue-50 text-blue-600 font-bold rounded-md border border-blue-100">
                                {sc}
                            </span>
                        ))}
                    </div>
                    <div className="text-[10px] text-gray-400 font-medium shrink-0">
                        {items.length} units
                    </div>
                </div>
            </div>

            {/* Cells with Progress Line Overlay */}
            <div className="relative flex-1 bg-gray-50/30">
                {/* Vertical Progress Line (Connector) */}
                {lastActiveIndex >= 0 && (
                    <div
                        className="absolute left-1/2 -translate-x-1/2 top-0 w-[3px] -z-0"
                        style={{
                            height: `${(lastActiveIndex + 0.5) * 80}px`,
                            transition: 'height 0.5s cubic-bezier(0.4, 0, 0.2, 1)'
                        }}
                    >
                        <div className="h-full w-full bg-gradient-to-b from-blue-100 via-blue-200 to-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.2)]" />
                    </div>
                )}

                {/* Status Cells */}
                <div className="flex flex-col">
                    {PROCESSES.map((proc, index) => (
                        <SwimlaneCell
                            key={proc.key}
                            partId={part.id}
                            status={proc.key}
                            items={items.filter(i => i.status === proc.key)}
                            isLast={index === PROCESSES.length - 1}
                            selectedIds={selectedIds}
                            onToggleSelect={onToggleSelect}
                            onPreview={onPreview}
                        />
                    ))}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="app/components/swimlane/SwimlaneItem.tsx">
import React from 'react';
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { GripVertical, Eye } from 'lucide-react';
import { PartItem } from '@/app/types';

interface SwimlaneItemProps {
    item: PartItem & { part_number?: string };
    isOverlay?: boolean;
    isSelected?: boolean;
    onToggleSelect: (itemId: number) => void;
    onPreview: (item: any) => void;
}

export function SwimlaneItem({ item, isOverlay, isSelected, onToggleSelect, onPreview }: SwimlaneItemProps) {
    const {
        attributes,
        listeners,
        setNodeRef,
        transform,
        transition,
        isDragging
    } = useSortable({ id: `item-${item.id}` });

    const style = {
        transform: CSS.Transform.toString(transform),
        transition,
        opacity: isDragging ? 0.3 : 1,
        zIndex: isDragging || isOverlay ? 999 : 'auto',
    };

    return (
        <div
            ref={setNodeRef}
            style={style}
            className={`
        bg-white rounded-xl shadow-sm border p-2 select-none group relative
        ${isOverlay ? 'shadow-2xl scale-105 border-blue-500 ring-4 ring-blue-50' : 'hover:border-blue-400 hover:shadow-md'}
        ${isSelected ? 'border-blue-500 bg-blue-50/30 ring-2 ring-blue-100' : 'border-gray-200'}
        transition-all duration-200
      `}
        >
            <div className="flex items-center justify-between gap-3">
                {/* Drag Handle */}
                <div
                    {...attributes}
                    {...listeners}
                    className="cursor-grab active:cursor-grabbing p-1.5 -ml-1.5 text-gray-300 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors touch-none"
                >
                    <GripVertical size={16} />
                </div>

                {/* Item Content */}
                <div className="flex-1 min-w-0">
                    <div className="flex flex-col">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="font-black text-xs text-gray-900 tracking-tight">#{item.id}</span>
                        </div>
                        {item.updated_at && (
                            <div className="text-[9px] text-gray-400 font-medium">
                                Last: {new Date(item.updated_at).toLocaleDateString()}
                            </div>
                        )}
                    </div>
                </div>

                {/* Selection Checkbox */}
                <div className="flex items-center">
                    <input
                        type="checkbox"
                        checked={isSelected}
                        onChange={(e) => {
                            e.stopPropagation();
                            onToggleSelect(item.id);
                        }}
                        className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                    />
                </div>

                {/* Action Buttons */}
                <button
                    onClick={(e) => {
                        e.stopPropagation();
                        onPreview(item);
                    }}
                    className="text-gray-400 hover:text-blue-600 p-2 rounded-xl hover:bg-blue-50 transition-colors shadow-sm bg-gray-50/50"
                    title="è©³ç´°ã‚’è¦‹ã‚‹"
                >
                    <Eye size={16} />
                </button>
            </div>
        </div>
    );
}
</file>

<file path="lib/mockStore.ts">
import { Part, PartItem, Project, ProcessStatus } from '@/app/types';
import { db } from './firebase';
import {
    collection,
    getDocs,
    doc,
    getDoc,
    updateDoc,
    setDoc,
    query,
    where,
    Timestamp,
    serverTimestamp
} from 'firebase/firestore';

// Firestoreã®ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ï¼ˆDateå‹ã®å¾©å…ƒãªã©ï¼‰
const dateConverter = (data: any): any => {
    if (!data) return data;
    const result = { ...data };
    // completed_atãªã©ã®Timestampã‚’Dateã«æˆ»ã™
    Object.keys(result).forEach(key => {
        if (result[key] instanceof Timestamp) {
            result[key] = result[key].toDate();
        }
    });
    return result;
};

export const mockStore = {
    getProjects: async (): Promise<Project[]> => {
        const snapshot = await getDocs(collection(db, 'projects'));
        return snapshot.docs.map(doc => ({
            id: Number(doc.id),
            ...dateConverter(doc.data())
        })) as Project[];
    },

    getProject: async (id: number): Promise<Project | null> => {
        const docRef = doc(db, 'projects', String(id));
        const span = await getDoc(docRef);
        if (!span.exists()) return null;
        return { id: Number(span.id), ...dateConverter(span.data()) } as Project;
    },

    getParts: async (projectId?: number): Promise<Part[]> => {
        let q;
        if (projectId) {
            q = query(collection(db, 'parts'), where('project_id', '==', projectId));
        } else {
            q = collection(db, 'parts');
        }
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({
            id: Number(doc.id),
            ...dateConverter(doc.data())
        })) as Part[];
    },

    getPartItems: async (projectId?: number): Promise<PartItem[]> => {
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDæŒ‡å®šãŒã‚ã‚‹å ´åˆã€ã¾ãšå¯¾è±¡ã®Partã‚’å–å¾—
        let targetPartIds: number[] | null = null;
        if (projectId) {
            const parts = await mockStore.getParts(projectId);
            targetPartIds = parts.map(p => p.id);
            if (targetPartIds.length === 0) return [];
        }

        // Firestoreã® 'in' å¥ã¯æœ€å¤§10å€‹ã¾ã§ãªã®ã§ã€ã“ã“ã§ã¯å…¨ä»¶å–å¾—ã—ã¦JSã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ–¹å¼ã‚’æ¡ç”¨
        // (ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ãŸã‚ç°¡æ˜“å®Ÿè£…)
        const snapshot = await getDocs(collection(db, 'partItems'));
        const items = snapshot.docs.map(doc => ({
            id: Number(doc.id),
            ...dateConverter(doc.data())
        })) as PartItem[];

        if (targetPartIds) {
            return items.filter(item => targetPartIds!.includes(item.part_id));
        }
        return items;
    },

    getPartItem: async (id: number): Promise<(PartItem & { parts: Part }) | null> => {
        const itemRef = doc(db, 'partItems', String(id));
        const itemSnap = await getDoc(itemRef);

        if (!itemSnap.exists()) return null;
        const itemData = { id: Number(itemSnap.id), ...dateConverter(itemSnap.data()) } as PartItem;

        // é–¢é€£ã™ã‚‹Partã‚’å–å¾—
        const partRef = doc(db, 'parts', String(itemData.part_id));
        const partSnap = await getDoc(partRef);

        if (!partSnap.exists()) {
            throw new Error(`Part not found for item ${id}`);
        }
        const partData = { id: Number(partSnap.id), ...dateConverter(partSnap.data()) } as Part;

        return { ...itemData, parts: partData };
    },

    updatePartItem: async (id: number, updates: Partial<PartItem>): Promise<void> => {
        const docRef = doc(db, 'partItems', String(id));
        await updateDoc(docRef, updates);
    },

    updatePartItemStatus: async (id: string | number, newStatus: string): Promise<void> => {
        const docRef = doc(db, 'partItems', String(id));
        await updateDoc(docRef, {
            status: newStatus as ProcessStatus,
            updated_at: serverTimestamp()
        });
    },

    addPartItem: async (item: Omit<PartItem, 'id'>): Promise<PartItem> => {
        // IDã®è‡ªå‹•æ¡ç•ªï¼ˆMax + 1ï¼‰
        const snapshot = await getDocs(collection(db, 'partItems'));
        const ids = snapshot.docs.map(d => Number(d.id));
        const newId = ids.length > 0 ? Math.max(...ids) + 1 : 1;

        const newItem = { ...item, id: newId };
        const docRef = doc(db, 'partItems', String(newId));
        await setDoc(docRef, newItem);

        return newItem as PartItem;
    },

    // äº’æ›æ€§ã®ãŸã‚ã®ãƒ€ãƒŸãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
    saveToLocalStorage: () => {
        console.warn('saveToLocalStorage is deprecated in Firestore mode');
    },

    loadFromLocalStorage: () => {
        console.warn('loadFromLocalStorage is deprecated in Firestore mode');
    }
};
</file>

<file path="app/actions/createPrinted.ts">
'use server'

import { storage, db } from '@/lib/firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import {
  collection,
  getDocs,
  doc,
  runTransaction,
  query,
  where,
  serverTimestamp,
  increment
} from 'firebase/firestore';
import { revalidatePath } from 'next/cache';
import { parseFileName } from '@/lib/utils/parseFileName';
import { Part, PartItem, ProcessStatus } from '@/app/types';

/**
 * 3Dãƒ—ãƒªãƒ³ãƒˆã•ã‚ŒãŸæ–°ã—ã„éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¼·åŒ–ç‰ˆï¼‰
 * 
 * @param fileBuffer - STLãƒ•ã‚¡ã‚¤ãƒ«ã®ArrayBuffer
 * @param fileName - ãƒ•ã‚¡ã‚¤ãƒ«å
 * @param projectId - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
 * @param qty - æ•°é‡
 * @param targetStatus - åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
 */
export async function createPrinted(
  fileBuffer: ArrayBuffer,
  fileName: string,
  projectId: number,
  qty: number,
  targetStatus: ProcessStatus = 'PRINTED'
) {
  try {
    // 1. ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è§£æã—ã¦éƒ¨å“ç•ªå·ã‚’å–å¾—
    const parsed = parseFileName(fileName);
    if (!parsed.isValid) {
      throw new Error(parsed.errorMessage || 'ãƒ•ã‚¡ã‚¤ãƒ«åã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    const partNumber = parsed.partNumber;

    // 2. Firebase Storage ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
    const timestamp = Date.now();
    const storagePath = `projects/${projectId}/stl/${partNumber}_${timestamp}.stl`;
    const storageRef = ref(storage, storagePath);
    await uploadBytes(storageRef, fileBuffer);
    const downloadUrl = await getDownloadURL(storageRef);

    // 3. Firestore ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§éƒ¨å“ã¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆ
    await runTransaction(db, async (transaction) => {
      // 3a. éƒ¨å“(Part)ã®å­˜åœ¨ç¢ºèª
      const partsRef = collection(db, 'parts');
      const q = query(
        partsRef,
        where('part_number', '==', partNumber),
        where('project_id', '==', projectId)
      );
      const partQuerySnapshot = await getDocs(q); // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã® getDocs ã¯åˆ¶é™ãŒã‚ã‚‹å ´åˆãŒã‚ã‚‹ãŒã€Firebase V9+ ã§ã¯ transaction.get(query) ãŒåŸºæœ¬ã€‚

      // æ³¨æ„: Firestore ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã®ã‚¯ã‚¨ãƒªã¯è¤‡é›‘ãªãŸã‚ã€
      // ã“ã“ã§ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¨ã—ã¦éƒ¨å“ç•ªå·ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ä¸€åº¦æ¤œç´¢ã—ãŸå¾Œã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã€‚
      // ã—ã‹ã—ã€è¦ä»¶ã«åˆã‚ã›ã¦ã€Œæ•´åˆæ€§ã‚’ä¿ã¤ã€ãŸã‚ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã€‚

      let partId: number;

      if (partQuerySnapshot.empty) {
        // æ–°è¦ä½œæˆãŒå¿…è¦ãªå ´åˆã€æ–°ã—ã„IDã‚’æ±ºå®šï¼ˆã“ã“ã§ã¯ç°¡æ˜“çš„ã«å…¨ä»¶å–å¾—ã§æœ€å¤§ID+1ï¼‰
        // æœ¬æ¥ã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒæœ›ã¾ã—ã„
        const allPartsSnapshot = await getDocs(collection(db, 'parts'));
        const existingIds = allPartsSnapshot.docs.map(d => Number(d.id));
        partId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;

        const newPart: Part = {
          id: partId,
          part_number: partNumber,
          project_id: projectId
        };

        const partDocRef = doc(db, 'parts', String(partId));
        transaction.set(partDocRef, newPart);
        console.log(`Transaction: Created new Part: ${partNumber} (ID: ${partId})`);
      } else {
        partId = Number(partQuerySnapshot.docs[0].id);
        console.log(`Transaction: Using existing Part: ${partNumber} (ID: ${partId})`);
      }

      // 3b. PartItem ã‚’æŒ‡å®šã•ã‚ŒãŸå€‹æ•°åˆ†ä½œæˆ
      const allItemsSnapshot = await getDocs(collection(db, 'partItems'));
      const existingItemIds = allItemsSnapshot.docs.map(d => Number(d.id));
      let nextItemId = existingItemIds.length > 0 ? Math.max(...existingItemIds) + 1 : 1;

      for (let i = 0; i < qty; i++) {
        const newItem: PartItem = {
          id: nextItemId,
          part_id: partId,
          storage_case: `AUTO-${partNumber}-${i + 1}`,
          status: targetStatus,
          completed_at: null,
          updated_at: serverTimestamp()
        };

        const itemDocRef = doc(db, 'partItems', String(nextItemId));
        transaction.set(itemDocRef, {
          ...newItem,
          stl_url: downloadUrl // ä¿å­˜ã•ã‚ŒãŸURLã‚’ç´ä»˜ã‘
        });
        nextItemId++;
      }
    });

    console.log(`Successfully created ${qty} items for part ${partNumber}`);
    revalidatePath('/');
    if (projectId) revalidatePath(`/project/${projectId}`);

    return { success: true, partNumber };

  } catch (error) {
    console.error('Error in createPrinted:', error);
    throw error;
  }
}
</file>

<file path="app/actions/updateProcess.ts">
'use server'

import { mockStore } from '@/lib/mockStore'
import { ProcessStatus } from '@/app/types'
import { revalidatePath } from 'next/cache'

/**
 * éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã®å·¥ç¨‹ã‚’æ›´æ–°ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 * @param itemId - æ›´æ–°ã™ã‚‹éƒ¨å“ã‚¢ã‚¤ãƒ†ãƒ ã®ID
 * @param nextProcess - æ¬¡ã®å·¥ç¨‹å
 */
export async function updateProcess(
  itemId: string | number,
  nextProcess: string,
  projectId?: number
) {
  // æ–‡å­—åˆ—IDã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆmockStoreã®ä»•æ§˜ã«åˆã‚ã›ã‚‹ï¼‰
  const id = typeof itemId === 'string' ? parseInt(itemId, 10) : itemId;

  // ãƒ¡ãƒ¢ãƒªä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
  await mockStore.updatePartItem(id, {
    status: nextProcess as ProcessStatus,
    // READYã«ç§»è¡Œã—ãŸå ´åˆã¯å®Œäº†æ—¥æ™‚ã‚’è¨­å®š
    completed_at: nextProcess === 'READY' ? new Date() : null
  });

  // å·¥ç¨‹ãƒ­ã‚°ã¯ãƒ¢ãƒƒã‚¯ç‰ˆã§ã¯çœç•¥ã€ã¾ãŸã¯å¿…è¦ãªã‚‰è¿½åŠ 
  console.log(`Updated item ${id} to status ${nextProcess}`);

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ã¦UIã«åæ˜ 
  revalidatePath('/');
  revalidatePath(`/item/${id}`);
  if (projectId) {
    revalidatePath(`/project/${projectId}`);
  }
}
</file>

<file path="app/data.ts">
// app/data.ts
import { Part, PartItem, Project } from './types';

export const projects: Project[] = [
  { id: 1, name: 'æ¬¡ä¸–ä»£ãƒ‰ãƒ­ãƒ¼ãƒ³é–‹ç™º', description: 'é«˜è§£åƒåº¦ã‚«ãƒ¡ãƒ©æ­è¼‰ã®æ–°å‹ãƒ‰ãƒ­ãƒ¼ãƒ³é–‹ç™ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', deadline: '2026-06-30' },
  { id: 2, name: 'æ¬é€ãƒ­ãƒœãƒƒãƒˆè£½ä½œ', description: 'å€‰åº«å†…è‡ªå‹•é…é€ã‚’è¡Œã†è‡ªå¾‹èµ°è¡Œãƒ­ãƒœãƒƒãƒˆã®è©¦ä½œ', deadline: '2026-04-15' }
];

export const parts: Part[] = [
  { id: 1, part_number: 'DRONE-ARM-01', project_id: 1 },
  { id: 2, part_number: 'DRONE-BODY-01', project_id: 1 },
  { id: 3, part_number: 'DRONE-PROP-01', project_id: 1 },
  { id: 4, part_number: 'ROBO-WHEEL-X', project_id: 2 }
];

export const partItems: PartItem[] = [
  // DRONE-ARM-01 (id: 1) - åˆ†æ•£é…ç½®
  { id: 101, part_id: 1, storage_case: 'Case-A1', status: 'UNPRINTED', completed_at: null },
  { id: 102, part_id: 1, storage_case: 'Case-A1', status: 'PRINTED', completed_at: null },
  { id: 103, part_id: 1, storage_case: 'Case-A2', status: 'PRINTED', completed_at: null },
  { id: 104, part_id: 1, storage_case: 'Case-A3', status: 'SURFACE_TREATMENT', completed_at: null },
  { id: 105, part_id: 1, storage_case: 'Case-A4', status: 'ASSEMBLED', completed_at: new Date() },

  // DRONE-BODY-01 (id: 2) - ç‰¹å®šå·¥ç¨‹ã«é›†ä¸­
  { id: 201, part_id: 2, storage_case: 'Case-B1', status: 'SURFACE_TREATMENT', completed_at: null },
  { id: 202, part_id: 2, storage_case: 'Case-B1', status: 'SURFACE_TREATMENT', completed_at: null },
  { id: 203, part_id: 2, storage_case: 'Case-B2', status: 'PAINTING', completed_at: null },

  // DRONE-PROP-01 (id: 3) - å°‘ãªã„ã‚¢ã‚¤ãƒ†ãƒ ã€ä¸è‰¯ã‚ã‚Š
  { id: 301, part_id: 3, storage_case: 'Case-C1', status: 'UNPRINTED', completed_at: null },
  { id: 302, part_id: 3, storage_case: 'Case-C2', status: 'DEFECTIVE', completed_at: null },

  // ROBO-WHEEL-X (id: 4) - åˆ¥ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
  { id: 401, part_id: 4, storage_case: 'Case-R1', status: 'ASSEMBLED', completed_at: new Date(new Date().setDate(new Date().getDate() - 2)) }
];
</file>

<file path="app/types.ts">
export type ProcessStatus =
  | 'UNPRINTED'
  | 'PRINTED'
  | 'CUTTING'
  | 'SURFACE_TREATMENT'
  | 'PAINTING'
  | 'ASSEMBLED'
  | 'DEFECTIVE';

export interface Project {
  id: number;
  name: string;
  description: string;
  deadline: string;
}

export interface Part {
  id: number;
  part_number: string;
  project_id: number;
}

export interface PartItem {
  id: number;
  part_id: number;
  storage_case: string;
  status: ProcessStatus;
  completed_at: Date | null;
  updated_at?: any;
}

export interface ProgressData {
  part_number: string;
  storage_cases: string[];
  counts: Record<ProcessStatus, number>;
}
</file>

<file path="app/page.tsx">
import Link from 'next/link';
import { mockStore } from '@/lib/mockStore';

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
 */
export default async function ProjectsDashboardPage() {
  const projects = await mockStore.getProjects();

  return (
    <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
      <header className="mb-12 text-center">
        <h1 className="text-4xl font-extrabold text-gray-900 mb-4 tracking-tight">
          BOMé€²æ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        </h1>
        <p className="text-xl text-gray-600 max-w-2xl mx-auto">
          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ã€éƒ¨å“ã®è£½é€ å·¥ç¨‹ã¨é€²æ—çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™ã€‚
        </p>
      </header>

      <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
        {projects.map((project) => (
          <Link key={project.id} href={`/project/${project.id}`}>
            <div className="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden cursor-pointer flex flex-col h-full transform hover:-translate-y-1">
              <div className="p-8 flex-grow">
                <div className="flex justify-between items-start mb-6">
                  <h2 className="text-2xl font-bold text-gray-800 group-hover:text-blue-600 transition-colors">
                    {project.name}
                  </h2>
                  <span className="bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                    é€²è¡Œä¸­
                  </span>
                </div>
                <p className="text-gray-600 mb-8 leading-relaxed">
                  {project.description}
                </p>

                {/* ç°¡æ˜“é€²æ—è¡¨ç¤ºï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ */}
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <span className="font-medium text-gray-700">å…¨ä½“é€²æ—</span>
                    <span className="font-bold text-blue-600">65%</span>
                  </div>
                  <div className="w-full bg-gray-100 rounded-full h-3">
                    <div className="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full w-[65%] shadow-sm"></div>
                  </div>
                </div>
              </div>

              <div className="px-8 py-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center group-hover:bg-blue-50 transition-colors">
                <div className="text-sm">
                  <span className="text-gray-500">ç´æœŸ: </span>
                  <span className="font-semibold text-gray-800">{project.deadline}</span>
                </div>
                <span className="text-blue-600 font-bold flex items-center group-hover:translate-x-1 transition-transform">
                  è©³ç´°ã‚’è¦‹ã‚‹
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                  </svg>
                </span>
              </div>
            </div>
          </Link>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="app/item/[id]/page.tsx">
import { mockStore } from '@/lib/mockStore'
import { updateProcess } from '@/app/actions/updateProcess'
import { consumeItem } from '@/app/actions/consumeItem'
import { reportDefect } from '@/app/actions/reportDefect' // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { PROCESSES } from '@/app/constants'
import Link from 'next/link'

export default async function ItemPage(props: { params: Promise<{ id: string }> }) {
  const params = await props.params;
  const id = parseInt(params.id, 10);
  const data = await mockStore.getPartItem(id);

  if (!data) {
    return <div className="p-8">ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>;
  }

  return (
    <div className="p-8 max-w-2xl mx-auto bg-white shadow-lg rounded-xl mt-10 border border-gray-100">
      <Link href={`/project/${data.parts.project_id}`} className="text-sm text-blue-600 hover:underline mb-6 inline-block font-bold">
        â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã«æˆ»ã‚‹
      </Link>

      <div className="flex justify-between items-start mb-6">
        <h1 className="text-3xl font-black text-gray-900">{data.parts.part_number}</h1>
        <span className={`px-3 py-1 rounded-full text-xs font-bold ${data.status === 'DEFECTIVE' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
          ID: {id}
        </span>
      </div>

      {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */}
      <div className={`p-4 rounded-lg mb-8 border ${data.status === 'DEFECTIVE' ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-100'}`}>
        <p className="text-sm font-bold text-gray-500 uppercase tracking-wider">Current Status</p>
        <p className={`text-2xl font-black ${data.status === 'DEFECTIVE' ? 'text-red-700' : 'text-blue-800'}`}>
          {PROCESSES.find(p => p.key === data.status)?.name || data.status}
        </p>
      </div>

      <div className="space-y-10">
        {/* 1. é€šå¸¸ã®å·¥ç¨‹æ›´æ–° */}
        <section>
          <h2 className="text-sm font-bold text-gray-400 uppercase mb-3">å·¥ç¨‹ã‚’é€²ã‚ã‚‹</h2>
          <form action={async (formData) => {
            'use server'
            const next = formData.get('next') as string;
            await updateProcess(id, next, data.parts.project_id);
          }} className="flex gap-2">
            <select name="next" defaultValue={data.status} className="flex-1 p-3 border rounded-lg font-bold">
              {PROCESSES.map(proc => <option key={proc.key} value={proc.key}>{proc.name}</option>)}
            </select>
            <button className="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-black transition-colors">æ›´æ–°</button>
          </form>
        </section>

        {/* 2. ä¸è‰¯å ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã“ãŒé‡è¦ï¼‰ */}
        {data.status !== 'DEFECTIVE' && (
          <section className="p-6 border-2 border-red-200 rounded-2xl bg-red-50/50">
            <h2 className="text-lg font-black text-red-700 mb-2 flex items-center gap-2">
              âš ï¸ ä¸è‰¯ãƒ»å†è£½ä½œã®å ±å‘Š
            </h2>
            <p className="text-sm text-red-600 mb-4 font-medium">
              ã“ã®å€‹ä½“ã«æ¬ é™¥ãŒã‚ã‚‹å ´åˆã€ã“ã“ã§å ±å‘Šã—ã¾ã™ã€‚ã“ã®å€‹ä½“ã¯ã€Œä¸è‰¯ã€ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã€è‡ªå‹•çš„ã«ã€Œæœªãƒ—ãƒªãƒ³ãƒˆã€ã®æ–°ã—ã„ã‚¸ãƒ§ãƒ–ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
            </p>
            <form action={async (formData) => {
              'use server'
              const reason = formData.get('reason') as string;
              await reportDefect(id, reason);
            }} className="space-y-3">
              <input
                name="reason"
                placeholder="ä¸è‰¯ç†ç”±ï¼ˆä¾‹ï¼šç©å±¤å‰¥é›¢ã€å¯¸æ³•èª¤å·®ï¼‰"
                className="w-full p-3 border-2 border-red-100 rounded-xl focus:border-red-500 outline-none bg-white font-medium"
                required
              />
              <button className="w-full bg-red-600 text-white font-black py-4 rounded-xl hover:bg-red-700 transition-all shadow-lg active:scale-[0.98]">
                ä¸è‰¯ã‚’ç¢ºå®šã—ã€å†è£½ä½œã‚’ä¾é ¼
              </button>
            </form>
          </section>
        )}

        {/* 3. å®Œäº†å‡¦ç† */}
        <section>
          <form action={async () => {
            'use server'
            await consumeItem(id);
          }}>
            <button className="w-full border-2 border-green-600 text-green-600 font-black py-4 rounded-xl hover:bg-green-50 transition-colors">
              çµ„ã¿è¾¼ã¿å®Œäº†ï¼ˆã‚¹ãƒˆãƒƒã‚¯ã‹ã‚‰é™¤å¤–ï¼‰
            </button>
          </form>
        </section>
      </div>
    </div>
  )
}
</file>

<file path="package.json">
{
  "name": "sn-923",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@react-three/drei": "^10.7.7",
    "@react-three/fiber": "^9.5.0",
    "@tailwindcss/postcss": "^4.1.18",
    "@types/three": "^0.182.0",
    "firebase": "^12.8.0",
    "lucide-react": "^0.563.0",
    "next": "^16.1.6",
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "three": "^0.182.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^19.2.10",
    "@types/react-dom": "^19.2.3",
    "autoprefixer": "^10.4.23",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "typescript": "^5.3.0"
  }
}
</file>

<file path="app/print/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { useRouter, useSearchParams } from 'next/navigation';
import { PROCESSES } from '../constants';
import { createPrinted } from '../actions/createPrinted';
import { parseFileName, ParsedFileInfo } from '@/lib/utils/parseFileName';
import { ProcessStatus } from '../types';

import { Suspense } from 'react';

function PrintRegistrationContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const projectIdStr = searchParams.get('project_id');
  const projectId = projectIdStr ? parseInt(projectIdStr) : null;

  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const [parsedInfos, setParsedInfos] = useState<(ParsedFileInfo & { file: File })[]>([]);
  const [targetStatus, setTargetStatus] = useState<ProcessStatus>('PRINTED');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®è§£æå‡¦ç†
  useEffect(() => {
    if (selectedFiles.length > 0) {
      const infos = selectedFiles.map(file => ({
        ...parseFileName(file.name),
        file
      }));
      setParsedInfos(infos);
    } else {
      setParsedInfos([]);
    }
  }, [selectedFiles]);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      setSelectedFiles(Array.from(files));
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (selectedFiles.length === 0 || !projectId) {
      alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const invalidFiles = parsedInfos.filter(info => !info.isValid);
    if (invalidFiles.length > 0) {
      alert('è§£æã«å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ä¿®æ­£ã¾ãŸã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    setIsSubmitting(true);

    try {
      // é †æ¬¡ç™»éŒ²ï¼ˆä¸¦åˆ—ã«ã™ã‚‹ã¨Firestoreã®IDæ¡ç•ªã§ã¶ã¤ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é †æ¬¡å‡¦ç†ï¼‰
      for (const info of parsedInfos) {
        const arrayBuffer = await info.file.arrayBuffer();
        await createPrinted(
          arrayBuffer,
          info.file.name,
          projectId,
          info.quantity,
          targetStatus
        );
      }

      alert(`${parsedInfos.length} ä»¶ã®éƒ¨å“ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`);
      const redirectPath = `/project/${projectId}`;
      router.push(redirectPath);
      router.refresh();
    } catch (error) {
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const backHref = projectId ? `/project/${projectId}` : '/';

  return (
    <div className="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">
      <div className="max-w-3xl mx-auto">
        <header className="mb-8">
          <Link href={backHref} className="text-blue-600 hover:underline mb-2 inline-block">
            â† {projectId ? 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥é€²æ—ã«æˆ»ã‚‹' : 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹'}
          </Link>
          <h1 className="text-3xl font-bold text-gray-800">3Dãƒ—ãƒªãƒ³ãƒˆä¸€æ‹¬è¿½åŠ ç™»éŒ²</h1>
          <p className="text-gray-500 mt-2">STLãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰éƒ¨å“æƒ…å ±ã‚’è‡ªå‹•å–å¾—ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚</p>
        </header>

        <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-lg p-6 space-y-6">
          {/* STLãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */}
          <div className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${selectedFiles.length > 0 ? 'border-blue-400 bg-blue-50' : 'border-gray-300 hover:border-blue-500'
            }`}>
            <input
              type="file"
              accept=".stl"
              onChange={handleFileChange}
              multiple
              className="hidden"
              id="stl-upload"
            />
            <label htmlFor="stl-upload" className="cursor-pointer">
              <div className="text-gray-600">
                {selectedFiles.length > 0 ? (
                  <div className="space-y-2">
                    <p className="font-semibold text-blue-600 text-lg">{selectedFiles.length} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠä¸­</p>
                    <p className="text-sm text-gray-500">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ãƒ»è¿½åŠ </p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    <div className="text-4xl">ğŸ“</div>
                    <p className="font-medium">CADã‹ã‚‰å‡ºåŠ›ã—ãŸSTLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                    <p className="text-sm text-gray-400">è¤‡æ•°é¸æŠãŒå¯èƒ½ã§ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰</p>
                  </div>
                )}
              </div>
            </label>
          </div>

          {/* è§£æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ */}
          {parsedInfos.length > 0 && (
            <div className="space-y-3">
              <h3 className="font-bold text-gray-800 flex justify-between items-center">
                <span>è§£æãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                <span className="text-sm font-normal text-gray-500">{parsedInfos.length} ä»¶</span>
              </h3>
              <div className="border rounded-lg overflow-hidden divide-y bg-gray-50">
                {parsedInfos.map((info, idx) => (
                  <div key={idx} className={`p-4 flex items-center justify-between ${info.isValid ? 'bg-white' : 'bg-red-50'}`}>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-500">STL</span>
                        <p className="font-medium text-gray-900 truncate">{info.file.name}</p>
                      </div>
                      {info.isValid ? (
                        <div className="mt-1 flex items-center gap-4 text-sm text-gray-600">
                          <span>éƒ¨å“ç•ªå·: <strong className="font-mono text-blue-600">{info.partNumber}</strong></span>
                          <span>å€‹æ•°: <strong className="text-gray-900">{info.quantity}</strong></span>
                        </div>
                      ) : (
                        <p className="mt-1 text-sm text-red-600 font-medium">âš ï¸ {info.errorMessage}</p>
                      )}
                    </div>
                    <div className="ml-4">
                      {info.isValid ? (
                        <span className="text-green-500 text-xl">âœ“</span>
                      ) : (
                        <span className="text-red-500 text-xl">âœ•</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="pt-4 border-t">
            {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">ç™»éŒ²å¾Œã®åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <div className="flex gap-6">
                {['UNPRINTED', 'PRINTED'].map((status) => (
                  <label key={status} className="flex items-center cursor-pointer group">
                    <input
                      type="radio"
                      name="status"
                      value={status}
                      checked={targetStatus === status}
                      onChange={(e) => setTargetStatus(e.target.value as ProcessStatus)}
                      className="mr-2 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300"
                    />
                    <span className={`text-sm font-medium transition-colors ${targetStatus === status ? 'text-blue-700' : 'text-gray-600 group-hover:text-gray-800'}`}>
                      {PROCESSES.find(p => p.key === status)?.name}
                    </span>
                  </label>
                ))}
              </div>
            </div>
          </div>

          <button
            type="submit"
            disabled={isSubmitting || selectedFiles.length === 0 || parsedInfos.some(i => !i.isValid)}
            className={`w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all text-xl ${isSubmitting || selectedFiles.length === 0 || parsedInfos.some(i => !i.isValid)
                ? 'bg-gray-300 cursor-not-allowed'
                : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 active:transform active:scale-[0.98]'
              }`}
          >
            {isSubmitting ? (
              <span className="flex items-center justify-center">
                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                {selectedFiles.length} ä»¶ã‚’ç™»éŒ²å‡¦ç†ä¸­...
              </span>
            ) : `ãƒ—ãƒªãƒ³ãƒˆã‚¸ãƒ§ãƒ– ${selectedFiles.length} ä»¶ã‚’ç™»éŒ²å®Ÿè¡Œ`}
          </button>
        </form>
      </div>
    </div>
  );
}

export default function PrintRegistrationPage() {
  return (
    <Suspense fallback={<div className="min-h-screen flex items-center justify-center">èª­ã¿è¾¼ã¿ä¸­...</div>}>
      <PrintRegistrationContent />
    </Suspense>
  );
}
</file>

<file path="app/project/[id]/page.tsx">
import Link from 'next/link';
import { notFound } from 'next/navigation';
import { aggregateProgress } from '@/app/utils';
import { SummaryCard } from '@/app/components/SummaryCard';
import { mockStore } from '@/lib/mockStore';
import ProjectClientContent from './ProjectClientContent';

interface PageProps {
    params: Promise<{
        id: string;
    }>;
    searchParams?: Promise<{ [key: string]: string | string[] | undefined }>;
}

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥é€²æ—ãƒšãƒ¼ã‚¸ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰
 */
export default async function ProjectDetailPage(props: PageProps) {
    const params = await props.params;
    const projectId = parseInt(params.id);
    if (isNaN(projectId)) {
        notFound();
    }

    const project = await mockStore.getProject(projectId);
    if (!project) {
        notFound();
    }

    // ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    const parts = await mockStore.getParts(projectId);
    const partItems = await mockStore.getPartItems(projectId);

    const totalInventory = partItems.length;
    const inProgress = partItems.filter(item => item.status !== 'ASSEMBLED').length;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const completedToday = partItems.filter(item =>
        item.completed_at && new Date(item.completed_at) >= today
    ).length;

    // è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
    const progressData = aggregateProgress(parts, partItems);

    return (
        <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <div>
                    <Link href="/" className="text-blue-600 hover:text-blue-800 mb-2 inline-block font-medium">
                        â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¸æˆ»ã‚‹
                    </Link>
                    <h1 className="text-3xl font-bold text-gray-800">
                        {project.name}
                    </h1>
                    <p className="text-gray-600 mt-1">{project.description}</p>
                </div>
                <div className="flex gap-3">
                    <Link href="/storage">
                        <span className="bg-white text-gray-700 font-bold py-3 px-6 rounded-lg shadow-sm border border-gray-300 hover:bg-gray-50 transition-all cursor-pointer inline-block">
                            ä¿ç®¡ãƒœãƒƒã‚¯ã‚¹ç®¡ç†
                        </span>
                    </Link>
                    <Link href={`/print?project_id=${projectId}`}>
                        <span className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all cursor-pointer inline-block">
                            3Dãƒ—ãƒªãƒ³ãƒˆç™»éŒ²
                        </span>
                    </Link>
                </div>
            </header>

            {/* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <SummaryCard title="ç·åœ¨åº«æ•°" value={totalInventory} />
                <SummaryCard title="ä»•æ›å“æ•°" value={inProgress} valueColor="text-orange-500" />
                <SummaryCard title="æœ¬æ—¥å®Œäº†æ•°" value={completedToday} valueColor="text-green-500" />
            </div>

            {/* ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä¸€è¦§ãƒ»ã‚«ãƒ¼ãƒˆæ©Ÿèƒ½ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ) */}
            <ProjectClientContent
                progressData={progressData}
                parts={parts}
                partItems={partItems}
                projectId={projectId}
            />
        </div>
    );
}
</file>

<file path="app/project/[id]/ProjectClientContent.tsx">
'use client';

import React, { useState } from 'react';
import {
    DndContext,
    DragOverlay,
    closestCorners,
    KeyboardSensor,
    PointerSensor,
    useSensor,
    useSensors,
    DragEndEvent,
    DragStartEvent,
} from '@dnd-kit/core';
import {
    sortableKeyboardCoordinates,
} from '@dnd-kit/sortable';
import { CartModal } from '@/app/components/CartModal';
import { PreviewModal } from '@/app/components/PreviewModal';
import { Part, PartItem, ProcessStatus } from '@/app/types';
import { updateItemStatus } from '@/app/actions/updateItemStatus';
import { SwimlaneColumn } from '@/app/components/swimlane/SwimlaneColumn';
import { SwimlaneItem } from '@/app/components/swimlane/SwimlaneItem';
import { PROCESSES } from '@/app/constants';

// --- Main Component ---

export default function ProjectClientContent({
    progressData,
    parts,
    partItems: initialItems,
    projectId
}: {
    progressData: any[],
    parts: Part[],
    partItems: PartItem[],
    projectId: number
}) {
    // --- Deduplicate items to ensure 1 part = 1 item in 1 status ---
    const [items, setItems] = useState<PartItem[]>(() => {
        const latestItemsMap = new Map<number, PartItem>();
        initialItems.forEach(item => {
            const currentLatest = latestItemsMap.get(item.part_id);
            if (!currentLatest) {
                latestItemsMap.set(item.part_id, item);
            } else {
                const currentIdx = PROCESSES.findIndex(p => p.key === currentLatest.status);
                const newIdx = PROCESSES.findIndex(p => p.key === item.status);
                // Keep the one furthest along in the process chain
                if (newIdx > currentIdx) {
                    latestItemsMap.set(item.part_id, item);
                }
            }
        });
        return Array.from(latestItemsMap.values());
    });

    const [selectedIds, setSelectedIds] = useState<number[]>([]);
    const [isCartOpen, setIsCartOpen] = useState(false);
    const [activeId, setActiveId] = useState<string | null>(null);
    const [previewItem, setPreviewItem] = useState<any | null>(null);

    const sensors = useSensors(
        useSensor(PointerSensor, {
            activationConstraint: {
                distance: 5,
            },
        }),
        useSensor(KeyboardSensor, {
            coordinateGetter: sortableKeyboardCoordinates,
        })
    );

    const handleDragStart = (event: DragStartEvent) => {
        setActiveId(event.active.id as string);
    };

    const handleDragEnd = async (event: DragEndEvent) => {
        const { active, over } = event;
        setActiveId(null);

        if (!over) return;

        const activeIdStr = active.id as string;
        const itemId = parseInt(activeIdStr.split('-')[1], 10);
        const activeItem = items.find(i => i.id === itemId);
        if (!activeItem) return;

        let targetStatus: string | undefined;
        const overIdStr = over.id as string;

        if (overIdStr.startsWith('container-')) {
            const parts = overIdStr.split('-');
            const targetPartId = parseInt(parts[1], 10);

            // STRICT DND: Only allow movement within the same part column
            if (targetPartId !== activeItem.part_id) return;

            targetStatus = parts.slice(2).join('-');
        } else if (overIdStr.startsWith('item-')) {
            const overItemId = parseInt(overIdStr.split('-')[1], 10);
            const overItem = items.find(i => i.id === overItemId);

            // STRICT DND: Only allow movement within the same part column
            if (overItem && overItem.part_id !== activeItem.part_id) return;

            if (overItem) {
                targetStatus = overItem.status;
            }
        }

        if (targetStatus && targetStatus !== activeItem.status) {
            const originalStatus = activeItem.status;

            // Optimistic update
            setItems(prev => prev.map(i =>
                i.id === itemId ? { ...i, status: targetStatus as ProcessStatus } : i
            ));

            const result = await updateItemStatus(itemId, targetStatus);
            if (!result.success) {
                // Rollback
                setItems(prev => prev.map(i =>
                    i.id === itemId ? { ...i, status: originalStatus } : i
                ));
                alert(`Failed to update status: ${result.error}`);
            }
        }
    };

    const handleToggleSelect = (itemId: number) => {
        setSelectedIds(prev => prev.includes(itemId)
            ? prev.filter(id => id !== itemId)
            : [...prev, itemId]
        );
    };

    const activeItem = activeId
        ? items.find(i => `item-${i.id}` === activeId)
        : null;

    const cartItems = items
        .filter(i => selectedIds.includes(i.id))
        .map(i => {
            const part = parts.find(p => p.id === i.part_id);
            return {
                id: i.id,
                part_number: part?.part_number || `Part-${i.part_id}`,
                status: i.status,
                count: 1
            };
        });

    return (
        <div className="relative flex flex-col h-[75vh] bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
            <DndContext
                sensors={sensors}
                collisionDetection={closestCorners}
                onDragStart={handleDragStart}
                onDragEnd={handleDragEnd}
            >
                <div className="flex-1 overflow-x-auto overflow-y-auto scrollbar-thin scrollbar-thumb-gray-200 scrollbar-track-transparent">
                    <div className="flex w-max min-w-full">

                        {/* Legend Column */}
                        <div className="sticky left-0 z-30 w-32 md:w-44 shrink-0 bg-white border-r border-gray-200 shadow-[4px_0_12px_rgba(0,0,0,0.03)]">
                            <div className="h-24 border-b border-gray-200 flex flex-col items-center justify-center bg-gray-50/80 backdrop-blur-md">
                                <div className="text-[10px] uppercase tracking-[0.2em] font-black text-gray-300 mb-1">Process</div>
                                <div className="text-[10px] font-bold text-gray-400">Step Master</div>
                            </div>
                            <div className="flex flex-col">
                                {PROCESSES.map((proc, index) => (
                                    <div
                                        key={proc.key}
                                        className="h-[80px] border-b border-gray-100 p-3 flex flex-col justify-center bg-white"
                                    >
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="w-5 h-5 rounded-md bg-blue-50 text-blue-600 text-[10px] font-black flex items-center justify-center border border-blue-100">
                                                {index + 1}
                                            </span>
                                            <div className="h-[1px] flex-1 bg-gray-100" />
                                        </div>
                                        <div className="text-[11px] font-black text-gray-900 leading-tight uppercase tracking-tight group-hover:text-blue-600 transition-colors">
                                            {proc.name}
                                        </div>
                                        <div className="text-[9px] font-bold text-gray-300 mt-1 uppercase tracking-wider">
                                            Stage 0{index + 1}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Parts Columns Grid */}
                        <div className="flex divide-x divide-gray-100 snap-x snap-mandatory md:snap-none">
                            {parts.map(part => (
                                <SwimlaneColumn
                                    key={part.id}
                                    part={part}
                                    items={items.filter(i => i.part_id === part.id)}
                                    selectedIds={selectedIds}
                                    onToggleSelect={handleToggleSelect}
                                    onPreview={(item) => {
                                        const part = parts.find(p => p.id === item.part_id);
                                        setPreviewItem({
                                            ...item,
                                            part_number: part?.part_number
                                        });
                                    }}
                                />
                            ))}
                        </div>
                    </div>
                </div>

                <DragOverlay>
                    {activeItem ? (
                        <div className="w-48 shadow-2xl">
                            <SwimlaneItem
                                item={{
                                    ...activeItem,
                                    part_number: parts.find(p => p.id === activeItem.part_id)?.part_number
                                }}
                                isOverlay
                                isSelected={selectedIds.includes(activeItem.id)}
                                onToggleSelect={() => { }}
                                onPreview={() => { }}
                            />
                        </div>
                    ) : null}
                </DragOverlay>
            </DndContext>

            {/* Floating Cart Button */}
            <div className="fixed bottom-8 right-8 z-50">
                <button
                    onClick={() => setIsCartOpen(true)}
                    className="relative bg-black text-white p-4 rounded-full shadow-2xl hover:scale-105 active:scale-95 transition-all group"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    {selectedIds.length > 0 && (
                        <span className="absolute -top-2 -right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full border-2 border-white shadow-sm">
                            {selectedIds.length}
                        </span>
                    )}
                </button>
            </div>

            <CartModal
                isOpen={isCartOpen}
                onClose={() => setIsCartOpen(false)}
                items={cartItems}
                onDownload={() => {
                    console.log('Downloading Zip for items:', selectedIds);
                    alert("Zipãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™");
                }}
            />

            <PreviewModal
                isOpen={!!previewItem}
                onClose={() => setPreviewItem(null)}
                partNumber={previewItem?.part_number || ''}
                itemId={previewItem?.id}
                status={previewItem?.status}
                projectId={projectId}
            />
        </div>
    );
}
</file>

</files>
