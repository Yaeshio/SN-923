This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.continue/agents/new-config.yaml
.env,local
.firebaserc
.gitignore
app/actions/consumeItem.ts
app/actions/createPrinted.ts
app/actions/importStl.ts
app/actions/reportDefect.ts
app/actions/storageActions.ts
app/actions/updateItemStatus.ts
app/actions/updateProcess.ts
app/api/import-stl/route.ts
app/api/preview-filenames/route.ts
app/constants.ts
app/data.ts
app/globals.css
app/item/[id]/page.tsx
app/layout.tsx
app/page.tsx
app/print/page.tsx
app/project/[id]/page.tsx
app/project/[id]/ProjectClientContent.tsx
app/storage/page.tsx
app/types.ts
app/utils.ts
diagram_full.mmd
diagram.mmd
docs/INTEGRATION_EXAMPLE.md
docs/STL_IMPORT_GUIDE.md
emulator_data/auth_export/accounts.json
emulator_data/auth_export/config.json
emulator_data/firebase-export-metadata.json
emulator_data/firestore_export/all_namespaces/all_kinds/all_namespaces_all_kinds.export_metadata
emulator_data/firestore_export/all_namespaces/all_kinds/output-0
emulator_data/firestore_export/firestore_export.overall_export_metadata
emulator_data/storage_export/buckets.json
firebase-data/auth_export/accounts.json
firebase-data/auth_export/config.json
firebase-data/firebase-export-metadata.json
firebase-data/firestore_export/all_namespaces/all_kinds/all_namespaces_all_kinds.export_metadata
firebase-data/firestore_export/all_namespaces/all_kinds/output-0
firebase-data/firestore_export/firestore_export.overall_export_metadata
firebase-data/storage_export/blobs/1592b06d-023b-4d51-a98b-9b3ec464ab92
firebase-data/storage_export/blobs/62721c6e-4531-4e24-9503-c9354d564dda
firebase-data/storage_export/blobs/6b16cb67-4e80-4417-a181-dbc10ab6386a
firebase-data/storage_export/blobs/83c411db-774b-4e81-a3e4-26fad60acd23
firebase-data/storage_export/blobs/b257a210-a7a3-4c46-b1b3-f2d9dec88453
firebase-data/storage_export/buckets.json
firebase-data/storage_export/metadata/1592b06d-023b-4d51-a98b-9b3ec464ab92.json
firebase-data/storage_export/metadata/62721c6e-4531-4e24-9503-c9354d564dda.json
firebase-data/storage_export/metadata/6b16cb67-4e80-4417-a181-dbc10ab6386a.json
firebase-data/storage_export/metadata/83c411db-774b-4e81-a3e4-26fad60acd23.json
firebase-data/storage_export/metadata/b257a210-a7a3-4c46-b1b3-f2d9dec88453.json
firebase-export-1770456349158PyqgDy/firestore_export/all_namespaces/all_kinds/all_namespaces_all_kinds.export_metadata
firebase-export-1770456349158PyqgDy/firestore_export/all_namespaces/all_kinds/output-0
firebase-export-1770456349158PyqgDy/firestore_export/firestore_export.overall_export_metadata
firebase-export-1770545049902UW2hwo/firestore_export/all_namespaces/all_kinds/all_namespaces_all_kinds.export_metadata
firebase-export-1770545049902UW2hwo/firestore_export/all_namespaces/all_kinds/output-0
firebase-export-1770545049902UW2hwo/firestore_export/firestore_export.overall_export_metadata
firebase.json
firestore.indexes.json
firestore.rules
graph.dot
lib/firebase.ts
lib/mockStore.ts
lib/utils/parseFileName.ts
next.config.js
out.svg
package.json
postcss.config.js
public/models/PART-A.stl
README.md
scripts/seed-emulator.ts
scripts/seed-initial-data.ts
src/modules/engineering/actions/importStl.ts
src/modules/engineering/actions/projectActions.ts
src/modules/engineering/components/StlImportModal.tsx
src/modules/engineering/services/stlService.ts
src/modules/inventory/actions/storageActions.ts
src/modules/inventory/components/StorageBoxGrid.tsx
src/modules/inventory/services/boxService.ts
src/modules/inventory/services/partService.ts
src/modules/inventory/types/index.ts
src/modules/logistics/components/CartModal.tsx
src/modules/production/actions/consumeItem.ts
src/modules/production/actions/createPrinted.ts
src/modules/production/actions/reportDefect.ts
src/modules/production/actions/updateItemStatus.ts
src/modules/production/actions/updateProcess.ts
src/modules/production/components/MovePartModal.tsx
src/modules/production/components/PreviewModal.tsx
src/modules/production/components/swimlane/SwimlaneCell.tsx
src/modules/production/components/swimlane/SwimlaneColumn.tsx
src/modules/production/components/swimlane/SwimlaneItem.tsx
src/modules/production/services/itemService.ts
src/modules/production/services/productionService.ts
src/modules/production/types/index.ts
src/modules/project/components/ProjectsList.tsx
src/shared/components/FileDownloadButton.tsx
src/shared/components/ModelViewer.tsx
src/shared/components/SummaryCard.tsx
src/shared/lib/firebase.ts
src/shared/types/index.ts
tailwind.config.js
tsconfig.json
tsconfig.node.json
types-diagram.md
types-diagram.mmd
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="diagram_full.mmd">
classDiagram


class Project {
            <<interface>>
            +id: number
+name: string
+description: string
+deadline: string
            
        }
class Unit {
            <<interface>>
            +id: string
+name: string
+project_id: number
+description?: string
            
        }
class Part {
            <<interface>>
            +id: number
+part_number: string
+project_id: number
+unit_id?: string
            
        }
class PartItem {
            <<interface>>
            +id: number
+part_id: number
+storage_case: string
+status: ProcessStatus
+completed_at: Date
+updated_at?: any
            
        }
class ProgressData {
            <<interface>>
            +part_number: string
+storage_cases: string[]
+counts: Record~ProcessStatus, number~
            
        }
class ParsedFileInfo {
            <<interface>>
            +originalFileName: string
+partNumber: string
+quantity: number
+isValid: boolean
+errorMessage?: string
+storageBoxes?: string[]
            
        }
class Project {
            <<interface>>
            +id: number
+name: string
+description: string
+deadline: string
            
        }
class Part {
            <<interface>>
            +id: number
+part_number: string
+project_id: number
+unit_id?: string
            
        }
class Unit {
            <<interface>>
            +id: string
+name: string
+project_id: number
+description?: string
            
        }
class ImportResult {
            <<interface>>
            +success: boolean
+fileName: string
+partNumber?: string
+partId?: number
+itemsCreated?: number
+error?: string
            
        }
class Part {
            <<interface>>
            +id: number
+part_number: string
+project_id: number
+unit_id?: string
            
        }
class ParsedFileInfo {
            <<interface>>
            +originalFileName: string
+partNumber: string
+quantity: number
+isValid: boolean
+errorMessage?: string
+storageBoxes?: string[]
            
        }
class PartItem {
            <<interface>>
            +id: number
+part_id: number
+storage_case: string
+status: ProcessStatus
+completed_at: Date
+updated_at?: any
            
        }
class ProgressData {
            <<interface>>
            +part_number: string
+storage_cases: string[]
+counts: Record~ProcessStatus, number~
            
        }
</file>

<file path="diagram.mmd">
classDiagram


class Project {
            <<interface>>
            +id: number
+name: string
+description: string
+deadline: string
            
        }
class Part {
            <<interface>>
            +id: number
+part_number: string
+project_id: number
+unit_id?: string
            
        }
class Unit {
            <<interface>>
            +id: string
+name: string
+project_id: number
+description?: string
            
        }
class ImportResult {
            <<interface>>
            +success: boolean
+fileName: string
+partNumber?: string
+partId?: number
+itemsCreated?: number
+error?: string
            
        }
class Part {
            <<interface>>
            +id: number
+part_number: string
+project_id: number
+unit_id?: string
            
        }
class ParsedFileInfo {
            <<interface>>
            +originalFileName: string
+partNumber: string
+quantity: number
+isValid: boolean
+errorMessage?: string
+storageBoxes?: string[]
            
        }
class PartItem {
            <<interface>>
            +id: number
+part_id: number
+storage_case: string
+status: ProcessStatus
+completed_at: Date
+updated_at?: any
            
        }
class ProgressData {
            <<interface>>
            +part_number: string
+storage_cases: string[]
+counts: Record~ProcessStatus, number~
            
        }
</file>

<file path="emulator_data/auth_export/accounts.json">
{"kind":"identitytoolkit#DownloadAccountResponse","users":[]}
</file>

<file path="emulator_data/auth_export/config.json">
{"signIn":{"allowDuplicateEmails":false},"emailPrivacyConfig":{"enableImprovedEmailPrivacy":false}}
</file>

<file path="emulator_data/firebase-export-metadata.json">
{
  "version": "15.5.1",
  "firestore": {
    "version": "1.20.2",
    "path": "firestore_export",
    "metadata_file": "firestore_export/firestore_export.overall_export_metadata"
  },
  "database": {
    "version": "4.11.2",
    "path": "database_export"
  },
  "auth": {
    "version": "15.5.1",
    "path": "auth_export"
  },
  "storage": {
    "version": "15.5.1",
    "path": "storage_export"
  }
}
</file>

<file path="emulator_data/storage_export/buckets.json">
{
  "buckets": [
    {
      "id": "demo-bom3d-sn923.appspot.com"
    }
  ]
}
</file>

<file path="firebase-data/storage_export/metadata/1592b06d-023b-4d51-a98b-9b3ec464ab92.json">
{
  "name": "projects/1/stl/ボディ187_1770448719111.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770448719129,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "0d5b873f-5566-41c8-9aed-2966cb89c568"
  ],
  "etag": "/8CRwCb9eSxkxd1bg1VpEt1L/RM",
  "customMetadata": {},
  "timeCreated": "2026-02-07T07:18:39.129Z",
  "updated": "2026-02-07T07:18:39.129Z",
  "size": 39684,
  "md5Hash": "jZtKIN6hQiBgTaoJmooYZg==",
  "crc32c": "166781100"
}
</file>

<file path="firebase-data/storage_export/metadata/62721c6e-4531-4e24-9503-c9354d564dda.json">
{
  "name": "projects/1/stl/ボディ179_1770529445795.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529445803,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "c8356d83-1b71-492e-ad9e-1e08a7059152"
  ],
  "etag": "G7O4LY1yNWn2fz3aAjD0WA4xnlE",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:05.803Z",
  "updated": "2026-02-08T05:44:05.803Z",
  "size": 35684,
  "md5Hash": "r+kYllHl14flvVDvPfPe6A==",
  "crc32c": "1892013277"
}
</file>

<file path="firebase-data/storage_export/metadata/6b16cb67-4e80-4417-a181-dbc10ab6386a.json">
{
  "name": "projects/1/stl/ボディ183_1770529444757.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529444789,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "b24bc10e-e721-4980-b3b5-d8bdca2345f0"
  ],
  "etag": "g12pRYleuMn2JZKWrge4QO4vElQ",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:04.789Z",
  "updated": "2026-02-08T05:44:04.789Z",
  "size": 29384,
  "md5Hash": "OEi71t0ezdb9aZB3RXtkcw==",
  "crc32c": "115996729"
}
</file>

<file path="firebase-data/storage_export/metadata/83c411db-774b-4e81-a3e4-26fad60acd23.json">
{
  "name": "projects/1/stl/ボディ180_1770529445567.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529445576,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "b9e90764-c8ed-4ed1-9e5b-aea9489bee1a"
  ],
  "etag": "LBOEOOSnr8Nd2AocdQ224yyApQ8",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:05.576Z",
  "updated": "2026-02-08T05:44:05.576Z",
  "size": 25284,
  "md5Hash": "bc0DrlnmuANN4871E26lxw==",
  "crc32c": "694601673"
}
</file>

<file path="firebase-data/storage_export/metadata/b257a210-a7a3-4c46-b1b3-f2d9dec88453.json">
{
  "name": "projects/1/stl/ボディ186_1770529445301.stl",
  "bucket": "demo-bom3d-sn923.appspot.com",
  "metageneration": 1,
  "generation": 1770529445312,
  "contentType": "application/octet-stream",
  "storageClass": "STANDARD",
  "contentDisposition": "inline",
  "downloadTokens": [
    "22f50b40-1c42-486a-a476-ad04f0ce8618"
  ],
  "etag": "ivhmcEfZc6mELCYhaybXm8I2Mo8",
  "customMetadata": {},
  "timeCreated": "2026-02-08T05:44:05.312Z",
  "updated": "2026-02-08T05:44:05.312Z",
  "size": 22884,
  "md5Hash": "o4PfDl24x7AjTrkMvz7cQQ==",
  "crc32c": "2880207178"
}
</file>

<file path="out.svg">
<svg version="1.1" baseProfile="full" width="1792.0" height="209.0" viewBox="0 0 1792 209" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events">
<desc >#.interface: fill=lightblue
#.enumeration: fill=lightgreen
#.type: fill=lightgray

[&lt;interface&gt;Project|+id: number;+name: string;+description: string;+deadline: string|]
[&lt;interface&gt;Unit|+id: string;+name: string;+project_id: number;+description?: string|]
[&lt;interface&gt;Part|+id: number;+part_number: string;+project_id: number;+unit_id?: string|]
[&lt;interface&gt;PartItem|+id: number;+part_id: number;+storage_case: string;+status: ProcessStatus;+completed_at: Date;+updated_at?: any|]
[&lt;interface&gt;ProgressData|+part_number: string;+storage_cases: string\[\];+counts: Record&lt;ProcessStatus, number&gt;|]
[&lt;interface&gt;ParsedFileInfo|+originalFileName: string;+partNumber: string;+quantity: number;+isValid: boolean;+errorMessage?: string;+storageBoxes?: string\[\]|]
[&lt;interface&gt;Project|+id: number;+name: string;+description: string;+deadline: string|]
[&lt;interface&gt;Part|+id: number;+part_number: string;+project_id: number;+unit_id?: string|]
[&lt;interface&gt;Unit|+id: string;+name: string;+project_id: number;+description?: string|]
[&lt;interface&gt;ImportResult|+success: boolean;+fileName: string;+partNumber?: string;+partId?: number;+itemsCreated?: number;+error?: string|]
[&lt;interface&gt;Part|+id: number;+part_number: string;+project_id: number;+unit_id?: string|]
[&lt;interface&gt;ParsedFileInfo|+originalFileName: string;+partNumber: string;+quantity: number;+isValid: boolean;+errorMessage?: string;+storageBoxes?: string\[\]|]
[&lt;interface&gt;PartItem|+id: number;+part_id: number;+storage_case: string;+status: ProcessStatus;+completed_at: Date;+updated_at?: any|]
[&lt;interface&gt;ProgressData|+part_number: string;+storage_cases: string\[\];+counts: Record&lt;ProcessStatus, number&gt;|]</desc>
<g stroke-width="1.0" text-align="left" font="12pt Helvetica, Arial, sans-serif" font-size="12pt" font-family="Helvetica" font-weight="normal" font-style="normal">
<g font-family="Helvetica" font-size="12pt" font-weight="bold" font-style="normal" stroke-width="3.0" stroke-linejoin="round" stroke-linecap="round" stroke="#33322E">
<g stroke="transparent" fill="transparent">
<rect x="0.0" y="0.0" height="209.0" width="1792.0" stroke="none"></rect>
</g>
<g transform="translate(8, 8)" fill="#33322E">
<g transform="translate(20, 20)">
<g data-name="Project">
<g fill="lightblue" stroke="#33322E" data-name="Project">
<rect x="0.0" y="16.0" height="121.0" width="167.0" data-name="Project"></rect>
<path d="M0.0 48.0 L167.0 48.0" fill="none" data-name="Project"></path>
<path d="M0.0 129.0 L167.0 129.0" fill="none" data-name="Project"></path>
</g>
<g transform="translate(0, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Project" data-compartment="0">
<a id="src\shared\types\index.ts.Project" xlink:href="src\shared\types\index.ts"><text x="75.5" y="14.1" stroke="none" text-anchor="middle" data-name="Project" data-compartment="0">Project</text></a>

</g>
</g>
<g transform="translate(0, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Project" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Project" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="Project" data-compartment="1">+name: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Project" data-compartment="1">+description: string</text>
<text x="0.0" y="62.7" stroke="none" data-name="Project" data-compartment="1">+deadline: string</text>

</g>
</g>
<g transform="translate(0, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Project" data-compartment="2">

</g>
</g>
</g>
<g data-name="Unit">
<g fill="lightblue" stroke="#33322E" data-name="Unit">
<rect x="207.0" y="16.0" height="121.0" width="177.0" data-name="Unit"></rect>
<path d="M207.0 48.0 L384.0 48.0" fill="none" data-name="Unit"></path>
<path d="M207.0 129.0 L384.0 129.0" fill="none" data-name="Unit"></path>
</g>
<g transform="translate(207, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Unit" data-compartment="0">
<a id="src\shared\types\index.ts.Unit" xlink:href="src\shared\types\index.ts"><text x="80.5" y="14.1" stroke="none" text-anchor="middle" data-name="Unit" data-compartment="0">Unit</text></a>

</g>
</g>
<g transform="translate(207, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Unit" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Unit" data-compartment="1">+id: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="Unit" data-compartment="1">+name: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Unit" data-compartment="1">+project_id: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="Unit" data-compartment="1">+description?: string</text>

</g>
</g>
<g transform="translate(207, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Unit" data-compartment="2">

</g>
</g>
</g>
<g data-name="Part">
<g fill="lightblue" stroke="#33322E" data-name="Part">
<rect x="424.0" y="16.0" height="121.0" width="181.0" data-name="Part"></rect>
<path d="M424.0 48.0 L605.0 48.0" fill="none" data-name="Part"></path>
<path d="M424.0 129.0 L605.0 129.0" fill="none" data-name="Part"></path>
</g>
<g transform="translate(424, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Part" data-compartment="0">
<a id="src\modules\inventory\types\index.ts.Part" xlink:href="src\modules\inventory\types\index.ts"><text x="82.5" y="14.1" stroke="none" text-anchor="middle" data-name="Part" data-compartment="0">Part</text></a>

</g>
</g>
<g transform="translate(424, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Part" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Part" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="Part" data-compartment="1">+part_number: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Part" data-compartment="1">+project_id: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="Part" data-compartment="1">+unit_id?: string</text>

</g>
</g>
<g transform="translate(424, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Part" data-compartment="2">

</g>
</g>
</g>
<g data-name="PartItem">
<g fill="lightblue" stroke="#33322E" data-name="PartItem">
<rect x="645.0" y="0.0" height="153.0" width="198.0" data-name="PartItem"></rect>
<path d="M645.0 32.0 L843.0 32.0" fill="none" data-name="PartItem"></path>
<path d="M645.0 145.0 L843.0 145.0" fill="none" data-name="PartItem"></path>
</g>
<g transform="translate(645, 0)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="PartItem" data-compartment="0">
<a id="src\modules\production\types\index.ts.PartItem" xlink:href="src\modules\production\types\index.ts"><text x="91.0" y="14.1" stroke="none" text-anchor="middle" data-name="PartItem" data-compartment="0">PartItem</text></a>

</g>
</g>
<g transform="translate(645, 32)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="PartItem" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="PartItem" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="PartItem" data-compartment="1">+part_id: number</text>
<text x="0.0" y="46.5" stroke="none" data-name="PartItem" data-compartment="1">+storage_case: string</text>
<text x="0.0" y="62.7" stroke="none" data-name="PartItem" data-compartment="1">+status: ProcessStatus</text>
<text x="0.0" y="78.9" stroke="none" data-name="PartItem" data-compartment="1">+completed_at: Date</text>
<text x="0.0" y="95.1" stroke="none" data-name="PartItem" data-compartment="1">+updated_at?: any</text>

</g>
</g>
<g transform="translate(645, 145)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="PartItem" data-compartment="2">

</g>
</g>
</g>
<g data-name="ProgressData">
<g fill="lightblue" stroke="#33322E" data-name="ProgressData">
<rect x="883.0" y="24.0" height="105.0" width="350.0" data-name="ProgressData"></rect>
<path d="M883.0 56.0 L1233.0 56.0" fill="none" data-name="ProgressData"></path>
<path d="M883.0 121.0 L1233.0 121.0" fill="none" data-name="ProgressData"></path>
</g>
<g transform="translate(883, 24)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="ProgressData" data-compartment="0">
<a id="src\modules\production\types\index.ts.ProgressData" xlink:href="src\modules\production\types\index.ts"><text x="167.0" y="14.1" stroke="none" text-anchor="middle" data-name="ProgressData" data-compartment="0">ProgressData</text></a>

</g>
</g>
<g transform="translate(883, 56)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="ProgressData" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="ProgressData" data-compartment="1">+part_number: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="ProgressData" data-compartment="1">+storage_cases: string[]</text>
<text x="0.0" y="46.5" stroke="none" data-name="ProgressData" data-compartment="1">+counts: Record&lt;ProcessStatus, number&gt;</text>

</g>
</g>
<g transform="translate(883, 121)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="ProgressData" data-compartment="2">

</g>
</g>
</g>
<g data-name="ParsedFileInfo">
<g fill="lightblue" stroke="#33322E" data-name="ParsedFileInfo">
<rect x="1273.0" y="0.0" height="153.0" width="212.0" data-name="ParsedFileInfo"></rect>
<path d="M1273.0 32.0 L1485.0 32.0" fill="none" data-name="ParsedFileInfo"></path>
<path d="M1273.0 145.0 L1485.0 145.0" fill="none" data-name="ParsedFileInfo"></path>
</g>
<g transform="translate(1273, 0)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="ParsedFileInfo" data-compartment="0">
<a id="src\modules\inventory\types\index.ts.ParsedFileInfo" xlink:href="src\modules\inventory\types\index.ts"><text x="98.0" y="14.1" stroke="none" text-anchor="middle" data-name="ParsedFileInfo" data-compartment="0">ParsedFileInfo</text></a>

</g>
</g>
<g transform="translate(1273, 32)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="ParsedFileInfo" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+originalFileName: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+partNumber: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+quantity: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+isValid: boolean</text>
<text x="0.0" y="78.9" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+errorMessage?: string</text>
<text x="0.0" y="95.1" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+storageBoxes?: string[]</text>

</g>
</g>
<g transform="translate(1273, 145)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="ParsedFileInfo" data-compartment="2">

</g>
</g>
</g>
<g data-name="ImportResult">
<g fill="lightblue" stroke="#33322E" data-name="ImportResult">
<rect x="1525.0" y="0.0" height="153.0" width="211.0" data-name="ImportResult"></rect>
<path d="M1525.0 32.0 L1736.0 32.0" fill="none" data-name="ImportResult"></path>
<path d="M1525.0 145.0 L1736.0 145.0" fill="none" data-name="ImportResult"></path>
</g>
<g transform="translate(1525, 0)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ImportResult" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="ImportResult" data-compartment="0">
<a id="src\modules\engineering\actions\importStl.ts.ImportResult" xlink:href="src\modules\engineering\actions\importStl.ts"><text x="97.5" y="14.1" stroke="none" text-anchor="middle" data-name="ImportResult" data-compartment="0">ImportResult</text></a>

</g>
</g>
<g transform="translate(1525, 32)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ImportResult" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="ImportResult" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="ImportResult" data-compartment="1">+success: boolean</text>
<text x="0.0" y="30.3" stroke="none" data-name="ImportResult" data-compartment="1">+fileName: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="ImportResult" data-compartment="1">+partNumber?: string</text>
<text x="0.0" y="62.7" stroke="none" data-name="ImportResult" data-compartment="1">+partId?: number</text>
<text x="0.0" y="78.9" stroke="none" data-name="ImportResult" data-compartment="1">+itemsCreated?: number</text>
<text x="0.0" y="95.1" stroke="none" data-name="ImportResult" data-compartment="1">+error?: string</text>

</g>
</g>
<g transform="translate(1525, 145)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ImportResult" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="ImportResult" data-compartment="2">

</g>
</g>
</g>
</g>
</g>
</g>
</g>
</svg>
</file>

<file path="scripts/seed-initial-data.ts">
import { db } from '../lib/firebase';
import {
    collection,
    doc,
    setDoc,
    getDocs,
    deleteDoc,
    getDoc,
    serverTimestamp
} from 'firebase/firestore';

/**
 * 初期データ投入（シーディング）スクリプト
 * 
 * 役割:
 * 1. projects コレクションへの初期プロジェクト投入
 * 2. boxes コレクションへの初期ボックス投入 (BOX-001 ～ BOX-050)
 * 
 * 実行方法:
 * npx tsx scripts/seed-initial-data.ts
 * 
 * オプション:
 * --clear  既存のデータを一旦削除してから投入します。
 */

// エミュレーター接続を確実にするための設定
(process.env as any).NEXT_PUBLIC_FIREBASE_PROJECT_ID = "demo-bom3d-sn923";
(process.env as any).NODE_ENV = 'development';

async function clearCollection(name: string) {
    console.log(`[Clear] Cleaning collection: ${name}...`);
    const q = collection(db, name);
    const snapshot = await getDocs(q);
    const deletePromises = snapshot.docs.map(d => deleteDoc(d.ref));
    await Promise.all(deletePromises);
    console.log(`[Clear] ${snapshot.size} documents deleted from ${name}.`);
}

async function seed() {
    const args = process.argv.slice(2);
    const shouldClear = args.includes('--clear');

    console.log('--- Database Seeding Start ---');

    if (shouldClear) {
        await clearCollection('projects');
        await clearCollection('boxes');
    }

    // 1. projects
    console.log('Seeding projects...');
    const projectId = "proto-2024";
    const projectRef = doc(db, 'projects', projectId);
    const projectData = {
        name: "プロトタイプ開発2024",
        deadline: "2024-12-31",
        description: "Firebase移行後の初期データ",
        created_at: serverTimestamp(),
        updated_at: serverTimestamp()
    };

    const projectSnap = await getDoc(projectRef);
    if (!projectSnap.exists() || shouldClear) {
        await setDoc(projectRef, projectData);
        console.log(`✔️  Project "${projectData.name}" created (ID: ${projectId}).`);
    } else {
        console.log(`ℹ️  Project "${projectId}" already exists. Skipping.`);
    }

    // 2. boxes (新規追加)
    console.log('Seeding boxes (BOX-001 to BOX-050)...');
    let createdCount = 0;
    let skippedCount = 0;

    for (let i = 1; i <= 50; i++) {
        const boxId = `BOX-${String(i).padStart(3, '0')}`;
        const boxRef = doc(db, 'boxes', boxId);

        const boxData = {
            id: boxId,
            status: "AVAILABLE",
            updated_at: serverTimestamp()
        };

        if (!shouldClear) {
            const boxSnap = await getDoc(boxRef);
            if (boxSnap.exists()) {
                skippedCount++;
                continue;
            }
        }

        await setDoc(boxRef, boxData);
        createdCount++;
    }

    console.log(`✔️  Boxes: ${createdCount} created, ${skippedCount} skipped.`);
    console.log('--- Seeding Completed! ---');
    process.exit(0);
}

seed().catch((error) => {
    console.error('❌  Seeding failed:', error);
    process.exit(1);
});
</file>

<file path="src/modules/engineering/actions/projectActions.ts">
'use server'

/**
 * Engineering Module - Project Actions
 * プロジェクトの作成と管理
 */

import { db } from '@/src/shared/lib/firebase';
import { collection, addDoc, serverTimestamp } from 'firebase/firestore';
import { revalidatePath } from 'next/cache';

/**
 * 新規プロジェクトを作成するサーバーアクション
 * 
 * @param name - プロジェクト名
 * @param description - 説明
 * @param deadline - 納期
 * @returns 作成されたプロジェクトのID
 */
export async function createProject(
    name: string,
    description: string,
    deadline: string
) {
    try {
        const docRef = await addDoc(collection(db, 'projects'), {
            name,
            description,
            deadline,
            created_at: serverTimestamp(),
            updated_at: serverTimestamp()
        });

        console.log(`[ProjectActions] Created new project with ID: ${docRef.id}`);

        // ダッシュボードを更新
        revalidatePath('/');

        return { success: true, id: docRef.id };
    } catch (error) {
        console.error('Failed to create project:', error);
        return { success: false, error: 'プロジェクトの作成に失敗しました' };
    }
}
</file>

<file path="src/modules/project/components/ProjectsList.tsx">
'use client';

/**
 * Project Module - Projects List Component
 * プロジェクト一覧をリアルタイムで表示する
 */

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { db } from '@/src/shared/lib/firebase';
import { collection, query, orderBy, onSnapshot } from 'firebase/firestore';
import { Project } from '@/src/shared/types';

export function ProjectsList() {
    const [projects, setProjects] = useState<Project[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const q = query(collection(db, 'projects'), orderBy('name', 'asc'));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const projectsData = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            })) as Project[];
            setProjects(projectsData);
            setLoading(false);
        }, (error) => {
            console.error("Error fetching projects: ", error);
            setLoading(false);
        });

        return () => unsubscribe();
    }, []);

    if (loading) {
        return (
            <div className="flex justify-center py-12">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        );
    }

    if (projects.length === 0) {
        return (
            <div className="text-center py-12 bg-white rounded-2xl border border-dashed border-gray-300">
                <p className="text-gray-500">プロジェクトがありません。新しいプロジェクトを作成してください。</p>
            </div>
        );
    }

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            {projects.map((project) => (
                <Link key={project.id} href={`/project/${project.id}`}>
                    <div className="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 overflow-hidden cursor-pointer flex flex-col h-full transform hover:-translate-y-1">
                        <div className="p-8 flex-grow">
                            <div className="flex justify-between items-start mb-6">
                                <h2 className="text-2xl font-bold text-gray-800 group-hover:text-blue-600 transition-colors">
                                    {project.name}
                                </h2>
                                <span className="bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider">
                                    進行中
                                </span>
                            </div>
                            <p className="text-gray-600 mb-8 leading-relaxed">
                                {project.description}
                            </p>

                            {/* 簡易進捗表示（ダミー） */}
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                    <span className="font-medium text-gray-700">全体進捗</span>
                                    <span className="font-bold text-blue-600">65%</span>
                                </div>
                                <div className="w-full bg-gray-100 rounded-full h-3">
                                    <div className="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full w-[65%] shadow-sm"></div>
                                </div>
                            </div>
                        </div>

                        <div className="px-8 py-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center group-hover:bg-blue-50 transition-colors">
                            <div className="text-sm">
                                <span className="text-gray-500">納期: </span>
                                <span className="font-semibold text-gray-800">{project.deadline}</span>
                            </div>
                            <span className="text-blue-600 font-bold flex items-center group-hover:translate-x-1 transition-transform">
                                詳細を見る
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                            </span>
                        </div>
                    </div>
                </Link>
            ))}
        </div>
    );
}
</file>

<file path="types-diagram.md">
<svg version="1.1" baseProfile="full" width="1541.0" height="209.0" viewBox="0 0 1541 209" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events">
<desc >#.interface: fill=lightblue
#.enumeration: fill=lightgreen
#.type: fill=lightgray

[&lt;interface&gt;Project|+id: number;+name: string;+description: string;+deadline: string|]
[&lt;interface&gt;Part|+id: number;+part_number: string;+project_id: number;+unit_id?: string|]
[&lt;interface&gt;Unit|+id: string;+name: string;+project_id: number;+description?: string|]
[&lt;interface&gt;Part|+id: number;+part_number: string;+project_id: number;+unit_id?: string|]
[&lt;interface&gt;ParsedFileInfo|+originalFileName: string;+partNumber: string;+quantity: number;+isValid: boolean;+errorMessage?: string;+storageBoxes?: string\[\]|]
[&lt;interface&gt;PartItem|+id: number;+part_id: number;+storage_case: string;+status: ProcessStatus;+completed_at: Date;+updated_at?: any|]
[&lt;interface&gt;ProgressData|+part_number: string;+storage_cases: string\[\];+counts: Record&lt;ProcessStatus, number&gt;|]</desc>
<g stroke-width="1.0" text-align="left" font="12pt Helvetica, Arial, sans-serif" font-size="12pt" font-family="Helvetica" font-weight="normal" font-style="normal">
<g font-family="Helvetica" font-size="12pt" font-weight="bold" font-style="normal" stroke-width="3.0" stroke-linejoin="round" stroke-linecap="round" stroke="#33322E">
<g stroke="transparent" fill="transparent">
<rect x="0.0" y="0.0" height="209.0" width="1541.0" stroke="none"></rect>
</g>
<g transform="translate(8, 8)" fill="#33322E">
<g transform="translate(20, 20)">
<g data-name="Project">
<g fill="lightblue" stroke="#33322E" data-name="Project">
<rect x="0.0" y="16.0" height="121.0" width="167.0" data-name="Project"></rect>
<path d="M0.0 48.0 L167.0 48.0" fill="none" data-name="Project"></path>
<path d="M0.0 129.0 L167.0 129.0" fill="none" data-name="Project"></path>
</g>
<g transform="translate(0, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Project" data-compartment="0">
<a id="src\shared\types\index.ts.Project" xlink:href="src\shared\types\index.ts"><text x="75.5" y="14.1" stroke="none" text-anchor="middle" data-name="Project" data-compartment="0">Project</text></a>

</g>
</g>
<g transform="translate(0, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Project" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Project" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="Project" data-compartment="1">+name: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Project" data-compartment="1">+description: string</text>
<text x="0.0" y="62.7" stroke="none" data-name="Project" data-compartment="1">+deadline: string</text>

</g>
</g>
<g transform="translate(0, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Project" data-compartment="2">

</g>
</g>
</g>
<g data-name="Part">
<g fill="lightblue" stroke="#33322E" data-name="Part">
<rect x="207.0" y="16.0" height="121.0" width="181.0" data-name="Part"></rect>
<path d="M207.0 48.0 L388.0 48.0" fill="none" data-name="Part"></path>
<path d="M207.0 129.0 L388.0 129.0" fill="none" data-name="Part"></path>
</g>
<g transform="translate(207, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Part" data-compartment="0">
<a id="src\modules\inventory\types\index.ts.Part" xlink:href="src\modules\inventory\types\index.ts"><text x="82.5" y="14.1" stroke="none" text-anchor="middle" data-name="Part" data-compartment="0">Part</text></a>

</g>
</g>
<g transform="translate(207, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Part" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Part" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="Part" data-compartment="1">+part_number: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Part" data-compartment="1">+project_id: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="Part" data-compartment="1">+unit_id?: string</text>

</g>
</g>
<g transform="translate(207, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Part" data-compartment="2">

</g>
</g>
</g>
<g data-name="Unit">
<g fill="lightblue" stroke="#33322E" data-name="Unit">
<rect x="428.0" y="16.0" height="121.0" width="177.0" data-name="Unit"></rect>
<path d="M428.0 48.0 L605.0 48.0" fill="none" data-name="Unit"></path>
<path d="M428.0 129.0 L605.0 129.0" fill="none" data-name="Unit"></path>
</g>
<g transform="translate(428, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Unit" data-compartment="0">
<a id="src\shared\types\index.ts.Unit" xlink:href="src\shared\types\index.ts"><text x="80.5" y="14.1" stroke="none" text-anchor="middle" data-name="Unit" data-compartment="0">Unit</text></a>

</g>
</g>
<g transform="translate(428, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Unit" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Unit" data-compartment="1">+id: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="Unit" data-compartment="1">+name: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Unit" data-compartment="1">+project_id: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="Unit" data-compartment="1">+description?: string</text>

</g>
</g>
<g transform="translate(428, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Unit" data-compartment="2">

</g>
</g>
</g>
<g data-name="ParsedFileInfo">
<g fill="lightblue" stroke="#33322E" data-name="ParsedFileInfo">
<rect x="645.0" y="0.0" height="153.0" width="212.0" data-name="ParsedFileInfo"></rect>
<path d="M645.0 32.0 L857.0 32.0" fill="none" data-name="ParsedFileInfo"></path>
<path d="M645.0 145.0 L857.0 145.0" fill="none" data-name="ParsedFileInfo"></path>
</g>
<g transform="translate(645, 0)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="ParsedFileInfo" data-compartment="0">
<a id="src\modules\inventory\types\index.ts.ParsedFileInfo" xlink:href="src\modules\inventory\types\index.ts"><text x="98.0" y="14.1" stroke="none" text-anchor="middle" data-name="ParsedFileInfo" data-compartment="0">ParsedFileInfo</text></a>

</g>
</g>
<g transform="translate(645, 32)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="ParsedFileInfo" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+originalFileName: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+partNumber: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+quantity: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+isValid: boolean</text>
<text x="0.0" y="78.9" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+errorMessage?: string</text>
<text x="0.0" y="95.1" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+storageBoxes?: string[]</text>

</g>
</g>
<g transform="translate(645, 145)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="ParsedFileInfo" data-compartment="2">

</g>
</g>
</g>
<g data-name="PartItem">
<g fill="lightblue" stroke="#33322E" data-name="PartItem">
<rect x="897.0" y="0.0" height="153.0" width="198.0" data-name="PartItem"></rect>
<path d="M897.0 32.0 L1095.0 32.0" fill="none" data-name="PartItem"></path>
<path d="M897.0 145.0 L1095.0 145.0" fill="none" data-name="PartItem"></path>
</g>
<g transform="translate(897, 0)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="PartItem" data-compartment="0">
<a id="src\modules\production\types\index.ts.PartItem" xlink:href="src\modules\production\types\index.ts"><text x="91.0" y="14.1" stroke="none" text-anchor="middle" data-name="PartItem" data-compartment="0">PartItem</text></a>

</g>
</g>
<g transform="translate(897, 32)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="PartItem" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="PartItem" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="PartItem" data-compartment="1">+part_id: number</text>
<text x="0.0" y="46.5" stroke="none" data-name="PartItem" data-compartment="1">+storage_case: string</text>
<text x="0.0" y="62.7" stroke="none" data-name="PartItem" data-compartment="1">+status: ProcessStatus</text>
<text x="0.0" y="78.9" stroke="none" data-name="PartItem" data-compartment="1">+completed_at: Date</text>
<text x="0.0" y="95.1" stroke="none" data-name="PartItem" data-compartment="1">+updated_at?: any</text>

</g>
</g>
<g transform="translate(897, 145)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="PartItem" data-compartment="2">

</g>
</g>
</g>
<g data-name="ProgressData">
<g fill="lightblue" stroke="#33322E" data-name="ProgressData">
<rect x="1135.0" y="24.0" height="105.0" width="350.0" data-name="ProgressData"></rect>
<path d="M1135.0 56.0 L1485.0 56.0" fill="none" data-name="ProgressData"></path>
<path d="M1135.0 121.0 L1485.0 121.0" fill="none" data-name="ProgressData"></path>
</g>
<g transform="translate(1135, 24)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="ProgressData" data-compartment="0">
<a id="src\modules\production\types\index.ts.ProgressData" xlink:href="src\modules\production\types\index.ts"><text x="167.0" y="14.1" stroke="none" text-anchor="middle" data-name="ProgressData" data-compartment="0">ProgressData</text></a>

</g>
</g>
<g transform="translate(1135, 56)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="ProgressData" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="ProgressData" data-compartment="1">+part_number: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="ProgressData" data-compartment="1">+storage_cases: string[]</text>
<text x="0.0" y="46.5" stroke="none" data-name="ProgressData" data-compartment="1">+counts: Record&lt;ProcessStatus, number&gt;</text>

</g>
</g>
<g transform="translate(1135, 121)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="ProgressData" data-compartment="2">

</g>
</g>
</g>
</g>
</g>
</g>
</g>
</svg>
</file>

<file path="types-diagram.mmd">
<svg version="1.1" baseProfile="full" width="1541.0" height="209.0" viewBox="0 0 1541 209" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:ev="http://www.w3.org/2001/xml-events">
<desc >#.interface: fill=lightblue
#.enumeration: fill=lightgreen
#.type: fill=lightgray

[&lt;interface&gt;Project|+id: number;+name: string;+description: string;+deadline: string|]
[&lt;interface&gt;Part|+id: number;+part_number: string;+project_id: number;+unit_id?: string|]
[&lt;interface&gt;Unit|+id: string;+name: string;+project_id: number;+description?: string|]
[&lt;interface&gt;Part|+id: number;+part_number: string;+project_id: number;+unit_id?: string|]
[&lt;interface&gt;ParsedFileInfo|+originalFileName: string;+partNumber: string;+quantity: number;+isValid: boolean;+errorMessage?: string;+storageBoxes?: string\[\]|]
[&lt;interface&gt;PartItem|+id: number;+part_id: number;+storage_case: string;+status: ProcessStatus;+completed_at: Date;+updated_at?: any|]
[&lt;interface&gt;ProgressData|+part_number: string;+storage_cases: string\[\];+counts: Record&lt;ProcessStatus, number&gt;|]</desc>
<g stroke-width="1.0" text-align="left" font="12pt Helvetica, Arial, sans-serif" font-size="12pt" font-family="Helvetica" font-weight="normal" font-style="normal">
<g font-family="Helvetica" font-size="12pt" font-weight="bold" font-style="normal" stroke-width="3.0" stroke-linejoin="round" stroke-linecap="round" stroke="#33322E">
<g stroke="transparent" fill="transparent">
<rect x="0.0" y="0.0" height="209.0" width="1541.0" stroke="none"></rect>
</g>
<g transform="translate(8, 8)" fill="#33322E">
<g transform="translate(20, 20)">
<g data-name="Project">
<g fill="lightblue" stroke="#33322E" data-name="Project">
<rect x="0.0" y="16.0" height="121.0" width="167.0" data-name="Project"></rect>
<path d="M0.0 48.0 L167.0 48.0" fill="none" data-name="Project"></path>
<path d="M0.0 129.0 L167.0 129.0" fill="none" data-name="Project"></path>
</g>
<g transform="translate(0, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Project" data-compartment="0">
<a id="src\shared\types\index.ts.Project" xlink:href="src\shared\types\index.ts"><text x="75.5" y="14.1" stroke="none" text-anchor="middle" data-name="Project" data-compartment="0">Project</text></a>

</g>
</g>
<g transform="translate(0, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Project" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Project" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="Project" data-compartment="1">+name: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Project" data-compartment="1">+description: string</text>
<text x="0.0" y="62.7" stroke="none" data-name="Project" data-compartment="1">+deadline: string</text>

</g>
</g>
<g transform="translate(0, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Project" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Project" data-compartment="2">

</g>
</g>
</g>
<g data-name="Part">
<g fill="lightblue" stroke="#33322E" data-name="Part">
<rect x="207.0" y="16.0" height="121.0" width="181.0" data-name="Part"></rect>
<path d="M207.0 48.0 L388.0 48.0" fill="none" data-name="Part"></path>
<path d="M207.0 129.0 L388.0 129.0" fill="none" data-name="Part"></path>
</g>
<g transform="translate(207, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Part" data-compartment="0">
<a id="src\modules\inventory\types\index.ts.Part" xlink:href="src\modules\inventory\types\index.ts"><text x="82.5" y="14.1" stroke="none" text-anchor="middle" data-name="Part" data-compartment="0">Part</text></a>

</g>
</g>
<g transform="translate(207, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Part" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Part" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="Part" data-compartment="1">+part_number: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Part" data-compartment="1">+project_id: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="Part" data-compartment="1">+unit_id?: string</text>

</g>
</g>
<g transform="translate(207, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Part" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Part" data-compartment="2">

</g>
</g>
</g>
<g data-name="Unit">
<g fill="lightblue" stroke="#33322E" data-name="Unit">
<rect x="428.0" y="16.0" height="121.0" width="177.0" data-name="Unit"></rect>
<path d="M428.0 48.0 L605.0 48.0" fill="none" data-name="Unit"></path>
<path d="M428.0 129.0 L605.0 129.0" fill="none" data-name="Unit"></path>
</g>
<g transform="translate(428, 16)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="Unit" data-compartment="0">
<a id="src\shared\types\index.ts.Unit" xlink:href="src\shared\types\index.ts"><text x="80.5" y="14.1" stroke="none" text-anchor="middle" data-name="Unit" data-compartment="0">Unit</text></a>

</g>
</g>
<g transform="translate(428, 48)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="Unit" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="Unit" data-compartment="1">+id: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="Unit" data-compartment="1">+name: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="Unit" data-compartment="1">+project_id: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="Unit" data-compartment="1">+description?: string</text>

</g>
</g>
<g transform="translate(428, 129)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="Unit" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="Unit" data-compartment="2">

</g>
</g>
</g>
<g data-name="ParsedFileInfo">
<g fill="lightblue" stroke="#33322E" data-name="ParsedFileInfo">
<rect x="645.0" y="0.0" height="153.0" width="212.0" data-name="ParsedFileInfo"></rect>
<path d="M645.0 32.0 L857.0 32.0" fill="none" data-name="ParsedFileInfo"></path>
<path d="M645.0 145.0 L857.0 145.0" fill="none" data-name="ParsedFileInfo"></path>
</g>
<g transform="translate(645, 0)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="ParsedFileInfo" data-compartment="0">
<a id="src\modules\inventory\types\index.ts.ParsedFileInfo" xlink:href="src\modules\inventory\types\index.ts"><text x="98.0" y="14.1" stroke="none" text-anchor="middle" data-name="ParsedFileInfo" data-compartment="0">ParsedFileInfo</text></a>

</g>
</g>
<g transform="translate(645, 32)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="ParsedFileInfo" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+originalFileName: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+partNumber: string</text>
<text x="0.0" y="46.5" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+quantity: number</text>
<text x="0.0" y="62.7" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+isValid: boolean</text>
<text x="0.0" y="78.9" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+errorMessage?: string</text>
<text x="0.0" y="95.1" stroke="none" data-name="ParsedFileInfo" data-compartment="1">+storageBoxes?: string[]</text>

</g>
</g>
<g transform="translate(645, 145)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ParsedFileInfo" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="ParsedFileInfo" data-compartment="2">

</g>
</g>
</g>
<g data-name="PartItem">
<g fill="lightblue" stroke="#33322E" data-name="PartItem">
<rect x="897.0" y="0.0" height="153.0" width="198.0" data-name="PartItem"></rect>
<path d="M897.0 32.0 L1095.0 32.0" fill="none" data-name="PartItem"></path>
<path d="M897.0 145.0 L1095.0 145.0" fill="none" data-name="PartItem"></path>
</g>
<g transform="translate(897, 0)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="PartItem" data-compartment="0">
<a id="src\modules\production\types\index.ts.PartItem" xlink:href="src\modules\production\types\index.ts"><text x="91.0" y="14.1" stroke="none" text-anchor="middle" data-name="PartItem" data-compartment="0">PartItem</text></a>

</g>
</g>
<g transform="translate(897, 32)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="PartItem" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="PartItem" data-compartment="1">+id: number</text>
<text x="0.0" y="30.3" stroke="none" data-name="PartItem" data-compartment="1">+part_id: number</text>
<text x="0.0" y="46.5" stroke="none" data-name="PartItem" data-compartment="1">+storage_case: string</text>
<text x="0.0" y="62.7" stroke="none" data-name="PartItem" data-compartment="1">+status: ProcessStatus</text>
<text x="0.0" y="78.9" stroke="none" data-name="PartItem" data-compartment="1">+completed_at: Date</text>
<text x="0.0" y="95.1" stroke="none" data-name="PartItem" data-compartment="1">+updated_at?: any</text>

</g>
</g>
<g transform="translate(897, 145)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="PartItem" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="PartItem" data-compartment="2">

</g>
</g>
</g>
<g data-name="ProgressData">
<g fill="lightblue" stroke="#33322E" data-name="ProgressData">
<rect x="1135.0" y="24.0" height="105.0" width="350.0" data-name="ProgressData"></rect>
<path d="M1135.0 56.0 L1485.0 56.0" fill="none" data-name="ProgressData"></path>
<path d="M1135.0 121.0 L1485.0 121.0" fill="none" data-name="ProgressData"></path>
</g>
<g transform="translate(1135, 24)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="0">
<g transform="translate(8, 8)" fill="#33322E" text-align="center" data-name="ProgressData" data-compartment="0">
<a id="src\modules\production\types\index.ts.ProgressData" xlink:href="src\modules\production\types\index.ts"><text x="167.0" y="14.1" stroke="none" text-anchor="middle" data-name="ProgressData" data-compartment="0">ProgressData</text></a>

</g>
</g>
<g transform="translate(1135, 56)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="1">
<g transform="translate(8, 8)" fill="#33322E" text-align="left" data-name="ProgressData" data-compartment="1">
<text x="0.0" y="14.1" stroke="none" data-name="ProgressData" data-compartment="1">+part_number: string</text>
<text x="0.0" y="30.3" stroke="none" data-name="ProgressData" data-compartment="1">+storage_cases: string[]</text>
<text x="0.0" y="46.5" stroke="none" data-name="ProgressData" data-compartment="1">+counts: Record&lt;ProcessStatus, number&gt;</text>

</g>
</g>
<g transform="translate(1135, 121)" font-family="Helvetica" font-size="12pt" font-weight="normal" font-style="normal" data-name="ProgressData" data-compartment="2">
<g transform="translate(8, 8)" fill="#33322E" data-name="ProgressData" data-compartment="2">

</g>
</g>
</g>
</g>
</g>
</g>
</g>
</svg>
</file>

<file path=".continue/agents/new-config.yaml">
# This is an example configuration file
# To learn more, see the full config.yaml reference: https://docs.continue.dev/reference

name: Example Config
version: 1.0.0
schema: v1

# Define which models can be used
# https://docs.continue.dev/customization/models
models:
  - name: my gpt-5
    provider: openai
    model: gpt-5
    apiKey: YOUR_OPENAI_API_KEY_HERE
  - uses: ollama/qwen2.5-coder-7b
  - uses: anthropic/claude-4-sonnet
    with:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

# MCP Servers that Continue can access
# https://docs.continue.dev/customization/mcp-tools
mcpServers:
  - uses: anthropic/memory-mcp
</file>

<file path=".env,local">
# Firebase Project ID (Emulator用に 'demo-' を付ける)
NEXT_PUBLIC_FIREBASE_PROJECT_ID=demo-bom3d-sn923

# 各種エミュレータのポート番号（デフォルト）
NEXT_PUBLIC_FIREBASE_FIRESTORE_EMULATOR_HOST=localhost:8080
NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST=http://localhost:9099
</file>

<file path=".gitignore">
# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local
.env

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
Thumbs.db
</file>

<file path="docs/INTEGRATION_EXAMPLE.md">
# プロジェクトページへのSTLインポート機能統合例

## 統合方法

`app/project/[id]/page.tsx` を以下のように修正して、STLインポートボタンを追加します。

```tsx
import Link from 'next/link';
import { notFound } from 'next/navigation';
import { aggregateProgress } from '@/app/utils';
import { SummaryCard } from '@/app/components/SummaryCard';
import { mockStore } from '@/lib/mockStore';
import ProjectClientContent from './ProjectClientContent';
// ↓ 追加
import ProjectPageClient from './ProjectPageClient';

interface PageProps {
    params: Promise<{
        id: string;
    }>;
}

export default async function ProjectDetailPage(props: PageProps) {
    const params = await props.params;
    const projectId = parseInt(params.id);
    if (isNaN(projectId)) {
        notFound();
    }

    const project = await mockStore.getProject(projectId);
    if (!project) {
        notFound();
    }

    const parts = await mockStore.getParts(projectId);
    const partItems = await mockStore.getPartItems(projectId);

    const totalInventory = partItems.length;
    const inProgress = partItems.filter(item => item.status !== 'READY').length;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const completedToday = partItems.filter(item =>
        item.completed_at && new Date(item.completed_at) >= today
    ).length;

    const progressData = aggregateProgress(parts, partItems);

    return (
        <ProjectPageClient
            project={project}
            projectId={projectId}
            totalInventory={totalInventory}
            inProgress={inProgress}
            completedToday={completedToday}
            progressData={progressData}
            parts={parts}
            partItems={partItems}
        />
    );
}
```

## 新しいクライアントコンポーネントの作成

`app/project/[id]/ProjectPageClient.tsx` を作成:

```tsx
'use client';

import Link from 'next/link';
import { useState } from 'react';
import { SummaryCard } from '@/app/components/SummaryCard';
import { StlImportModal } from '@/app/components/StlImportModal';
import ProjectClientContent from './ProjectClientContent';
import { Part, PartItem, Project } from '@/app/types';

interface ProjectPageClientProps {
    project: Project;
    projectId: number;
    totalInventory: number;
    inProgress: number;
    completedToday: number;
    progressData: any[];
    parts: Part[];
    partItems: PartItem[];
}

export default function ProjectPageClient({
    project,
    projectId,
    totalInventory,
    inProgress,
    completedToday,
    progressData,
    parts,
    partItems
}: ProjectPageClientProps) {
    const [isImportModalOpen, setIsImportModalOpen] = useState(false);

    const handleImportComplete = () => {
        // インポート完了後にページをリロード
        window.location.reload();
    };

    return (
        <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <div>
                    <Link href="/" className="text-blue-600 hover:text-blue-800 mb-2 inline-block font-medium">
                        ← プロジェクト一覧へ戻る
                    </Link>
                    <h1 className="text-3xl font-bold text-gray-800">
                        {project.name}
                    </h1>
                    <p className="text-gray-600 mt-1">{project.description}</p>
                </div>
                <div className="flex gap-3">
                    {/* STLインポートボタン（新規追加） */}
                    <button
                        onClick={() => setIsImportModalOpen(true)}
                        className="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all"
                    >
                        📁 STLインポート
                    </button>
                    
                    <Link href={`/print?project_id=${projectId}`}>
                        <span className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all cursor-pointer inline-block">
                            3Dプリント登録
                        </span>
                    </Link>
                </div>
            </header>

            {/* サマリーカード */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <SummaryCard title="総在庫数" value={totalInventory} />
                <SummaryCard title="仕掛品数" value={inProgress} valueColor="text-orange-500" />
                <SummaryCard title="本日完了数" value={completedToday} valueColor="text-green-500" />
            </div>

            {/* インタラクティブな一覧・カート機能 */}
            <ProjectClientContent
                progressData={progressData}
                parts={parts}
                partItems={partItems}
                projectId={projectId}
            />

            {/* STLインポートモーダル */}
            <StlImportModal
                isOpen={isImportModalOpen}
                onClose={() => setIsImportModalOpen(false)}
                projectId={projectId}
                onImportComplete={handleImportComplete}
            />
        </div>
    );
}
```

## 変更点の説明

### 1. サーバーコンポーネントとクライアントコンポーネントの分離
- `page.tsx`: サーバーコンポーネント（データ取得のみ）
- `ProjectPageClient.tsx`: クライアントコンポーネント（UI + インタラクション）

### 2. STLインポートボタンの追加
- ヘッダー部分に緑色の「STLインポート」ボタンを追加
- クリックするとモーダルが開く

### 3. モーダルの統合
- `StlImportModal` コンポーネントをインポート
- `isImportModalOpen` ステートで表示/非表示を管理
- インポート完了後は `window.location.reload()` でページをリフレッシュ

## 使用フロー

1. ユーザーがプロジェクトページを開く
2. 「STLインポート」ボタンをクリック
3. モーダルが開き、ファイルをドラッグ&ドロップまたは選択
4. ファイル名が自動解析され、プレビュー表示
5. 初期ステータスを選択（デフォルト: CUTTING）
6. 「インポート実行」ボタンをクリック
7. Firebase Storage にアップロード + Firestore に保存
8. 完了後、ページが自動リロードされ、新しい部品が表示される

## より良い実装（オプション）

ページリロードの代わりに、SWRやReact Queryを使ってデータを再取得する方法もあります:

```tsx
import { useRouter } from 'next/navigation';

const router = useRouter();

const handleImportComplete = () => {
    // Next.jsのキャッシュを無効化してリフレッシュ
    router.refresh();
};
```

この方法なら、ページ全体をリロードせずにデータのみを再取得できます。
</file>

<file path="docs/STL_IMPORT_GUIDE.md">
# STLインポート機能 使用ガイド

## 概要

STLファイルのインポート機能により、ファイル名から部品番号と個数を自動解析し、Firebase Storageへのアップロードと同時にFirestoreに部品（Part）と工程アイテム（PartItem）を自動生成します。

## 実装されたファイル

### 1. ユーティリティ
- **`lib/utils/parseFileName.ts`**: ファイル名解析エンジン

### 2. サーバーアクション
- **`app/actions/importStl.ts`**: インポート処理のサーバーアクション

### 3. UIコンポーネント
- **`app/components/StlImportModal.tsx`**: ドラッグ&ドロップ対応のインポートモーダル

### 4. APIルート
- **`app/api/preview-filenames/route.ts`**: ファイル名プレビュー用API
- **`app/api/import-stl/route.ts`**: インポート実行用API

## ファイル名フォーマット

以下のフォーマットに対応しています:

| ファイル名 | 部品番号 | 個数 |
|-----------|---------|------|
| `PART123.stl` | PART123 | 1 |
| `PART123_x5.stl` | PART123 | 5 |
| `ABC-456_X10.stl` | ABC-456 | 10 |
| `ITEM_789_x3.stl` | ITEM_789 | 3 |

### ルール
- 拡張子は `.stl` または `.STL`
- 個数指定は `_x数字` または `_X数字` の形式
- 個数指定がない場合はデフォルトで1個
- 個数の範囲は 1〜1000

## 使用方法

### プロジェクトページに組み込む例

```tsx
'use client';

import { useState } from 'react';
import { StlImportModal } from '@/app/components/StlImportModal';

export default function ProjectPage({ projectId }: { projectId: number }) {
  const [isImportModalOpen, setIsImportModalOpen] = useState(false);

  const handleImportComplete = () => {
    // インポート完了後の処理（例: データ再取得）
    window.location.reload();
  };

  return (
    <div>
      {/* インポートボタン */}
      <button
        onClick={() => setIsImportModalOpen(true)}
        className="bg-green-600 text-white font-bold py-3 px-6 rounded-lg"
      >
        STLファイルをインポート
      </button>

      {/* インポートモーダル */}
      <StlImportModal
        isOpen={isImportModalOpen}
        onClose={() => setIsImportModalOpen(false)}
        projectId={projectId}
        onImportComplete={handleImportComplete}
      />
    </div>
  );
}
```

## 処理フロー

1. **ファイル選択/ドロップ**
   - ユーザーがSTLファイルを選択またはドラッグ&ドロップ
   - 複数ファイルの同時選択が可能

2. **プレビュー解析**
   - `/api/preview-filenames` を呼び出し
   - ファイル名から部品番号と個数を抽出
   - 解析結果をテーブル表示（有効/無効を色分け）

3. **初期ステータス選択**
   - ユーザーが初期ステータスを選択（デフォルト: CUTTING）
   - 選択肢: UNPRINTED, PRINTED, SURFACE_TREATMENT, CUTTING, PAINTING, READY

4. **インポート実行**
   - 「インポート実行」ボタンをクリック
   - `/api/import-stl` を呼び出し
   - 各ファイルに対して以下を実行:
     - Firebase Storageにアップロード（パス: `projects/{projectId}/stl/{partNumber}_{timestamp}.stl`）
     - Firestoreで部品番号を検索
     - 該当する部品がなければ新規作成
     - 指定個数分のPartItemを作成

5. **完了通知**
   - 成功/失敗件数を表示
   - `onImportComplete` コールバックを実行
   - モーダルを自動クローズ

## データ構造

### Part（部品）
```typescript
{
  id: number;
  part_number: string;  // ファイル名から抽出
  project_id: number;
}
```

### PartItem（工程アイテム）
```typescript
{
  id: number;
  part_id: number;
  storage_case: string;  // 自動生成: "AUTO-{partNumber}-{連番}"
  status: ProcessStatus;  // ユーザーが選択した初期ステータス
  completed_at: Date | null;
  updated_at: Timestamp;
}
```

## エラーハンドリング

- **無効なファイル名**: プレビュー時に赤色で表示、エラーメッセージを表示
- **アップロード失敗**: 個別にエラーを記録し、結果レポートに含める
- **重複部品番号**: 既存の部品を使用（新規作成しない）
- **ネットワークエラー**: エラーメッセージを表示し、リトライを促す

## カスタマイズ

### ファイル名パターンの拡張

`lib/utils/parseFileName.ts` の `parseFileName` 関数を編集:

```typescript
// 例: プレフィックス付きパターンに対応
const prefixPattern = /^PREFIX_(.+?)_x(\d+)$/;
```

### 初期ステータスの変更

`app/components/StlImportModal.tsx` の `defaultStatus` の初期値を変更:

```typescript
const [defaultStatus, setDefaultStatus] = useState<ProcessStatus>('PRINTED');
```

### ストレージパスのカスタマイズ

`app/actions/importStl.ts` の `storagePath` を変更:

```typescript
const storagePath = `custom/path/${partNumber}.stl`;
```

## テスト方法

1. Firebase Emulatorを起動
2. プロジェクトページを開く
3. 以下のテストファイルを準備:
   - `TEST001.stl`
   - `TEST002_x3.stl`
   - `INVALID_NAME.txt` (エラーテスト用)
4. ファイルをドラッグ&ドロップ
5. プレビューを確認
6. インポート実行
7. Firestore Emulator UIで確認:
   - `parts` コレクション
   - `partItems` コレクション
8. Storage Emulator UIでファイルを確認

## トラブルシューティング

### ファイルがアップロードされない
- Firebase Emulatorが起動しているか確認
- `lib/firebase.ts` の接続設定を確認
- ブラウザのコンソールでエラーを確認

### 部品が重複して作成される
- Firestoreのクエリが正しく動作しているか確認
- `part_number` と `project_id` の両方で検索していることを確認

### プレビューが表示されない
- `/api/preview-filenames` のレスポンスを確認
- ファイル名が `.stl` で終わっているか確認

## 今後の拡張案

- [ ] バッチインポートの進捗バー表示
- [ ] インポート履歴の記録
- [ ] ファイル名パターンのカスタム設定UI
- [ ] STLファイルのサムネイル生成
- [ ] 重複チェック時の上書き/スキップ選択
- [ ] CSVによる一括インポート
</file>

<file path="firebase-data/auth_export/accounts.json">
{"kind":"identitytoolkit#DownloadAccountResponse","users":[]}
</file>

<file path="firebase-data/auth_export/config.json">
{"signIn":{"allowDuplicateEmails":false},"emailPrivacyConfig":{"enableImprovedEmailPrivacy":false}}
</file>

<file path="firebase-data/firebase-export-metadata.json">
{
  "version": "15.5.1",
  "firestore": {
    "version": "1.20.2",
    "path": "firestore_export",
    "metadata_file": "firestore_export/firestore_export.overall_export_metadata"
  },
  "database": {
    "version": "4.11.2",
    "path": "database_export"
  },
  "auth": {
    "version": "15.5.1",
    "path": "auth_export"
  },
  "storage": {
    "version": "15.5.1",
    "path": "storage_export"
  }
}
</file>

<file path="firebase.json">
{
  "firestore": {
    "database": "(default)",
    "location": "nam5",
    "rules": "firestore.rules",
    "indexes": "firestore.indexes.json"
  },
  "emulators": {
    "auth": {
      "port": 9099
    },
    "firestore": {
      "port": 8080
    },
    "database": {
      "port": 9000
    },
    "hosting": {
      "port": 5000
    },
    "storage": {
      "port": 9199
    },
    "ui": {
      "enabled": true
    },
    "singleProjectMode": true
  }
}
</file>

<file path="firestore.indexes.json">
{
  // Example (Standard Edition):
  //
  // "indexes": [
  //   {
  //     "collectionGroup": "widgets",
  //     "queryScope": "COLLECTION",
  //     "fields": [
  //       { "fieldPath": "foo", "arrayConfig": "CONTAINS" },
  //       { "fieldPath": "bar", "mode": "DESCENDING" }
  //     ]
  //   },
  //
  //  "fieldOverrides": [
  //    {
  //      "collectionGroup": "widgets",
  //      "fieldPath": "baz",
  //      "indexes": [
  //        { "order": "ASCENDING", "queryScope": "COLLECTION" }
  //      ]
  //    },
  //   ]
  // ]
  //
  // Example (Enterprise Edition):
  //
  // "indexes": [
  //   {
  //     "collectionGroup": "reviews",
  //     "queryScope": "COLLECTION_GROUP",
  //     "apiScope": "MONGODB_COMPATIBLE_API",
  //     "density": "DENSE",
  //     "multikey": false,
  //     "fields": [
  //       { "fieldPath": "baz", "mode": "ASCENDING" }
  //     ]
  //   },
  //   {
  //     "collectionGroup": "items",
  //     "queryScope": "COLLECTION_GROUP",
  //     "apiScope": "MONGODB_COMPATIBLE_API",
  //     "density": "SPARSE_ANY",
  //     "multikey": true,
  //     "fields": [
  //       { "fieldPath": "baz", "mode": "ASCENDING" }
  //     ]
  //   },
  // ]
  "indexes": [],
  "fieldOverrides": []
}
</file>

<file path="firestore.rules">
rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      // 開発中は認証なしで全操作を許可
      allow read, write: if true;
    }
  }
}
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
}

module.exports = nextConfig
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
  },
}
</file>

<file path="README.md">
# SN-923
</file>

<file path="src/modules/engineering/actions/importStl.ts">
'use server'

/**
 * Engineering Module - Import STL Action
 * STLファイルのインポートを統括するオーケストレーター
 */

import { revalidatePath } from 'next/cache';
import { ProcessStatus } from '@/src/shared/types';
import { ParsedFileInfo } from '@/src/modules/inventory/types';

// Engineering Services
import {
    parseFileName,
    uploadStlFile
} from '@/src/modules/engineering/services/stlService';

// Inventory Services
import { ensurePartExists } from '@/src/modules/inventory/services/partService';
import {
    allocateBoxes,
    previewBoxAllocation
} from '@/src/modules/inventory/services/boxService';

// Production Services
import { createItems } from '@/src/modules/production/services/itemService';

export interface ImportResult {
    success: boolean;
    fileName: string;
    partNumber?: string;
    partId?: string;
    itemsCreated?: number;
    error?: string;
}

/**
 * 単一のSTLファイルをインポートする
 * 
 * @param fileBuffer - アップロードするファイル（ArrayBuffer）
 * @param fileName - ファイル名
 * @param projectId - プロジェクトID
 * @param defaultStatus - 初期ステータス（デフォルト: 'CUTTING'）
 * @returns インポート結果
 */
export async function importSingleStl(
    fileBuffer: ArrayBuffer,
    fileName: string,
    projectId: string,
    defaultStatus: ProcessStatus = 'CUTTING'
): Promise<ImportResult> {
    try {
        // 1. Engineering: ファイル名を解析
        const parsed = parseFileName(fileName);

        if (!parsed.isValid) {
            return {
                success: false,
                fileName,
                error: parsed.errorMessage || 'ファイル名の解析に失敗しました'
            };
        }

        const { partNumber, quantity } = parsed;

        // 2. Engineering: Firebase Storage にアップロード
        const downloadUrl = await uploadStlFile(fileBuffer, partNumber, projectId as any);
        console.log(`[ImportSTL] Uploaded file: ${downloadUrl}`);

        // 3. Inventory: 部品マスタの確認・作成
        const part = await ensurePartExists(partNumber, projectId);

        // 4. Inventory: ボックスの確保（空き箱を探す）
        const boxes = await allocateBoxes(quantity);

        // 5. Production: アイテムの生成とステータス初期化
        await createItems(part.id, quantity, boxes, defaultStatus);

        // 6. キャッシュを再検証
        revalidatePath('/');
        revalidatePath(`/project/${projectId}`);

        return {
            success: true,
            fileName,
            partNumber,
            partId: part.id,
            itemsCreated: quantity
        };

    } catch (error) {
        console.error('[ImportSTL] Error importing STL:', error);
        return {
            success: false,
            fileName,
            error: error instanceof Error ? error.message : '不明なエラーが発生しました'
        };
    }
}

/**
 * 複数のSTLファイルを一括インポートする
 * 
 * @param filesData - アップロードするファイルの配列
 * @param projectId - プロジェクトID
 * @param defaultStatus - 初期ステータス
 * @returns インポート結果の配列
 */
export async function importMultipleStl(
    filesData: Array<{ buffer: ArrayBuffer; name: string }>,
    projectId: string,
    defaultStatus: ProcessStatus = 'CUTTING'
): Promise<ImportResult[]> {
    const results: ImportResult[] = [];

    for (const fileData of filesData) {
        const result = await importSingleStl(
            fileData.buffer,
            fileData.name,
            projectId,
            defaultStatus
        );
        results.push(result);
    }

    return results;
}

/**
 * ファイル名のプレビュー解析（実際のインポートは行わない）
 * 
 * @param fileNames - ファイル名の配列
 * @returns 解析結果の配列（ボックス割り当て情報付き）
 */
export async function previewFileNames(fileNames: string[]): Promise<ParsedFileInfo[]> {
    // 1. 各ファイル名を解析
    const parsedResults = fileNames.map(parseFileName);

    // 2. 有効な解析結果のみを抽出
    const validResults = parsedResults.filter(r => r.isValid);
    const quantities = validResults.map(r => r.quantity);

    // 3. ボックス割り当てをシミュレート
    const boxAllocations = await previewBoxAllocation(quantities);

    // 4. 解析結果にボックス情報を追加
    let validIndex = 0;
    return parsedResults.map(parsed => {
        if (!parsed.isValid) {
            return parsed;
        }

        const storageBoxes = boxAllocations[validIndex];
        validIndex++;

        return {
            ...parsed,
            storageBoxes
        };
    });
}
</file>

<file path="src/modules/engineering/components/StlImportModal.tsx">
'use client';

import React, { useState, useCallback } from 'react';
import { ParsedFileInfo } from '@/src/modules/inventory/types';
import { ProcessStatus } from '@/src/shared/types';

interface StlImportModalProps {
    isOpen: boolean;
    onClose: () => void;
    projectId: number;
    onImportComplete?: () => void;
}

interface FileWithPreview {
    file: File;
    parsed: ParsedFileInfo;
}

export function StlImportModal({ isOpen, onClose, projectId, onImportComplete }: StlImportModalProps) {
    const [files, setFiles] = useState<FileWithPreview[]>([]);
    const [isDragging, setIsDragging] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const [uploadProgress, setUploadProgress] = useState<string>('');
    const [defaultStatus, setDefaultStatus] = useState<ProcessStatus>('CUTTING');

    // ファイル名を解析してプレビューリストに追加
    const handleFiles = useCallback(async (fileList: FileList | File[]) => {
        const stlFiles = Array.from(fileList).filter(
            file => file.name.toLowerCase().endsWith('.stl')
        );

        if (stlFiles.length === 0) {
            alert('STLファイルを選択してください');
            return;
        }

        // サーバーサイドの解析関数を呼び出す
        const fileNames = stlFiles.map(f => f.name);
        const response = await fetch('/api/preview-filenames', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileNames })
        });

        const parsedInfos: ParsedFileInfo[] = await response.json();

        const filesWithPreview: FileWithPreview[] = stlFiles.map((file, index) => ({
            file,
            parsed: parsedInfos[index]
        }));

        setFiles(prev => [...prev, ...filesWithPreview]);
    }, []);

    // ドラッグ&ドロップのハンドラー
    const handleDragEnter = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(true);
    }, []);

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
    }, []);

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
    }, []);

    const handleDrop = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);

        const droppedFiles = e.dataTransfer.files;
        if (droppedFiles.length > 0) {
            handleFiles(droppedFiles);
        }
    }, [handleFiles]);

    // ファイル選択ダイアログ
    const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files.length > 0) {
            handleFiles(e.target.files);
        }
    }, [handleFiles]);

    // ファイルを削除
    const removeFile = useCallback((index: number) => {
        setFiles(prev => prev.filter((_, i) => i !== index));
    }, []);

    // インポート実行
    const handleImport = useCallback(async () => {
        if (files.length === 0) {
            alert('ファイルを選択してください');
            return;
        }

        // 無効なファイルがあるかチェック
        const invalidFiles = files.filter(f => !f.parsed.isValid);
        if (invalidFiles.length > 0) {
            const confirm = window.confirm(
                `${invalidFiles.length}件の無効なファイルがあります。有効なファイルのみインポートしますか?`
            );
            if (!confirm) return;
        }

        setIsUploading(true);
        setUploadProgress('アップロード中...');

        try {
            // ファイルをArrayBufferに変換
            const filesData = await Promise.all(
                files
                    .filter(f => f.parsed.isValid)
                    .map(async ({ file }) => ({
                        buffer: await file.arrayBuffer(),
                        name: file.name
                    }))
            );

            // サーバーアクションを呼び出す
            const response = await fetch('/api/import-stl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    projectId,
                    defaultStatus,
                    filesData: filesData.map(fd => ({
                        name: fd.name,
                        buffer: Array.from(new Uint8Array(fd.buffer))
                    }))
                })
            });

            const results = await response.json();

            const successCount = results.filter((r: any) => r.success).length;
            const failCount = results.filter((r: any) => !r.success).length;

            setUploadProgress(`完了: ${successCount}件成功, ${failCount}件失敗`);

            setTimeout(() => {
                setFiles([]);
                setUploadProgress('');
                setIsUploading(false);
                onImportComplete?.();
                onClose();
            }, 2000);

        } catch (error) {
            console.error('Import error:', error);
            setUploadProgress('エラーが発生しました');
            setIsUploading(false);
        }
    }, [files, projectId, defaultStatus, onImportComplete, onClose]);

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden">
                {/* ヘッダー */}
                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-blue-600 to-blue-700">
                    <h2 className="text-2xl font-bold text-white">STLファイルインポート</h2>
                    <button
                        onClick={onClose}
                        disabled={isUploading}
                        className="text-white/80 hover:text-white disabled:opacity-50"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                {/* ドラッグ&ドロップエリア */}
                <div className="p-6">
                    <div
                        onDragEnter={handleDragEnter}
                        onDragLeave={handleDragLeave}
                        onDragOver={handleDragOver}
                        onDrop={handleDrop}
                        className={`border-2 border-dashed rounded-xl p-12 text-center transition-all ${isDragging
                            ? 'border-blue-500 bg-blue-50'
                            : 'border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50/50'
                            }`}
                    >
                        <svg
                            className="mx-auto h-16 w-16 text-gray-400 mb-4"
                            stroke="currentColor"
                            fill="none"
                            viewBox="0 0 48 48"
                            aria-hidden="true"
                        >
                            <path
                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                strokeWidth={2}
                                strokeLinecap="round"
                                strokeLinejoin="round"
                            />
                        </svg>
                        <p className="text-lg font-semibold text-gray-700 mb-2">
                            STLファイルをドラッグ&ドロップ
                        </p>
                        <p className="text-sm text-gray-500 mb-4">または</p>
                        <label className="inline-block px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors cursor-pointer shadow-lg">
                            ファイルを選択
                            <input
                                type="file"
                                multiple
                                accept=".stl"
                                onChange={handleFileSelect}
                                className="hidden"
                                disabled={isUploading}
                            />
                        </label>
                    </div>

                    {/* 初期ステータス選択 */}
                    <div className="mt-6 flex items-center gap-4">
                        <label className="font-semibold text-gray-700">初期ステータス:</label>
                        <select
                            value={defaultStatus}
                            onChange={(e) => setDefaultStatus(e.target.value as ProcessStatus)}
                            disabled={isUploading}
                            className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="UNPRINTED">未プリント</option>
                            <option value="PRINTED">プリント済み</option>
                            <option value="SURFACE_TREATMENT">表面処理</option>
                            <option value="CUTTING">切削</option>
                            <option value="PAINTING">塗装</option>
                            <option value="READY">完成</option>
                        </select>
                    </div>
                </div>

                {/* プレビューリスト */}
                {files.length > 0 && (
                    <div className="px-6 pb-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">
                            抽出された部品番号 ({files.length}件)
                        </h3>
                        <div className="max-h-[40vh] overflow-y-auto border border-gray-200 rounded-xl">
                            <table className="w-full">
                                <thead className="bg-gray-100 sticky top-0">
                                    <tr className="text-xs text-gray-600 uppercase">
                                        <th className="text-left p-3">ファイル名</th>
                                        <th className="text-left p-3">部品番号</th>
                                        <th className="text-center p-3">個数</th>
                                        <th className="text-left p-3">保管ボックス</th>
                                        <th className="text-left p-3">状態</th>
                                        <th className="text-center p-3">操作</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {files.map((fileWithPreview, index) => (
                                        <tr key={index} className={fileWithPreview.parsed.isValid ? '' : 'bg-red-50'}>
                                            <td className="p-3 text-sm font-mono text-gray-700">
                                                {fileWithPreview.file.name}
                                            </td>
                                            <td className="p-3 font-semibold text-gray-800">
                                                {fileWithPreview.parsed.partNumber || '-'}
                                            </td>
                                            <td className="p-3 text-center font-bold text-blue-600">
                                                {fileWithPreview.parsed.quantity}
                                            </td>
                                            <td className="p-3">
                                                <div className="flex flex-wrap gap-1 max-w-[200px]">
                                                    {fileWithPreview.parsed.storageBoxes?.map((box, i) => (
                                                        <span key={i} className="text-[10px] px-1.5 py-0.5 bg-blue-50 text-blue-600 font-bold rounded border border-blue-100">
                                                            {box}
                                                        </span>
                                                    )) || '-'}
                                                </div>
                                            </td>
                                            <td className="p-3">
                                                {fileWithPreview.parsed.isValid ? (
                                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                                        ✓ 有効
                                                    </span>
                                                ) : (
                                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">
                                                        ✗ {fileWithPreview.parsed.errorMessage}
                                                    </span>
                                                )}
                                            </td>
                                            <td className="p-3 text-center">
                                                <button
                                                    onClick={() => removeFile(index)}
                                                    disabled={isUploading}
                                                    className="text-red-500 hover:text-red-700 disabled:opacity-50"
                                                >
                                                    削除
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {/* アップロード進捗 */}
                {uploadProgress && (
                    <div className="px-6 pb-4">
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <p className="text-blue-800 font-semibold">{uploadProgress}</p>
                        </div>
                    </div>
                )}

                {/* フッター */}
                <div className="p-6 bg-gray-50 flex gap-4">
                    <button
                        onClick={onClose}
                        disabled={isUploading}
                        className="flex-1 px-6 py-3 rounded-xl border border-gray-300 font-bold text-gray-600 hover:bg-white transition-colors disabled:opacity-50"
                    >
                        キャンセル
                    </button>
                    <button
                        onClick={handleImport}
                        disabled={files.length === 0 || isUploading}
                        className="flex-1 px-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        {isUploading ? 'インポート中...' : `インポート実行 (${files.filter(f => f.parsed.isValid).length}件)`}
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/modules/engineering/services/stlService.ts">
/**
 * Engineering Module - STL Service
 * STLファイルの解析とアップロード処理
 */

import { storage } from '@/src/shared/lib/firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { ParsedFileInfo } from '@/src/modules/inventory/types';

/**
 * ファイル名から部品番号と個数を抽出する
 * 
 * 対応フォーマット:
 * - PART123.stl → 部品番号: PART123, 個数: 1
 * - PART123_x5.stl → 部品番号: PART123, 個数: 5
 * - PART123_X10.stl → 部品番号: PART123, 個数: 10
 * - ABC-456_x3.stl → 部品番号: ABC-456, 個数: 3
 * 
 * @param fileName - 解析するファイル名（拡張子含む）
 * @returns 解析結果
 */
export function parseFileName(fileName: string): ParsedFileInfo {
    // 拡張子を除去
    const nameWithoutExt = fileName.replace(/\.(stl|STL)$/, '');

    if (!nameWithoutExt) {
        return {
            originalFileName: fileName,
            partNumber: '',
            quantity: 1,
            isValid: false,
            errorMessage: 'ファイル名が空です'
        };
    }

    // パターン1: 部品番号_x個数 または 部品番号_X個数
    const quantityPattern = /^(.+?)_[xX](\d+)$/;
    const match = nameWithoutExt.match(quantityPattern);

    if (match) {
        const partNumber = match[1].trim();
        const quantity = parseInt(match[2], 10);

        if (!partNumber) {
            return {
                originalFileName: fileName,
                partNumber: '',
                quantity: 1,
                isValid: false,
                errorMessage: '部品番号が空です'
            };
        }

        if (quantity <= 0 || quantity > 1000) {
            return {
                originalFileName: fileName,
                partNumber,
                quantity: 1,
                isValid: false,
                errorMessage: `個数が範囲外です（1-1000）: ${quantity}`
            };
        }

        return {
            originalFileName: fileName,
            partNumber,
            quantity,
            isValid: true
        };
    }

    // パターン2: 部品番号のみ（個数指定なし）
    const partNumber = nameWithoutExt.trim();

    if (!partNumber) {
        return {
            originalFileName: fileName,
            partNumber: '',
            quantity: 1,
            isValid: false,
            errorMessage: '部品番号が空です'
        };
    }

    return {
        originalFileName: fileName,
        partNumber,
        quantity: 1,
        isValid: true
    };
}

/**
 * 複数のファイル名を一括解析する
 * 
 * @param fileNames - ファイル名の配列
 * @returns 解析結果の配列
 */
export function parseFileNames(fileNames: string[]): ParsedFileInfo[] {
    return fileNames.map(parseFileName);
}

/**
 * 解析結果から有効なもののみをフィルタリング
 * 
 * @param parsedInfos - 解析結果の配列
 * @returns 有効な解析結果のみの配列
 */
export function filterValidParsedInfos(parsedInfos: ParsedFileInfo[]): ParsedFileInfo[] {
    return parsedInfos.filter(info => info.isValid);
}

/**
 * STLファイルをFirebase Storageにアップロードする
 * 
 * @param fileBuffer - ファイルのArrayBuffer
 * @param partNumber - 部品番号
 * @param projectId - プロジェクトID
 * @returns アップロードされたファイルのダウンロードURL
 */
export async function uploadStlFile(
    fileBuffer: ArrayBuffer,
    partNumber: string,
    projectId: string
): Promise<string> {
    const timestamp = Date.now();
    const storagePath = `projects/${projectId}/stl/${partNumber}_${timestamp}.stl`;
    const storageRef = ref(storage, storagePath);

    await uploadBytes(storageRef, fileBuffer);
    const downloadUrl = await getDownloadURL(storageRef);

    return downloadUrl;
}
</file>

<file path="src/modules/inventory/actions/storageActions.ts">
'use server'

/**
 * Inventory Module - Storage Actions
 * 保管箱の管理に関するアクション
 */

import { db } from '@/src/shared/lib/firebase';
import { doc, updateDoc, collection, getDocs, serverTimestamp, query, where } from 'firebase/firestore';
import { revalidatePath } from 'next/cache';

/**
 * 特定のアイテムの保管ボックスを強制的に解放する
 * @param itemId - 部品アイテムのID
 */
export async function releaseStorageCase(itemId: number) {
    try {
        const itemRef = doc(db, 'partItems', String(itemId));
        await updateDoc(itemRef, {
            storage_case: '',
            updated_at: serverTimestamp()
        });

        console.log(`[StorageActions] Released storage box for item ${itemId}`);

        revalidatePath('/');
        revalidatePath('/storage');

        return { success: true };
    } catch (error) {
        console.error('[StorageActions] Failed to release case:', error);
        return { success: false, error: (error as Error).message };
    }
}

/**
 * 保管ボックスの使用状況を取得する
 * @param maxBoxNumber - 最大ボックス番号
 */
export async function getStorageBoxStatus(maxBoxNumber: number = 100) {
    try {
        // 全アイテムと全部品を取得
        const itemsSnap = await getDocs(collection(db, 'partItems'));
        const partsSnap = await getDocs(collection(db, 'parts'));

        const partMap = new Map();
        partsSnap.forEach(doc => {
            const data = doc.data();
            partMap.set(data.id, data.part_number);
        });

        const boxMap = new Map();
        itemsSnap.forEach(doc => {
            const data = doc.data();
            if (data.storage_case && data.storage_case.trim() !== '') {
                boxMap.set(data.storage_case, {
                    itemId: data.id,
                    partNumber: partMap.get(data.part_id) || 'Unknown',
                    status: data.status
                });
            }
        });

        const boxes = [];
        for (let i = 1; i <= maxBoxNumber; i++) {
            const boxId = `BOX-${String(i).padStart(3, '0')}`;
            const usage = boxMap.get(boxId);

            boxes.push({
                boxId,
                isUsed: !!usage,
                itemId: usage?.itemId || null,
                partNumber: usage?.partNumber || null,
                status: usage?.status || null
            });
        }

        return { success: true, boxes };
    } catch (error) {
        console.error('[StorageActions] Failed to get status:', error);
        return { success: false, error: (error as Error).message, boxes: [] };
    }
}
</file>

<file path="src/modules/inventory/components/StorageBoxGrid.tsx">
'use client'

import { useState } from 'react';
import { releaseStorageCase } from '@/src/modules/inventory/actions/storageActions';

interface Box {
    boxId: string;
    isUsed: boolean;
    itemId: number | null;
    partNumber: string | null;
    status: string | null;
}

interface StorageBoxGridProps {
    boxes: Box[];
}

export default function StorageBoxGrid({ boxes }: StorageBoxGridProps) {
    const [releasing, setReleasing] = useState<string | null>(null);

    const handleRelease = async (boxId: string, itemId: number) => {
        if (!confirm(`ボックス ${boxId} を強制解放しますか？`)) {
            return;
        }

        setReleasing(boxId);
        try {
            const result = await releaseStorageCase(itemId);
            if (result.success) {
                // revalidatePathによって自動的にページが更新される
            } else {
                alert(`解放に失敗しました: ${result.error}`);
            }
        } catch (error) {
            alert(`エラーが発生しました: ${error}`);
        } finally {
            setReleasing(null);
        }
    };

    return (
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            {boxes.map((box) => (
                <div
                    key={box.boxId}
                    className={`
                        rounded-lg border-2 p-4 transition-all
                        ${box.isUsed
                            ? 'bg-blue-50 border-blue-300 shadow-sm'
                            : 'bg-gray-50 border-gray-200'
                        }
                    `}
                >
                    <div className="text-center">
                        <div className="font-bold text-lg mb-2 text-gray-800">
                            {box.boxId}
                        </div>

                        {box.isUsed ? (
                            <div className="space-y-2">
                                <div className="text-sm">
                                    <div className="text-gray-600 font-medium">
                                        {box.partNumber}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        {box.status}
                                    </div>
                                </div>

                                <button
                                    onClick={() => handleRelease(box.boxId, box.itemId!)}
                                    disabled={releasing === box.boxId}
                                    className="
                                        w-full px-3 py-1.5 text-xs font-medium
                                        bg-red-500 text-white rounded
                                        hover:bg-red-600 
                                        disabled:bg-gray-400 disabled:cursor-not-allowed
                                        transition-colors
                                    "
                                >
                                    {releasing === box.boxId ? '解放中...' : '強制解放'}
                                </button>
                            </div>
                        ) : (
                            <div className="text-sm text-gray-400 py-2">
                                空き
                            </div>
                        )}
                    </div>
                </div>
            ))}
        </div>
    );
}
</file>

<file path="src/modules/inventory/services/boxService.ts">
/**
 * Inventory Module - Box Service
 * 保管ケース（ボックス）の採番と管理
 */

import { db } from '@/src/shared/lib/firebase';
import { collection, getDocs } from 'firebase/firestore';

/**
 * 使用中のボックスIDを取得する
 * 
 * @returns 使用中のボックスIDのSet
 */
export async function getUsedBoxes(): Promise<Set<string>> {
    const allItemsSnapshot = await getDocs(collection(db, 'partItems'));
    const usedBoxes = new Set<string>();

    allItemsSnapshot.docs.forEach(doc => {
        const data = doc.data();
        if (data.storage_case && data.storage_case.trim() !== '') {
            usedBoxes.add(data.storage_case);
        }
    });

    return usedBoxes;
}

/**
 * 次に利用可能なボックスIDを探す
 * 
 * @param usedBoxes - 使用中のボックスIDのSet
 * @returns 次に利用可能なボックスID
 */
export function findNextAvailableBox(usedBoxes: Set<string>): string {
    let boxNumber = 1;
    while (true) {
        const boxId = `BOX-${String(boxNumber).padStart(3, '0')}`;
        if (!usedBoxes.has(boxId)) {
            return boxId;
        }
        boxNumber++;
    }
}

/**
 * 指定された個数分のボックスを確保する
 * 
 * @param quantity - 必要なボックスの個数
 * @returns 確保されたボックスIDの配列
 */
export async function allocateBoxes(quantity: number): Promise<string[]> {
    const usedBoxes = await getUsedBoxes();
    const allocatedBoxes: string[] = [];

    for (let i = 0; i < quantity; i++) {
        const boxId = findNextAvailableBox(usedBoxes);
        usedBoxes.add(boxId); // 次の検索で重複しないように追加
        allocatedBoxes.push(boxId);
    }

    console.log(`[BoxService] Allocated ${quantity} boxes: ${allocatedBoxes.join(', ')}`);
    return allocatedBoxes;
}

/**
 * プレビュー用：ボックス割り当てをシミュレートする（DB更新なし）
 * 
 * @param quantities - 各ファイルに必要なボックス数の配列
 * @returns 各ファイルに割り当てられるボックスIDの2次元配列
 */
export async function previewBoxAllocation(quantities: number[]): Promise<string[][]> {
    const usedBoxes = await getUsedBoxes();
    const allAllocations: string[][] = [];

    for (const quantity of quantities) {
        const allocation: string[] = [];
        for (let i = 0; i < quantity; i++) {
            const boxId = findNextAvailableBox(usedBoxes);
            usedBoxes.add(boxId);
            allocation.push(boxId);
        }
        allAllocations.push(allocation);
    }

    return allAllocations;
}
</file>

<file path="src/modules/inventory/services/partService.ts">
/**
 * Inventory Module - Part Service
 * 部品マスタの管理（取得・作成）
 */

import { db } from '@/src/shared/lib/firebase';
import {
    collection,
    getDocs,
    doc,
    setDoc,
    query,
    where
} from 'firebase/firestore';
import { Part } from '@/src/modules/inventory/types';

/**
 * 部品番号とプロジェクトIDから部品を検索する
 * 
 * @param partNumber - 部品番号
 * @param projectId - プロジェクトID
 * @returns 見つかった部品、または null
 */
export async function findPartByNumber(
    partNumber: string,
    projectId: string
): Promise<Part | null> {
    const partsRef = collection(db, 'parts');
    const q = query(
        partsRef,
        where('part_number', '==', partNumber),
        where('project_id', '==', projectId)
    );
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
        return null;
    }

    const partDoc = snapshot.docs[0];
    return {
        id: partDoc.id,
        ...partDoc.data()
    } as Part;
}

/**
 * 新しい部品を作成する
 * 
 * @param partNumber - 部品番号
 * @param projectId - プロジェクトID
 * @returns 作成された部品
 */
export async function createPart(
    partNumber: string,
    projectId: string
): Promise<Part> {
    const partRef = doc(collection(db, 'parts'));
    const newPart: Part = {
        id: partRef.id,
        part_number: partNumber,
        project_id: projectId
    };

    await setDoc(partRef, newPart);
    console.log(`[PartService] Created new Part: ${partNumber} (ID: ${partRef.id})`);

    return newPart;
}

/**
 * 部品が存在することを保証する（なければ作成）
 * 
 * @param partNumber - 部品番号
 * @param projectId - プロジェクトID
 * @returns 既存または新規作成された部品
 */
export async function ensurePartExists(
    partNumber: string,
    projectId: string
): Promise<Part> {
    const existingPart = await findPartByNumber(partNumber, projectId);

    if (existingPart) {
        console.log(`[PartService] Using existing Part: ${partNumber} (ID: ${existingPart.id})`);
        return existingPart;
    }

    return await createPart(partNumber, projectId);
}
</file>

<file path="src/modules/logistics/components/CartModal.tsx">
import { ProcessStatus } from '@/src/shared/types';
import { PROCESSES } from '@/app/constants';

interface CartItem {
    id: string;
    part_number: string;
    status: ProcessStatus;
    count: number;
}

interface CartModalProps {
    isOpen: boolean;
    onClose: () => void;
    items: CartItem[];
    onDownload: () => void;
}

export function CartModal({ isOpen, onClose, items, onDownload }: CartModalProps) {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 backdrop-blur-sm">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[85vh]">
                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <div>
                        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <span className="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm">
                                {items.length}
                            </span>
                            Selected Items
                        </h2>
                        <p className="text-xs text-gray-500 mt-1">Ready for batch download</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div className="p-0 overflow-y-auto flex-1">
                    {items.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-16 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 mb-4 opacity-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <p>No items selected</p>
                        </div>
                    ) : (
                        <table className="w-full text-sm">
                            <thead className="text-xs text-gray-400 uppercase bg-gray-50/50 sticky top-0 z-10">
                                <tr>
                                    <th className="text-left py-3 px-6 font-medium">Part Number</th>
                                    <th className="text-left py-3 px-6 font-medium">Current Status</th>
                                    <th className="text-right py-3 px-6 font-medium">Format</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {items.map((item) => {
                                    const processName = PROCESSES.find(p => p.key === item.status)?.name || item.status;
                                    return (
                                        <tr key={item.id} className="group hover:bg-blue-50/30 transition-colors">
                                            <td className="py-3 px-6 font-bold text-gray-800">
                                                {item.part_number}
                                                <div className="text-[10px] text-gray-400 font-normal">ID: {item.id}</div>
                                            </td>
                                            <td className="py-3 px-6">
                                                <span className="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs font-medium border border-gray-200">
                                                    {processName}
                                                </span>
                                            </td>
                                            <td className="py-3 px-6 text-right text-gray-500 font-mono text-xs">
                                                .stl
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    )}
                </div>

                <div className="p-6 bg-gray-50 flex gap-4">
                    <button
                        onClick={onClose}
                        className="flex-1 px-6 py-3 rounded-xl border border-gray-300 font-bold text-gray-600 hover:bg-white transition-colors"
                    >
                        戻る
                    </button>
                    <button
                        onClick={onDownload}
                        disabled={items.length === 0}
                        className="flex-1 px-6 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 transition-colors shadow-lg disabled:bg-gray-300"
                    >
                        Zipで一括ダウンロード
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/modules/production/actions/consumeItem.ts">
'use server'

/**
 * Production Module - Consume Item Action
 * 部品アイテムを消費済みにする
 */

import { revalidatePath } from 'next/cache';
import { updateItemStatus } from '@/src/modules/production/services/itemService';

/**
 * 部品アイテムを消費済みにするサーバーアクション
 * @param itemId - 消費する部品アイテムのID
 */
export async function consumeItem(itemId: string | number) {
    const id = typeof itemId === 'string' ? parseInt(itemId, 10) : itemId;

    // READY（または消費済みを意味するステータス）に更新
    // ここでは既存ロジックに合わせてステータスを更新し、保管ボックスを実質的に空にする
    await updateItemStatus(id, 'ASSEMBLED'); // 完成＝消費とみなす

    console.log(`[ConsumeItem] Consumed item ${id}`);

    revalidatePath('/');
    revalidatePath(`/item/${id}`);
}
</file>

<file path="src/modules/production/actions/createPrinted.ts">
'use server'

/**
 * Production Module - Create Printed Action
 * 3Dプリントされたアイテムの登録
 */

import { revalidatePath } from 'next/cache';
import { ProcessStatus } from '@/src/shared/types';
import { registerPrintedItems } from '@/src/modules/production/services/productionService';
import { parseFileName } from '@/src/modules/engineering/services/stlService';

/**
 * 3Dプリントされた新しい部品アイテムを作成するサーバーアクション
 * 
 * @param fileBuffer - STLファイルのArrayBuffer
 * @param fileName - ファイル名
 * @param projectId - プロジェクトID
 * @param qty - 数量
 * @param targetStatus - 初期ステータス（デフォルト: 'PRINTED'）
 */
export async function createPrinted(
    fileBuffer: ArrayBuffer,
    fileName: string,
    projectId: string,
    qty: number,
    targetStatus: ProcessStatus = 'PRINTED'
): Promise<{ success: boolean; partNumber: string }> {
    try {
        // 1. Engineering: ファイル名を解析して部品番号を取得
        const parsed = parseFileName(fileName);
        if (!parsed.isValid) {
            throw new Error(parsed.errorMessage || 'ファイル名の解析に失敗しました');
        }
        const partNumber = parsed.partNumber;

        // 2. Production: 印刷済みアイテムとして登録（トランザクション）
        const result = await registerPrintedItems(
            fileBuffer,
            partNumber,
            projectId,
            qty,
            targetStatus
        );

        console.log(`[CreatePrinted] Successfully created ${qty} items for part ${partNumber}`);
        revalidatePath('/');
        if (projectId) revalidatePath(`/project/${projectId}`);

        return { success: true, partNumber: result.partNumber };

    } catch (error) {
        console.error('[CreatePrinted] Error:', error);
        throw error;
    }
}
</file>

<file path="src/modules/production/actions/reportDefect.ts">
'use server'

/**
 * Production Module - Report Defect Action
 * 不良を報告し、再製作ジョブを生成する
 */

import { db } from '@/src/shared/lib/firebase';
import { doc, getDoc, serverTimestamp } from 'firebase/firestore';
import { revalidatePath } from 'next/cache';
import { updateItemStatus, createItems } from '@/src/modules/production/services/itemService';

/**
 * 不良を報告し、再製作ジョブを生成するサーバーアクション
 * @param itemId - 不良が発生したアイテムのID
 * @param reason - 不良の理由
 */
export async function reportDefect(itemId: string, reason: string) {
    const id = itemId;

    // 1. 元のアイテム情報を取得
    const itemRef = doc(db, 'partItems', id);
    const itemSnap = await getDoc(itemRef);

    if (!itemSnap.exists()) {
        console.error(`[ReportDefect] Item ${id} not found`);
        return { success: false, error: 'Item not found' };
    }

    const itemData = itemSnap.data();

    // 2. 現状のアイテムを「不良(DEFECTIVE)」にする
    await updateItemStatus(id, 'DEFECTIVE');

    // 3. 新しいジョブ（再製作）を生成する
    // 元のアイテムの情報を引き継ぎつつ、工程を「未プリント」に戻す
    // ボックス名は (RE) を付与
    await createItems(
        itemData.part_id,
        1,
        [`${itemData.storage_case} (RE)`],
        'UNPRINTED'
    );

    console.log(`[ReportDefect] Reported defect for item ${id}: ${reason}`);

    // キャッシュを更新
    revalidatePath('/');
    revalidatePath(`/item/${id}`);

    return { success: true };
}
</file>

<file path="src/modules/production/actions/updateItemStatus.ts">
'use server'

/**
 * Production Module - Update Item Status Action
 * ステータス更新と付随するロジック（ボックス解放など）
 */

import { revalidatePath } from 'next/cache';
import { updateItemStatus as updateStatus } from '@/src/modules/production/services/itemService';
import { db } from '@/src/shared/lib/firebase';
import { doc, updateDoc, serverTimestamp } from 'firebase/firestore';

/**
 * 部品アイテムのステータスを更新するサーバーアクション
 * @param itemId - 部品アイテムのID
 * @param newStatus - 新しいステータス
 */
export async function updateItemStatus(itemId: string, newStatus: string) {
    try {
        const id = itemId;

        // ステータスを更新
        await updateStatus(id, newStatus as any);

        // ステータスがASSEMBLED（完成）の場合、保管ボックスを解放
        if (newStatus === 'ASSEMBLED') {
            const itemRef = doc(db, 'partItems', id);
            await updateDoc(itemRef, {
                storage_case: '',
                updated_at: serverTimestamp()
            });
            console.log(`[UpdateItemStatus] Released storage box for item ${id}`);
        }

        revalidatePath('/');
        revalidatePath('/storage');

        return { success: true };
    } catch (error) {
        console.error('[UpdateItemStatus] Failed:', error);
        return { success: false, error: (error as Error).message };
    }
}
</file>

<file path="src/modules/production/actions/updateProcess.ts">
'use server'

/**
 * Production Module - Update Process Action
 * 工程アイテムのステータス更新
 */

import { revalidatePath } from 'next/cache';
import { ProcessStatus } from '@/src/shared/types';
import { updateItemStatus } from '@/src/modules/production/services/itemService';

/**
 * 部品アイテムの工程を更新するサーバーアクション
 * 
 * @param itemId - 更新する部品アイテムのID
 * @param nextProcess - 次の工程ステータス
 * @param projectId - プロジェクトID（オプション）
 */
export async function updateProcess(
    itemId: string,
    nextProcess: string,
    projectId?: string
) {
    const id = itemId;

    // Production Service を使用してステータスを更新
    await updateItemStatus(id, nextProcess as ProcessStatus);

    console.log(`[UpdateProcess] Updated item ${id} to status ${nextProcess}`);

    // キャッシュを更新してUIに反映
    revalidatePath('/');
    revalidatePath(`/item/${id}`);
    if (projectId) {
        revalidatePath(`/project/${projectId}`);
    }
}
</file>

<file path="src/modules/production/components/MovePartModal.tsx">
import React from 'react';
import { Unit } from '@/app/types';
import { X, FolderOutput, Folder } from 'lucide-react';

interface MovePartModalProps {
    isOpen: boolean;
    onClose: () => void;
    onMove: (unitId: string | null) => void;
    units: Unit[];
    currentUnitId?: string | null;
    partNumber: string;
}

export function MovePartModal({
    isOpen,
    onClose,
    onMove,
    units,
    currentUnitId,
    partNumber
}: MovePartModalProps) {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 duration-200">
                <div className="bg-gray-50 border-b border-gray-100 p-4 flex items-center justify-between">
                    <div>
                        <h3 className="text-sm font-bold text-gray-900">ユニット移動</h3>
                        <p className="text-xs text-gray-500 mt-0.5">部品: <span className="font-mono text-blue-600">{partNumber}</span></p>
                    </div>
                    <button
                        onClick={onClose}
                        className="p-1 rounded-full hover:bg-gray-200 transition-colors text-gray-400 hover:text-gray-600"
                    >
                        <X size={18} />
                    </button>
                </div>

                <div className="p-2 max-h-[60vh] overflow-y-auto">
                    <div className="grid gap-1">
                        {/* 未分類へ移動 */}
                        <button
                            onClick={() => onMove(null)}
                            disabled={!currentUnitId}
                            className={`
                                flex items-center gap-3 w-full p-3 rounded-lg text-left transition-all border
                                ${!currentUnitId
                                    ? 'bg-blue-50 border-blue-200 text-blue-700 cursor-default'
                                    : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-200 text-gray-600'
                                }
                            `}
                        >
                            <div className={`p-2 rounded-md ${!currentUnitId ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-400'}`}>
                                <FolderOutput size={18} />
                            </div>
                            <div className="flex-1">
                                <span className="text-sm font-bold block">未分類 (No Unit)</span>
                                <span className="text-[10px] text-gray-400">ユニットから除外する</span>
                            </div>
                            {!currentUnitId && <span className="text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">CURRENT</span>}
                        </button>

                        <div className="h-px bg-gray-100 my-1 mx-2" />

                        {/* 各ユニットへ移動 */}
                        {units.length === 0 ? (
                            <div className="text-center py-8 text-gray-400 text-xs italic">
                                作成されたユニットはありません
                            </div>
                        ) : (
                            units.map((unit) => {
                                const isCurrent = unit.id === currentUnitId;
                                return (
                                    <button
                                        key={unit.id}
                                        onClick={() => onMove(unit.id)}
                                        disabled={isCurrent}
                                        className={`
                                            flex items-center gap-3 w-full p-3 rounded-lg text-left transition-all border
                                            ${isCurrent
                                                ? 'bg-blue-50 border-blue-200 text-blue-700 cursor-default'
                                                : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-200 text-gray-700'
                                            }
                                        `}
                                    >
                                        <div className={`p-2 rounded-md ${isCurrent ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-400'}`}>
                                            <Folder size={18} />
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <span className="text-sm font-bold block truncate">{unit.name}</span>
                                            {unit.description && <span className="text-[10px] text-gray-400 truncate block">{unit.description}</span>}
                                        </div>
                                        {isCurrent && <span className="text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">CURRENT</span>}
                                    </button>
                                );
                            })
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/modules/production/components/PreviewModal.tsx">
'use client'

import { useState, useTransition } from 'react'
import { ModelViewer } from '@/src/shared/components/ModelViewer'
import { PROCESSES } from '@/app/constants'
import { updateProcess } from '@/src/modules/production/actions/updateProcess'
import { reportDefect } from '@/src/modules/production/actions/reportDefect'

interface PreviewModalProps {
    isOpen: boolean
    onClose: () => void
    partNumber: string
    itemId?: string
    status?: string
    projectId?: string
}

export function PreviewModal({
    isOpen,
    onClose,
    partNumber,
    itemId,
    status,
    projectId
}: PreviewModalProps) {
    const [isPending, startTransition] = useTransition()
    const [defectReason, setDefectReason] = useState('')

    if (!isOpen) return null

    // 現在の工程より「前」の工程を抽出（差し戻し用）
    const currentIndex = PROCESSES.findIndex(p => p.key === status)
    const previousProcesses = PROCESSES.slice(0, currentIndex)

    const handleUpdateStatus = (statusKey: string) => {
        if (!itemId || !projectId) return
        startTransition(async () => {
            await updateProcess(itemId, statusKey, projectId)
            onClose()
        })
    }

    const handleReportDefect = () => {
        if (!itemId || !defectReason) return
        startTransition(async () => {
            await reportDefect(itemId, defectReason)
            setDefectReason('')
            onClose()
        })
    }

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[110] p-4">
            <div className="bg-white rounded-3xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">

                {/* ヘッダー */}
                <div className="p-6 border-b flex justify-between items-center bg-gray-50">
                    <div>
                        <h3 className="text-2xl font-black text-gray-900">{partNumber}</h3>
                        <p className="text-sm text-gray-500 font-bold">ITEM ID: {itemId} / CURRENT: {status}</p>
                    </div>
                    <button
                        onClick={onClose}
                        className="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors text-2xl font-bold"
                    >
                        &times;
                    </button>
                </div>

                <div className="flex-1 flex flex-col md:flex-row overflow-hidden">
                    {/* 左側：3Dプレビュー */}
                    <div className="flex-[2] bg-gray-100 relative min-h-[300px]">
                        <ModelViewer url={`/models/${partNumber}.stl`} />
                        <div className="absolute bottom-4 left-4 bg-white/80 px-3 py-1 rounded text-xs font-bold text-gray-500">
                            3D PREVIEW MODE
                        </div>
                    </div>

                    {/* 右側：操作パネル */}
                    <div className="flex-1 border-l bg-white p-6 overflow-y-auto space-y-8">

                        {/* 1. 工程の差し戻し */}
                        <section>
                            <h4 className="text-sm font-black text-gray-400 uppercase tracking-widest mb-4">工程を差し戻す (手戻り)</h4>
                            <div className="grid grid-cols-1 gap-2">
                                {previousProcesses.length > 0 ? (
                                    previousProcesses.map((proc) => (
                                        <button
                                            key={proc.key}
                                            onClick={() => handleUpdateStatus(proc.key)}
                                            disabled={isPending}
                                            className="text-left px-4 py-3 border-2 border-orange-100 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition-all group"
                                        >
                                            <span className="text-xs font-bold text-orange-400 block uppercase">{proc.key}へ戻す</span>
                                            <span className="font-bold text-gray-700 group-hover:text-orange-700">{proc.name}</span>
                                        </button>
                                    ))
                                ) : (
                                    <p className="text-sm text-gray-400 italic">差し戻せる前の工程はありません</p>
                                )}
                            </div>
                        </section>

                        <hr className="border-gray-100" />

                        {/* 2. 不良報告 */}
                        <section className="p-5 border-2 border-red-100 rounded-2xl bg-red-50/30">
                            <h4 className="text-lg font-black text-red-700 mb-2">不良を報告する</h4>
                            <p className="text-xs text-red-600 mb-4 leading-relaxed font-medium">
                                個体に欠陥がある場合、不良として確定させます。実行すると自動的に再製作ジョブが生成されます。
                            </p>
                            <div className="space-y-3">
                                <textarea
                                    value={defectReason}
                                    onChange={(e) => setDefectReason(e.target.value)}
                                    placeholder="不良の理由を入力してください..."
                                    className="w-full p-3 border-2 border-red-100 rounded-xl text-sm focus:border-red-500 outline-none resize-none h-24 font-medium"
                                />
                                <button
                                    onClick={handleReportDefect}
                                    disabled={isPending || !defectReason}
                                    className={`w-full py-4 rounded-xl font-black transition-all shadow-md ${isPending || !defectReason
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        : 'bg-red-600 text-white hover:bg-red-700 active:scale-95'
                                        }`}
                                >
                                    {isPending ? '処理中...' : '不良確定 & 再製作依頼'}
                                </button>
                            </div>
                        </section>

                    </div>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="src/modules/production/components/swimlane/SwimlaneCell.tsx">
import React from 'react';
import { useDroppable } from '@dnd-kit/core';
import { SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { PartItem } from '@/src/modules/production/types';
import { ProcessStatus } from '@/src/shared/types';
import { SwimlaneItem } from './SwimlaneItem';

interface SwimlaneCellProps {
    partId: string;
    status: ProcessStatus;
    items: PartItem[];
    isLast: boolean;
    selectedIds: string[];
    onToggleSelect: (itemId: string) => void;
    onPreview: (item: any) => void;
}

export function SwimlaneCell({ partId, status, items, isLast, selectedIds, onToggleSelect, onPreview }: SwimlaneCellProps) {
    const droppableId = `container-${partId}-${status}`;
    const { setNodeRef, isOver } = useDroppable({ id: droppableId });

    return (
        <div
            ref={setNodeRef}
            className={`
        relative w-full h-[80px] border-b border-gray-100 p-2.5 transition-colors
        ${isOver ? 'bg-blue-50/50' : 'bg-white'}
        ${isLast ? 'border-b-0' : ''}
      `}
        >
            <SortableContext
                items={items.map(i => `item-${i.id}`)}
                strategy={verticalListSortingStrategy}
            >
                <div className="flex flex-col gap-2 h-full">
                    {items.map(item => (
                        <SwimlaneItem
                            key={item.id}
                            item={item}
                            isSelected={selectedIds.includes(item.id)}
                            onToggleSelect={onToggleSelect}
                            onPreview={onPreview}
                        />
                    ))}

                    {/* Placeholder when empty */}
                    {items.length === 0 && (
                        <div className="flex-1 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <span className="text-[10px] text-gray-300 font-medium border border-dashed border-gray-200 rounded px-2 py-1">
                                Drop
                            </span>
                        </div>
                    )}
                </div>
            </SortableContext>
        </div>
    );
}
</file>

<file path="src/modules/production/components/swimlane/SwimlaneItem.tsx">
import React from 'react';
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { GripVertical, Eye } from 'lucide-react';
import { PartItem } from '@/src/modules/production/types';

interface SwimlaneItemProps {
    item: PartItem & { part_number?: string };
    isOverlay?: boolean;
    isSelected?: boolean;
    onToggleSelect: (itemId: string) => void;
    onPreview: (item: any) => void;
}

export function SwimlaneItem({ item, isOverlay, isSelected, onToggleSelect, onPreview }: SwimlaneItemProps) {
    const {
        attributes,
        listeners,
        setNodeRef,
        transform,
        transition,
        isDragging
    } = useSortable({ id: `item-${item.id}` });

    const style = {
        transform: CSS.Transform.toString(transform),
        transition,
        opacity: isDragging ? 0.3 : 1,
        zIndex: isDragging || isOverlay ? 999 : 'auto',
    };

    return (
        <div
            ref={setNodeRef}
            style={style}
            className={`
        bg-white rounded-xl shadow-sm border p-2 select-none group relative
        ${isOverlay ? 'shadow-2xl scale-105 border-blue-500 ring-4 ring-blue-50' : 'hover:border-blue-400 hover:shadow-md'}
        ${isSelected ? 'border-blue-500 bg-blue-50/30 ring-2 ring-blue-100' : 'border-gray-200'}
        transition-all duration-200
      `}
        >
            <div className="flex items-center justify-between gap-3">
                {/* Drag Handle */}
                <div
                    {...attributes}
                    {...listeners}
                    className="cursor-grab active:cursor-grabbing p-1.5 -ml-1.5 text-gray-300 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors touch-none"
                >
                    <GripVertical size={16} />
                </div>

                {/* Item Content */}
                <div className="flex-1 min-w-0">
                    <div className="flex flex-col">
                        <div className="flex items-center gap-2 mb-1">
                            <span className="font-black text-xs text-gray-900 tracking-tight">#{item.id}</span>
                        </div>
                        {item.updated_at && (
                            <div className="text-[9px] text-gray-400 font-medium">
                                Last: {new Date(item.updated_at).toLocaleDateString()}
                            </div>
                        )}
                    </div>
                </div>

                {/* Selection Checkbox */}
                <div className="flex items-center">
                    <input
                        type="checkbox"
                        checked={isSelected}
                        onChange={(e) => {
                            e.stopPropagation();
                            onToggleSelect(item.id);
                        }}
                        className="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"
                    />
                </div>

                {/* Action Buttons */}
                <button
                    onClick={(e) => {
                        e.stopPropagation();
                        onPreview(item);
                    }}
                    className="text-gray-400 hover:text-blue-600 p-2 rounded-xl hover:bg-blue-50 transition-colors shadow-sm bg-gray-50/50"
                    title="詳細を見る"
                >
                    <Eye size={16} />
                </button>
            </div>
        </div>
    );
}
</file>

<file path="src/modules/production/services/productionService.ts">
/**
 * Production Module - Production Service
 * 複数のエンティティにまたがる製造関連のトランザクション処理
 */

import { db, storage } from '@/src/shared/lib/firebase';
import {
    collection,
    getDocs,
    doc,
    runTransaction,
    query,
    where,
    serverTimestamp
} from 'firebase/firestore';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { ProcessStatus } from '@/src/shared/types';
import { Part } from '@/src/modules/inventory/types';
import { PartItem } from '@/src/modules/production/types';

/**
 * STLファイルをアップロードし、部品を作成（未存在時）し、指定個数のアイテムを作成する
 * これらをアトミックなトランザクションとして実行する
 */
export async function registerPrintedItems(
    fileBuffer: ArrayBuffer,
    partNumber: string,
    projectId: string,
    quantity: number,
    targetStatus: ProcessStatus = 'PRINTED'
): Promise<{ success: boolean; partNumber: string; downloadUrl: string }> {

    // 1. Storageへのアップロード
    const timestamp = Date.now();
    const storagePath = `projects/${projectId}/stl/${partNumber}_${timestamp}.stl`;
    const storageRef = ref(storage, storagePath);
    await uploadBytes(storageRef, fileBuffer);
    const downloadUrl = await getDownloadURL(storageRef);

    // 2. Firestoreトランザクション
    await runTransaction(db, async (transaction) => {
        // 2a. 部品(Part)の存在確認
        const partsRef = collection(db, 'parts');
        const q = query(
            partsRef,
            where('part_number', '==', partNumber),
            where('project_id', '==', projectId)
        );
        const partQuerySnapshot = await getDocs(q);

        let partId: string;

        if (partQuerySnapshot.empty) {
            // 新規作成
            const partDocRef = doc(partsRef);
            partId = partDocRef.id;

            const newPart: Part = {
                id: partId,
                part_number: partNumber,
                project_id: projectId
            };

            transaction.set(partDocRef, newPart);
        } else {
            partId = partQuerySnapshot.docs[0].id;
        }

        // 2b. PartItem の作成
        for (let i = 0; i < quantity; i++) {
            const itemRef = doc(collection(db, 'partItems'));
            const newItemStub = {
                id: itemRef.id,
                part_id: partId,
                storage_case: `AUTO-${partNumber}-${i + 1}`,
                status: targetStatus,
                completed_at: null,
                updated_at: serverTimestamp(),
                stl_url: downloadUrl
            };

            transaction.set(itemRef, newItemStub);
        }
    });

    return { success: true, partNumber, downloadUrl };
}
</file>

<file path="src/modules/production/types/index.ts">
/**
 * Production Module - 型定義
 * 工程アイテムと進捗に関する型
 */

import { ProcessStatus } from '@/src/shared/types';

export interface PartItem {
    id: string;
    part_id: string;
    storage_case: string;
    status: ProcessStatus;
    completed_at: Date | null;
    updated_at?: any;
    stl_url?: string;
}

export interface ProgressData {
    part_number: string;
    storage_cases: string[];
    counts: Record<ProcessStatus, number>;
}
</file>

<file path="src/shared/components/FileDownloadButton.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import { ref, getDownloadURL } from 'firebase/storage';
import { storage } from '@/lib/firebase';

interface FileDownloadButtonProps {
    storagePath: string;
    fileName: string;
    label?: string;
    variant?: 'primary' | 'outline' | 'ghost';
    icon?: React.ReactNode;
}

export default function FileDownloadButton({
    storagePath,
    fileName,
    label,
    variant = 'outline',
    icon
}: FileDownloadButtonProps) {
    const [downloadUrl, setDownloadUrl] = useState<string | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [isError, setIsError] = useState(false);

    useEffect(() => {
        const fetchUrl = async () => {
            setIsLoading(true);
            setIsError(false);
            try {
                const fileRef = ref(storage, storagePath);
                const url = await getDownloadURL(fileRef);
                setDownloadUrl(url);
            } catch (error: any) {
                console.error(`Error fetching download URL for ${storagePath}:`, error);
                if (error.code === 'storage/object-not-found') {
                    setIsError(true);
                } else {
                    setIsError(true);
                }
            } finally {
                setIsLoading(false);
            }
        };

        if (storagePath) {
            fetchUrl();
        }
    }, [storagePath]);

    const handleDownload = () => {
        if (!downloadUrl) return;

        // Use a hidden anchor tag to trigger download with fileName
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = fileName;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const baseStyles = "inline-flex items-center justify-center gap-2 px-3 py-1.5 rounded-md text-xs font-bold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed";

    const variants = {
        primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-sm",
        outline: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
        ghost: "bg-transparent text-gray-600 hover:bg-gray-100"
    };

    const defaultIcon = (
        <svg xmlns="http://www.w3.org/2000/svg" className="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
    );

    if (isLoading) {
        return (
            <button disabled className={`${baseStyles} ${variants[variant]}`}>
                <span className="animate-spin rounded-full h-3.5 w-3.5 border-b-2 border-current"></span>
                {label || 'Loading...'}
            </button>
        );
    }

    if (isError) {
        return (
            <button disabled title="ファイルが登録されていません" className={`${baseStyles} ${variants[variant]} opacity-40`}>
                {icon || defaultIcon}
                {label ? `${label} (未登録)` : '未登録'}
            </button>
        );
    }

    return (
        <button
            onClick={handleDownload}
            className={`${baseStyles} ${variants[variant]}`}
        >
            {icon || defaultIcon}
            {label}
        </button>
    );
}
</file>

<file path="src/shared/components/ModelViewer.tsx">
'use client';

import { Canvas, useLoader } from '@react-three/fiber';
import { OrbitControls, Stage } from '@react-three/drei';
import { useState, useEffect, Suspense } from 'react';
import { STLLoader } from 'three-stdlib';

function STLModel({ url }: { url: string }) {
    if (!url) return null;

    const geom = useLoader(STLLoader, url);

    return (
        /* rotation: [x, y, z] 
           Math.PI / 2 は 90度です。
           CADのZ上をThree.jsのY上に合わせるため、X軸を軸にマイナス90度回転させます。
        */
        <mesh
            geometry={geom}
            rotation={[-Math.PI / 2, 0, 0]}
        >
            <meshStandardMaterial color="#3b82f6" />
        </mesh>
    );
}

export function ModelViewer({ url }: { url: string }) {
    const [mounted, setMounted] = useState(false);

    useEffect(() => {
        setMounted(true);
    }, []);

    if (!mounted) {
        return <div className="w-full h-[400px] bg-gray-900 rounded-lg" />;
    }

    return (
        <div className="w-full h-[400px] bg-gray-900 rounded-lg">
            <Canvas shadows camera={{ position: [0, 0, 20], fov: 50 }}>
                <Suspense fallback={null}>
                    <Stage environment="city" intensity={0.5}>
                        <STLModel url={url} />
                    </Stage>
                </Suspense>
                <OrbitControls autoRotate />
            </Canvas>
        </div>
    );
}
</file>

<file path="src/shared/components/SummaryCard.tsx">
// app/dashboard/components/SummaryCard.tsx
import React from 'react';

interface SummaryCardProps {
  title: string;
  value: number | string;
  valueColor?: string;
}

export function SummaryCard({ title, value, valueColor = 'text-gray-800' }: SummaryCardProps) {
  return (
    <div className="bg-white p-6 rounded-xl shadow-lg flex items-center">
      <div>
        <p className="text-lg text-gray-500">{title}</p>
        <p className={`text-5xl font-extrabold ${valueColor}`}>{value}</p>
      </div>
    </div>
  );
}
</file>

<file path="src/shared/lib/firebase.ts">
import { initializeApp, getApps } from "firebase/app";
import { getFirestore, connectFirestoreEmulator } from "firebase/firestore";
import { getAuth, connectAuthEmulator } from "firebase/auth";
import { getStorage, connectStorageEmulator } from "firebase/storage";

const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || "demo-bom3d-sn923";

const firebaseConfig = {
    apiKey: "fake-api-key", // Emulator用ダミー
    authDomain: `${projectId}.firebaseapp.com`,
    projectId: projectId,
    storageBucket: `${projectId}.appspot.com`,
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef"
};

const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const isEmulator = process.env.NODE_ENV === 'development' || projectId.startsWith('demo-');

if (isEmulator) {
    const g = global as any;
    if (!g._firebase_emulators_connected) {
        // 環境変数からポートを取得、なければデフォルト
        // localhost よりも 127.0.0.1 のほうが安定するケースがあるため変更
        connectFirestoreEmulator(db, '127.0.0.1', 8080);
        connectAuthEmulator(auth, "http://127.0.0.1:9099");
        connectStorageEmulator(storage, '127.0.0.1', 9199);
        g._firebase_emulators_connected = true;
        console.log(`Connected to Firebase Emulators: ${projectId}`);
    }
}

export { db, auth, storage };
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="tsconfig.node.json">
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path=".firebaserc">
{
  "projects": {
    "default": "demo-bom3d-sn923"
  }
}
</file>

<file path="app/actions/storageActions.ts">
'use server'

import {
    releaseStorageCase as releaseNew,
    getStorageBoxStatus as getStatusNew
} from '@/src/modules/inventory/actions/storageActions';

/**
 * @deprecated Use src/modules/inventory/actions/storageActions
 */
export async function releaseStorageCase(itemId: number) {
    return releaseNew(itemId);
}

/**
 * @deprecated Use src/modules/inventory/actions/storageActions
 */
export async function getStorageBoxStatus(maxBoxNumber: number = 100) {
    return getStatusNew(maxBoxNumber);
}
</file>

<file path="app/api/import-stl/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { importMultipleStl } from '@/src/modules/engineering/actions/importStl';
import { ProcessStatus } from '@/src/shared/types';

export async function POST(request: NextRequest) {
    try {
        const { projectId, defaultStatus, filesData } = await request.json();

        if (!projectId || !filesData || !Array.isArray(filesData)) {
            return NextResponse.json(
                { error: 'Invalid request parameters' },
                { status: 400 }
            );
        }

        // Uint8Array を ArrayBuffer に変換
        const convertedFilesData = filesData.map((fd: any) => ({
            name: fd.name,
            buffer: new Uint8Array(fd.buffer).buffer
        }));

        const results = await importMultipleStl(
            convertedFilesData,
            projectId,
            (defaultStatus as ProcessStatus) || 'CUTTING'
        );

        return NextResponse.json(results);
    } catch (error) {
        console.error('Error in import-stl API:', error);
        return NextResponse.json(
            { error: error instanceof Error ? error.message : 'Internal server error' },
            { status: 500 }
        );
    }
}
</file>

<file path="app/globals.css">
@import "tailwindcss";
</file>

<file path="app/layout.tsx">
import './globals.css'
import type { Metadata } from "next"

export const metadata: Metadata = {
  title: "SN-923",
  description: "在庫管理アプリケーション",
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  )
}
</file>

<file path="app/storage/page.tsx">
import { getStorageBoxStatus } from '@/src/modules/inventory/actions/storageActions';
import StorageBoxGrid from '@/src/modules/inventory/components/StorageBoxGrid';

export const dynamic = 'force-dynamic';

export default async function StoragePage() {
    const result = await getStorageBoxStatus(100);

    if (!result.success) {
        return (
            <div className="min-h-screen bg-gray-50 p-8">
                <div className="max-w-7xl mx-auto">
                    <h1 className="text-3xl font-bold text-gray-900 mb-6">保管ボックス管理</h1>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p className="text-red-800">エラーが発生しました: {result.error}</p>
                    </div>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-50 p-8">
            <div className="max-w-7xl mx-auto">
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">保管ボックス管理</h1>
                    <p className="text-gray-600">
                        保管ボックスの使用状況を確認し、必要に応じて強制解放できます。
                    </p>
                </div>

                <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <div className="flex items-center gap-6">
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-blue-500 rounded"></div>
                            <span className="text-sm text-gray-700">使用中</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-4 h-4 bg-gray-200 rounded"></div>
                            <span className="text-sm text-gray-700">空き</span>
                        </div>
                    </div>
                </div>

                <StorageBoxGrid boxes={result.boxes} />
            </div>
        </div>
    );
}
</file>

<file path="firebase-data/storage_export/buckets.json">
{
  "buckets": [
    {
      "id": "demo-no-project.appspot.com"
    },
    {
      "id": "demo-bom3d-sn923.appspot.com"
    }
  ]
}
</file>

<file path="lib/utils/parseFileName.ts">
/**
 * STLファイル名から部品情報を抽出するユーティリティ
 */

export interface ParsedFileInfo {
    /** 元のファイル名 */
    originalFileName: string;
    /** 抽出された部品番号 */
    partNumber: string;
    /** 個数（デフォルト: 1） */
    quantity: number;
    /** 解析が成功したか */
    isValid: boolean;
    /** エラーメッセージ（解析失敗時） */
    errorMessage?: string;
    /** 割り当てられる保管ボックスのリスト */
    storageBoxes?: string[];
}

/**
 * ファイル名から部品番号と個数を抽出する
 * 
 * 対応フォーマット:
 * - PART123.stl → 部品番号: PART123, 個数: 1
 * - PART123_x5.stl → 部品番号: PART123, 個数: 5
 * - PART123_X10.stl → 部品番号: PART123, 個数: 10
 * - ABC-456_x3.stl → 部品番号: ABC-456, 個数: 3
 * 
 * @param fileName - 解析するファイル名（拡張子含む）
 * @returns 解析結果
 */
export function parseFileName(fileName: string): ParsedFileInfo {
    // 拡張子を除去
    const nameWithoutExt = fileName.replace(/\.(stl|STL)$/, '');

    if (!nameWithoutExt) {
        return {
            originalFileName: fileName,
            partNumber: '',
            quantity: 1,
            isValid: false,
            errorMessage: 'ファイル名が空です'
        };
    }

    // パターン1: 部品番号_x個数 または 部品番号_X個数
    const quantityPattern = /^(.+?)_[xX](\d+)$/;
    const match = nameWithoutExt.match(quantityPattern);

    if (match) {
        const partNumber = match[1].trim();
        const quantity = parseInt(match[2], 10);

        if (!partNumber) {
            return {
                originalFileName: fileName,
                partNumber: '',
                quantity: 1,
                isValid: false,
                errorMessage: '部品番号が空です'
            };
        }

        if (quantity <= 0 || quantity > 1000) {
            return {
                originalFileName: fileName,
                partNumber,
                quantity: 1,
                isValid: false,
                errorMessage: `個数が範囲外です（1-1000）: ${quantity}`
            };
        }

        return {
            originalFileName: fileName,
            partNumber,
            quantity,
            isValid: true
        };
    }

    // パターン2: 部品番号のみ（個数指定なし）
    const partNumber = nameWithoutExt.trim();

    if (!partNumber) {
        return {
            originalFileName: fileName,
            partNumber: '',
            quantity: 1,
            isValid: false,
            errorMessage: '部品番号が空です'
        };
    }

    return {
        originalFileName: fileName,
        partNumber,
        quantity: 1,
        isValid: true
    };
}

/**
 * 複数のファイル名を一括解析する
 * 
 * @param fileNames - ファイル名の配列
 * @returns 解析結果の配列
 */
export function parseFileNames(fileNames: string[]): ParsedFileInfo[] {
    return fileNames.map(parseFileName);
}

/**
 * 解析結果から有効なもののみをフィルタリング
 * 
 * @param parsedInfos - 解析結果の配列
 * @returns 有効な解析結果のみの配列
 */
export function filterValidParsedInfos(parsedInfos: ParsedFileInfo[]): ParsedFileInfo[] {
    return parsedInfos.filter(info => info.isValid);
}
</file>

<file path="scripts/seed-emulator.ts">
import { db } from '../lib/firebase';
import { projects, parts, partItems } from '../app/data';
import { collection, doc, setDoc, serverTimestamp } from 'firebase/firestore';

// @ts-ignore
process.env.NODE_ENV = 'development';

async function seed() {
    console.log('Seeding Firestore Emulator...');
    console.log('Connecting to Firestore (ensure Emulator is running on localhost:8080)...');

    // Projects
    console.log('Seeding Projects...');
    for (const project of projects) {
        const projectRef = doc(db, 'projects', String(project.id));
        await setDoc(projectRef, {
            ...project,
            // Ensure dates are compatible if strings
        });
    }

    // Parts
    console.log('Seeding Parts...');
    for (const part of parts) {
        const partRef = doc(db, 'parts', String(part.id));
        await setDoc(partRef, part);
    }

    // PartItems
    console.log('Seeding PartItems...');
    for (const item of partItems) {
        const itemRef = doc(db, 'partItems', String(item.id));
        await setDoc(itemRef, {
            ...item,
            // Convert Date object to Timestamp or keep as Date
            completed_at: item.completed_at ? item.completed_at : null,
            updated_at: serverTimestamp()
        });
    }

    console.log('Seeding completed!');
    process.exit(0);
}

seed().catch((error) => {
    console.error('Seeding failed:', error);
    process.exit(1);
});
</file>

<file path="src/modules/inventory/types/index.ts">
/**
 * Inventory Module - 型定義
 * 部品マスタと在庫に関する型
 */

export interface Part {
    id: string;
    part_number: string;
    project_id: string;
    unit_id?: string | null;
}

export interface ParsedFileInfo {
    /** 元のファイル名 */
    originalFileName: string;
    /** 抽出された部品番号 */
    partNumber: string;
    /** 個数（デフォルト: 1） */
    quantity: number;
    /** 解析が成功したか */
    isValid: boolean;
    /** エラーメッセージ（解析失敗時） */
    errorMessage?: string;
    /** 割り当てられる保管ボックスのリスト */
    storageBoxes?: string[];
}
</file>

<file path="src/modules/production/components/swimlane/SwimlaneColumn.tsx">
import { Part } from '@/src/modules/inventory/types';
import { PartItem } from '@/src/modules/production/types';
import { PROCESSES } from '@/app/constants';
import { SwimlaneCell } from './SwimlaneCell';
import FileDownloadButton from '@/src/shared/components/FileDownloadButton';

import { MoveRight } from 'lucide-react';

interface SwimlaneColumnProps {
    part: Part;
    items: PartItem[];
    selectedIds: string[];
    onToggleSelect: (itemId: string) => void;
    onPreview: (item: any) => void;
    onMove: (partId: string) => void;
}

export function SwimlaneColumn({ part, items, selectedIds, onToggleSelect, onPreview, onMove }: SwimlaneColumnProps) {
    // Find the "furthest" process index that has items
    const lastActiveIndex = items.reduce((max, item) => {
        const idx = PROCESSES.findIndex(p => p.key === item.status);
        return Math.max(max, idx);
    }, -1);

    return (
        <div className="
      relative flex flex-col
      w-[85vw] md:w-64 shrink-0 snap-center
      border-r border-gray-200 bg-white
    ">
            {/* Column Header - Part Info */}
            <div className="sticky top-0 z-20 h-24 bg-white/80 backdrop-blur-md border-b border-gray-200 p-4 flex flex-col justify-between group-hover:bg-white transition-colors">
                <div className="min-w-0 flex items-start justify-between gap-2">
                    <div>
                        <h3 className="font-black text-gray-900 text-xs tracking-tight truncate uppercase" title={part.part_number}>
                            {part.part_number}
                        </h3>
                        <div className="flex items-center gap-1.5 mt-1">
                            <div className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse" />
                            <p className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">
                                Active
                            </p>
                        </div>
                    </div>
                    <button
                        onClick={() => onMove(part.id)}
                        className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                        title="ユニットへ移動"
                    >
                        <MoveRight size={14} />
                    </button>
                </div>

                <div className="flex items-center justify-between gap-2 mt-2">
                    <div className="flex flex-wrap gap-1">
                        {Array.from(new Set(items.map(i => i.storage_case).filter(Boolean))).map(sc => (
                            <span key={sc} className="text-[9px] px-1.5 py-0.5 bg-blue-50 text-blue-600 font-bold rounded-md border border-blue-100">
                                {sc}
                            </span>
                        ))}
                    </div>
                    <div className="text-[10px] text-gray-400 font-medium shrink-0">
                        {items.length} units
                    </div>
                </div>
            </div>

            {/* Cells with Progress Line Overlay */}
            <div className="relative flex-1 bg-gray-50/30">
                {/* Vertical Progress Line (Connector) */}
                {lastActiveIndex >= 0 && (
                    <div
                        className="absolute left-1/2 -translate-x-1/2 top-0 w-[3px] -z-0"
                        style={{
                            height: `${(lastActiveIndex + 0.5) * 80}px`,
                            transition: 'height 0.5s cubic-bezier(0.4, 0, 0.2, 1)'
                        }}
                    >
                        <div className="h-full w-full bg-gradient-to-b from-blue-100 via-blue-200 to-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.2)]" />
                    </div>
                )}

                {/* Status Cells */}
                <div className="flex flex-col">
                    {PROCESSES.map((proc, index) => (
                        <SwimlaneCell
                            key={proc.key}
                            partId={part.id}
                            status={proc.key}
                            items={items.filter(i => i.status === proc.key)}
                            isLast={index === PROCESSES.length - 1}
                            selectedIds={selectedIds}
                            onToggleSelect={onToggleSelect}
                            onPreview={onPreview}
                        />
                    ))}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/modules/production/services/itemService.ts">
/**
 * Production Module - Item Service
 * 工程アイテム（PartItem）の作成と管理
 */

import { db } from '@/src/shared/lib/firebase';
import {
    collection,
    getDocs,
    doc,
    setDoc,
    updateDoc,
    serverTimestamp
} from 'firebase/firestore';
import { PartItem } from '@/src/modules/production/types';
import { Part } from '@/src/modules/inventory/types';
import { ProcessStatus } from '@/src/shared/types';
import { PROCESSES } from '@/app/constants';

/**
 * 工程アイテムを作成する
 * 
 * @param partId - 部品ID
 * @param quantity - 作成する個数
 * @param storageBoxes - 割り当てられた保管ケースの配列
 * @param initialStatus - 初期ステータス
 * @returns 作成されたアイテムの配列
 */
export async function createItems(
    partId: string,
    quantity: number,
    storageBoxes: string[],
    initialStatus: ProcessStatus = 'CUTTING'
): Promise<PartItem[]> {
    if (storageBoxes.length !== quantity) {
        throw new Error(`Storage boxes count (${storageBoxes.length}) does not match quantity (${quantity})`);
    }

    const createdItems: PartItem[] = [];

    for (let i = 0; i < quantity; i++) {
        const itemRef = doc(collection(db, 'partItems'));
        const newItem: PartItem = {
            id: itemRef.id,
            part_id: partId,
            storage_case: storageBoxes[i],
            status: initialStatus,
            completed_at: null,
            updated_at: serverTimestamp()
        };

        await setDoc(itemRef, newItem);
        createdItems.push(newItem);
    }

    console.log(`[ItemService] Created ${quantity} PartItems for Part ${partId}`);
    return createdItems;
}

/**
 * アイテムのステータスを更新する
 * 
 * @param itemId - アイテムID
 * @param newStatus - 新しいステータス
 */
export async function updateItemStatus(
    itemId: string,
    newStatus: ProcessStatus
): Promise<void> {
    const itemRef = doc(db, 'partItems', itemId);

    await updateDoc(itemRef, {
        status: newStatus,
        updated_at: serverTimestamp(),
        completed_at: newStatus === 'ASSEMBLED' ? serverTimestamp() : null
    });

    console.log(`[ItemService] Updated item ${itemId} status to ${newStatus}`);
}

/**
 * 複数アイテムのステータスを一括更新する
 * 
 * @param itemIds - アイテムIDの配列
 * @param newStatus - 新しいステータス
 */
export async function updateMultipleItemsStatus(
    itemIds: string[],
    newStatus: ProcessStatus
): Promise<void> {
    const updatePromises = itemIds.map(itemId => updateItemStatus(itemId, newStatus));
    await Promise.all(updatePromises);

    console.log(`[ItemService] Updated ${itemIds.length} items to status ${newStatus}`);
}

/**
 * 部品とアイテムから進捗データを集計する
 */
export function aggregateProgress(parts: Part[], partItems: PartItem[]): any[] {
    return parts.map(part => {
        const items = partItems.filter(item => item.part_id === part.id);

        const processOrder = PROCESSES.map(p => p.key);
        const currentProcess = items.length > 0
            ? items.reduce((earliest: ProcessStatus, item: PartItem) => {
                const earliestIdx = processOrder.indexOf(earliest);
                const currentIdx = processOrder.indexOf(item.status);
                return currentIdx < earliestIdx ? item.status : earliest;
            }, 'ASSEMBLED' as ProcessStatus)
            : 'UNPRINTED';

        return {
            id: part.id,
            part_number: part.part_number,
            status: currentProcess,
            storage_cases: Array.from(new Set(items.map(i => i.storage_case))),
            count: items.length,
            unit_id: part.unit_id
        };
    });
}
</file>

<file path="src/shared/types/index.ts">
/**
 * 共通型定義
 * プロジェクト全体で使用される基本的な型
 */

export type ProcessStatus =
    | 'UNPRINTED'
    | 'PRINTED'
    | 'CUTTING'
    | 'SURFACE_TREATMENT'
    | 'PAINTING'
    | 'ASSEMBLED'
    | 'DEFECTIVE';

export interface Project {
    id: string;
    name: string;
    description: string;
    deadline: string;
    created_at?: any;
    updated_at?: any;
}

export interface Part {
    id: string;
    part_number: string;
    project_id: string;
    unit_id?: string | null;
}

export interface Unit {
    id: string;
    name: string;
    project_id: string;
    description?: string;
}

export interface Box {
    id: string;
    status: 'AVAILABLE' | 'IN_USE' | 'MAINTENANCE';
    updated_at: any;
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "es2017",
    "useDefineForClassFields": true,
    "lib": [
      "es2020",
      "dom",
      "dom.iterable"
    ],
    "module": "esnext",
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "forceConsistentCasingInFileNames": true,
    /* Next.js */
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "incremental": true,
    /* Path mapping */
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowJs": true,
    "strict": false,
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="app/actions/importStl.ts">
'use server'

/**
 * 後方互換性のためのラッパー
 * 新しいモジュラーモノリス構造の Engineering Module に委譲
 */

import { ProcessStatus } from '@/app/types';
import { ParsedFileInfo } from '@/lib/utils/parseFileName';

// 新しいモジュール構造から関数をインポート
import {
    importSingleStl as importSingleStlNew,
    importMultipleStl as importMultipleStlNew,
    previewFileNames as previewFileNamesNew,
    type ImportResult
} from '@/src/modules/engineering/actions/importStl';

// 既存のインターフェースをエクスポート（後方互換性）
export type { ImportResult };

/**
 * 単一のSTLファイルをインポートする
 * @deprecated 新しいモジュール構造の importSingleStl を使用してください
 */
export async function importSingleStl(
    fileBuffer: ArrayBuffer,
    fileName: string,
    projectId: number,
    defaultStatus: ProcessStatus = 'CUTTING'
): Promise<ImportResult> {
    return importSingleStlNew(fileBuffer, fileName, projectId, defaultStatus);
}

/**
 * 複数のSTLファイルを一括インポートする
 * @deprecated 新しいモジュール構造の importMultipleStl を使用してください
 */
export async function importMultipleStl(
    filesData: Array<{ buffer: ArrayBuffer; name: string }>,
    projectId: number,
    defaultStatus: ProcessStatus = 'CUTTING'
): Promise<ImportResult[]> {
    return importMultipleStlNew(filesData, projectId, defaultStatus);
}

/**
 * ファイル名のプレビュー解析（実際のインポートは行わない）
 * @deprecated 新しいモジュール構造の previewFileNames を使用してください
 */
export async function previewFileNames(fileNames: string[]): Promise<ParsedFileInfo[]> {
    return previewFileNamesNew(fileNames);
}
</file>

<file path="app/actions/reportDefect.ts">
'use server'

import { reportDefect as reportDefectNew } from '@/src/modules/production/actions/reportDefect';

/**
 * @deprecated Use src/modules/production/actions/reportDefect
 */
export async function reportDefect(itemId: number | string, reason: string) {
    return reportDefectNew(itemId, reason);
}
</file>

<file path="app/actions/updateItemStatus.ts">
'use server'

import { updateItemStatus as updateNew } from '@/src/modules/production/actions/updateItemStatus';

/**
 * @deprecated Use src/modules/production/actions/updateItemStatus
 */
export async function updateItemStatus(itemId: string | number, newStatus: string) {
    return updateNew(itemId, newStatus);
}
</file>

<file path="app/api/preview-filenames/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { previewFileNames } from '@/src/modules/engineering/actions/importStl';

export async function POST(request: NextRequest) {
    try {
        const { fileNames } = await request.json();

        if (!Array.isArray(fileNames)) {
            return NextResponse.json(
                { error: 'fileNames must be an array' },
                { status: 400 }
            );
        }

        const results = await previewFileNames(fileNames);
        return NextResponse.json(results);
    } catch (error) {
        console.error('Error in preview-filenames API:', error);
        return NextResponse.json(
            { error: 'Internal server error' },
            { status: 500 }
        );
    }
}
</file>

<file path="app/constants.ts">
import { ProcessStatus } from './types';

export const PROCESSES: { key: ProcessStatus; name: string }[] = [
  { key: 'UNPRINTED', name: '未プリント' },
  { key: 'PRINTED', name: 'プリント済' },
  { key: 'CUTTING', name: '切削' },
  { key: 'SURFACE_TREATMENT', name: '表面処理' },
  { key: 'PAINTING', name: '塗装' },
  { key: 'ASSEMBLED', name: '組付け済み' },
];
</file>

<file path="lib/firebase.ts">
import { initializeApp, getApps } from "firebase/app";
import { getFirestore, connectFirestoreEmulator } from "firebase/firestore";
import { getAuth, connectAuthEmulator } from "firebase/auth";
import { getStorage, connectStorageEmulator } from "firebase/storage";

const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || "demo-bom3d-sn923";

const firebaseConfig = {
    apiKey: "fake-api-key", // Emulator用ダミー
    authDomain: `${projectId}.firebaseapp.com`,
    projectId: projectId,
    storageBucket: `${projectId}.appspot.com`,
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef"
};

const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const isEmulator = process.env.NODE_ENV === 'development' || projectId.startsWith('demo-');

if (isEmulator) {
    const g = global as any;
    if (!g._firebase_emulators_connected) {
        // 環境変数からポートを取得、なければデフォルト
        // localhost よりも 127.0.0.1 のほうが安定するケースがあるため変更
        connectFirestoreEmulator(db, '127.0.0.1', 8080);
        connectAuthEmulator(auth, "http://127.0.0.1:9099");
        connectStorageEmulator(storage, '127.0.0.1', 9199);
        g._firebase_emulators_connected = true;
        console.log(`Connected to Firebase Emulators: ${projectId}`);
    }
}

export { db, auth, storage };
</file>

<file path="app/utils.ts">
// app/utils.ts
import { Part, PartItem, ProgressData, ProcessStatus } from './types';
import { PROCESSES } from './constants';

export const aggregateProgress = (parts: Part[], partItems: PartItem[]): any[] => {
  return parts.map(part => {
    const items = partItems.filter(item => item.part_id === part.id);

    // この部品の中で最も「進んでいない」工程を現在の工程とする
    // (全て完了していれば READY となる)
    const processOrder = PROCESSES.map(p => p.key);
    const currentProcess = items.length > 0
      ? items.reduce((earliest, item) => {
        return processOrder.indexOf(item.status) < processOrder.indexOf(earliest)
          ? item.status
          : earliest;
      }, 'READY' as ProcessStatus)
      : 'UNPRINTED';

    return {
      id: part.id,
      part_number: part.part_number,
      status: currentProcess, // Rename field
      storage_cases: Array.from(new Set(items.map(i => i.storage_case))),
      count: items.length,
      unit_id: part.unit_id
    };
  });
};

export const calculateUnitProgress = (parts: Part[], partItems: PartItem[]): number => {
  if (parts.length === 0) return 0;

  const aggregated = aggregateProgress(parts, partItems);
  const readyCount = aggregated.filter(p => p.status === 'READY').length;

  return Math.round((readyCount / parts.length) * 100);
};
</file>

<file path="app/actions/consumeItem.ts">
'use server'

import { consumeItem as consumeItemNew } from '@/src/modules/production/actions/consumeItem';

/**
 * @deprecated Use src/modules/production/actions/consumeItem
 */
export async function consumeItem(itemId: string | number) {
  return consumeItemNew(itemId);
}
</file>

<file path="app/data.ts">
// app/data.ts
import { Part, PartItem, Project } from './types';

export const projects: Project[] = [
  { id: '1', name: '次世代ドローン開発', description: '高解像度カメラ搭載の新型ドローン開発プロジェクト', deadline: '2026-06-30' },
  { id: '2', name: '搬送ロボット製作', description: '倉庫内自動配送を行う自律走行ロボットの試作', deadline: '2026-04-15' }
];

export const parts: Part[] = [
  { id: '1', part_number: 'DRONE-ARM-01', project_id: '1' },
  { id: '2', part_number: 'DRONE-BODY-01', project_id: '1' },
  { id: '3', part_number: 'DRONE-PROP-01', project_id: '1' },
  { id: '4', part_number: 'ROBO-WHEEL-X', project_id: '2' }
];

export const partItems: PartItem[] = [
  // DRONE-ARM-01 (id: 1) - 分散配置
  { id: '101', part_id: '1', storage_case: 'Case-A1', status: 'UNPRINTED', completed_at: null },
  { id: '102', part_id: '1', storage_case: 'Case-A1', status: 'PRINTED', completed_at: null },
  { id: '103', part_id: '1', storage_case: 'Case-A2', status: 'PRINTED', completed_at: null },
  { id: '104', part_id: '1', storage_case: 'Case-A3', status: 'SURFACE_TREATMENT', completed_at: null },
  { id: '105', part_id: '1', storage_case: 'Case-A4', status: 'ASSEMBLED', completed_at: new Date() },

  // DRONE-BODY-01 (id: 2) - 特定工程に集中
  { id: '201', part_id: '2', storage_case: 'Case-B1', status: 'SURFACE_TREATMENT', completed_at: null },
  { id: '202', part_id: '2', storage_case: 'Case-B1', status: 'SURFACE_TREATMENT', completed_at: null },
  { id: '203', part_id: '2', storage_case: 'Case-B2', status: 'PAINTING', completed_at: null },

  // DRONE-PROP-01 (id: 3) - 少ないアイテム、不良あり
  { id: '301', part_id: '3', storage_case: 'Case-C1', status: 'UNPRINTED', completed_at: null },
  { id: '302', part_id: '3', storage_case: 'Case-C2', status: 'DEFECTIVE', completed_at: null },

  // ROBO-WHEEL-X (id: 4) - 別プロジェクト
  { id: '401', part_id: '4', storage_case: 'Case-R1', status: 'ASSEMBLED', completed_at: new Date(new Date().setDate(new Date().getDate() - 2)) }
];
</file>

<file path="lib/mockStore.ts">
import { Part, PartItem, Project, ProcessStatus, Unit } from '@/app/types';
import { db } from './firebase';
import {
    collection,
    getDocs,
    doc,
    getDoc,
    updateDoc,
    setDoc,
    addDoc,
    query,
    where,
    Timestamp,
    serverTimestamp
} from 'firebase/firestore';

// Firestoreのデータコンバーター（Date型の復元など）
const dateConverter = (data: any): any => {
    if (!data) return data;
    const result = { ...data };
    // completed_atなどのTimestampをDateに戻す
    Object.keys(result).forEach(key => {
        if (result[key] instanceof Timestamp) {
            result[key] = result[key].toDate();
        }
    });
    return result;
};

export const mockStore = {
    getProjects: async (): Promise<Project[]> => {
        const snapshot = await getDocs(collection(db, 'projects'));
        return snapshot.docs.map(doc => ({
            id: doc.id,
            ...dateConverter(doc.data())
        })) as Project[];
    },

    getProject: async (id: string): Promise<Project | null> => {
        const docRef = doc(db, 'projects', id);
        const span = await getDoc(docRef);
        if (!span.exists()) return null;
        return { id: span.id, ...dateConverter(span.data()) } as Project;
    },

    getUnitsByProject: async (projectId: string): Promise<Unit[]> => {
        const q = query(collection(db, 'units'), where('project_id', '==', projectId));
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        })) as Unit[];
    },

    addUnit: async (projectId: string, name: string): Promise<Unit> => {
        const docRef = await addDoc(collection(db, 'units'), {
            project_id: projectId,
            name: name,
            description: ''
        });
        return {
            id: docRef.id,
            project_id: projectId,
            name: name
        } as Unit;
    },

    assignPartToUnit: async (partId: string, unitId: string | null): Promise<void> => {
        const docRef = doc(db, 'parts', partId);
        await updateDoc(docRef, {
            unit_id: unitId
        });
    },

    getParts: async (projectId?: string): Promise<Part[]> => {
        let q;
        if (projectId) {
            q = query(collection(db, 'parts'), where('project_id', '==', projectId));
        } else {
            q = collection(db, 'parts');
        }
        const snapshot = await getDocs(q);
        return snapshot.docs.map(doc => ({
            id: doc.id,
            ...dateConverter(doc.data())
        })) as Part[];
    },

    getPartItems: async (projectId?: string): Promise<PartItem[]> => {
        // プロジェクトID指定がある場合、まず対象のPartを取得
        let targetPartIds: string[] | null = null;
        if (projectId) {
            const parts = await mockStore.getParts(projectId);
            targetPartIds = parts.map(p => p.id);
            if (targetPartIds.length === 0) return [];
        }

        const snapshot = await getDocs(collection(db, 'partItems'));
        const items = snapshot.docs.map(doc => ({
            id: doc.id,
            ...dateConverter(doc.data())
        })) as PartItem[];

        if (targetPartIds) {
            return items.filter(item => targetPartIds!.includes(item.part_id));
        }
        return items;
    },

    getPartItem: async (id: string): Promise<(PartItem & { parts: Part }) | null> => {
        const itemRef = doc(db, 'partItems', id);
        const itemSnap = await getDoc(itemRef);

        if (!itemSnap.exists()) return null;
        const itemData = { id: itemSnap.id, ...dateConverter(itemSnap.data()) } as PartItem;

        // 関連するPartを取得
        const partRef = doc(db, 'parts', itemData.part_id);
        const partSnap = await getDoc(partRef);

        if (!partSnap.exists()) {
            throw new Error(`Part not found for item ${id}`);
        }
        const partData = { id: partSnap.id, ...dateConverter(partSnap.data()) } as Part;

        return { ...itemData, parts: partData };
    },

    updatePartItem: async (id: string, updates: Partial<PartItem>): Promise<void> => {
        const docRef = doc(db, 'partItems', id);
        await updateDoc(docRef, updates);
    },

    updatePartItemStatus: async (id: string, newStatus: string): Promise<void> => {
        const docRef = doc(db, 'partItems', id);
        await updateDoc(docRef, {
            status: newStatus as ProcessStatus,
            updated_at: serverTimestamp()
        });
    },

    addPartItem: async (item: Omit<PartItem, 'id'>): Promise<PartItem> => {
        const docRef = await addDoc(collection(db, 'partItems'), item);
        return {
            id: docRef.id,
            ...item
        } as PartItem;
    },

};
</file>

<file path="app/actions/createPrinted.ts">
'use server'

/**
 * 後方互換性のためのラッパー
 * 新しいモジュラーモノリス構造の Production Module に委譲
 */

import { ProcessStatus } from '@/app/types';

// 新しいモジュール構造から関数をインポート
import { createPrinted as createPrintedNew } from '@/src/modules/production/actions/createPrinted';

/**
 * 3Dプリントされた新しい部品アイテムを作成するサーバーアクション
 * @deprecated 新しいモジュール構造の createPrinted を使用してください
 */
export async function createPrinted(
  fileBuffer: ArrayBuffer,
  fileName: string,
  projectId: string,
  qty: number,
  targetStatus: ProcessStatus = 'PRINTED'
): Promise<{ success: boolean; partNumber: string }> {
  return createPrintedNew(
    fileBuffer,
    fileName,
    projectId,
    qty,
    targetStatus
  );
}
</file>

<file path="app/actions/updateProcess.ts">
'use server'

/**
 * 後方互換性のためのラッパー
 * 新しいモジュラーモノリス構造の Production Module に委譲
 */

import { ProcessStatus } from '@/app/types';

// 新しいモジュール構造から関数をインポート
import { updateProcess as updateProcessNew } from '@/src/modules/production/actions/updateProcess';

/**
 * 部品アイテムの工程を更新するサーバーアクション
 * @deprecated 新しいモジュール構造の updateProcess を使用してください
 */
export async function updateProcess(
  itemId: string | number,
  nextProcess: string,
  projectId?: number
) {
  return updateProcessNew(itemId, nextProcess, projectId);
}
</file>

<file path="app/page.tsx">
import { ProjectsList } from '@/src/modules/project/components/ProjectsList';

/**
 * プロジェクト一覧ダッシュボード
 */
export default async function ProjectsDashboardPage() {
  return (
    <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
      <header className="mb-12 text-center">
        <h1 className="text-4xl font-extrabold text-gray-900 mb-4 tracking-tight">
          BOM進捗管理システム
        </h1>
        <p className="text-xl text-gray-600 max-w-2xl mx-auto">
          プロジェクトを選択して、部品の製造工程と進捗状況をリアルタイムで確認できます。
        </p>
      </header>

      <div className="max-w-6xl mx-auto">
        <ProjectsList />
      </div>
    </div>
  );
}
</file>

<file path="app/types.ts">
export type ProcessStatus =
  | 'UNPRINTED'
  | 'PRINTED'
  | 'CUTTING'
  | 'SURFACE_TREATMENT'
  | 'PAINTING'
  | 'ASSEMBLED'
  | 'DEFECTIVE';

export interface Project {
  id: string;
  name: string;
  description: string;
  deadline: string;
  created_at?: any;
  updated_at?: any;
}

export interface Unit {
  id: string;
  name: string;
  project_id: string;
  description?: string;
}

export interface Part {
  id: string;
  part_number: string;
  project_id: string;
  unit_id?: string | null;
}

export interface PartItem {
  id: string;
  part_id: string;
  storage_case: string;
  status: ProcessStatus;
  completed_at: Date | null;
  updated_at?: any;
}

export interface ProgressData {
  part_number: string;
  storage_cases: string[];
  counts: Record<ProcessStatus, number>;
}
</file>

<file path="app/item/[id]/page.tsx">
import { mockStore } from '@/lib/mockStore'
import { updateProcess } from '@/app/actions/updateProcess'
import { consumeItem } from '@/app/actions/consumeItem'
import { reportDefect } from '@/app/actions/reportDefect' // アクションをインポート
import { PROCESSES } from '@/app/constants'
import Link from 'next/link'

export default async function ItemPage(props: { params: Promise<{ id: string }> }) {
  const params = await props.params;
  const id = parseInt(params.id, 10);
  const data = await mockStore.getPartItem(id);

  if (!data) {
    return <div className="p-8">アイテムが見つかりませんでした</div>;
  }

  return (
    <div className="p-8 max-w-2xl mx-auto bg-white shadow-lg rounded-xl mt-10 border border-gray-100">
      <Link href={`/project/${data.parts.project_id}`} className="text-sm text-blue-600 hover:underline mb-6 inline-block font-bold">
        ← プロジェクト進捗に戻る
      </Link>

      <div className="flex justify-between items-start mb-6">
        <h1 className="text-3xl font-black text-gray-900">{data.parts.part_number}</h1>
        <span className={`px-3 py-1 rounded-full text-xs font-bold ${data.status === 'DEFECTIVE' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
          ID: {id}
        </span>
      </div>

      {/* ステータス表示 */}
      <div className={`p-4 rounded-lg mb-8 border ${data.status === 'DEFECTIVE' ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-100'}`}>
        <p className="text-sm font-bold text-gray-500 uppercase tracking-wider">Current Status</p>
        <p className={`text-2xl font-black ${data.status === 'DEFECTIVE' ? 'text-red-700' : 'text-blue-800'}`}>
          {PROCESSES.find(p => p.key === data.status)?.name || data.status}
        </p>
      </div>

      <div className="space-y-10">
        {/* 1. 通常の工程更新 */}
        <section>
          <h2 className="text-sm font-bold text-gray-400 uppercase mb-3">工程を進める</h2>
          <form action={async (formData) => {
            'use server'
            const next = formData.get('next') as string;
            await updateProcess(id, next, data.parts.project_id);
          }} className="flex gap-2">
            <select name="next" defaultValue={data.status} className="flex-1 p-3 border rounded-lg font-bold">
              {PROCESSES.map(proc => <option key={proc.key} value={proc.key}>{proc.name}</option>)}
            </select>
            <button className="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-black transition-colors">更新</button>
          </form>
        </section>

        {/* 2. 不良報告セクション（ここが重要） */}
        {data.status !== 'DEFECTIVE' && (
          <section className="p-6 border-2 border-red-200 rounded-2xl bg-red-50/50">
            <h2 className="text-lg font-black text-red-700 mb-2 flex items-center gap-2">
              ⚠️ 不良・再製作の報告
            </h2>
            <p className="text-sm text-red-600 mb-4 font-medium">
              この個体に欠陥がある場合、ここで報告します。この個体は「不良」として記録され、自動的に「未プリント」の新しいジョブが作成されます。
            </p>
            <form action={async (formData) => {
              'use server'
              const reason = formData.get('reason') as string;
              await reportDefect(id, reason);
            }} className="space-y-3">
              <input
                name="reason"
                placeholder="不良理由（例：積層剥離、寸法誤差）"
                className="w-full p-3 border-2 border-red-100 rounded-xl focus:border-red-500 outline-none bg-white font-medium"
                required
              />
              <button className="w-full bg-red-600 text-white font-black py-4 rounded-xl hover:bg-red-700 transition-all shadow-lg active:scale-[0.98]">
                不良を確定し、再製作を依頼
              </button>
            </form>
          </section>
        )}

        {/* 3. 完了処理 */}
        <section>
          <form action={async () => {
            'use server'
            await consumeItem(id);
          }}>
            <button className="w-full border-2 border-green-600 text-green-600 font-black py-4 rounded-xl hover:bg-green-50 transition-colors">
              組み込み完了（ストックから除外）
            </button>
          </form>
        </section>
      </div>
    </div>
  )
}
</file>

<file path="package.json">
{
  "name": "sn-923",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "seed": "tsx scripts/seed-initial-data.ts",
    "seed:clear": "tsx scripts/seed-initial-data.ts --clear"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@react-three/drei": "^10.7.7",
    "@react-three/fiber": "^9.5.0",
    "@tailwindcss/postcss": "^4.1.18",
    "@types/three": "^0.182.0",
    "firebase": "^12.8.0",
    "lucide-react": "^0.563.0",
    "next": "^16.1.6",
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "three": "^0.182.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^19.2.10",
    "@types/react-dom": "^19.2.3",
    "autoprefixer": "^10.4.23",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "tsx": "^4.7.1",
    "typescript": "^5.3.0"
  }
}
</file>

<file path="app/print/page.tsx">
'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { useRouter, useSearchParams } from 'next/navigation';
import { PROCESSES } from '../constants';
import { createPrinted } from '../actions/createPrinted';
import { parseFileName, ParsedFileInfo } from '@/lib/utils/parseFileName';
import { ProcessStatus } from '../types';

import { Suspense } from 'react';

function PrintRegistrationContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const projectId = searchParams.get('project_id');

  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);
  const [parsedInfos, setParsedInfos] = useState<(ParsedFileInfo & { file: File })[]>([]);
  const [targetStatus, setTargetStatus] = useState<ProcessStatus>('PRINTED');
  const [isSubmitting, setIsSubmitting] = useState(false);

  // ファイル選択時の解析処理
  useEffect(() => {
    if (selectedFiles.length > 0) {
      const infos = selectedFiles.map(file => ({
        ...parseFileName(file.name),
        file
      }));
      setParsedInfos(infos);
    } else {
      setParsedInfos([]);
    }
  }, [selectedFiles]);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files) {
      setSelectedFiles(Array.from(files));
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (selectedFiles.length === 0 || !projectId) {
      alert('ファイルを選択し、プロジェクトIDを指定してください。');
      return;
    }

    const invalidFiles = parsedInfos.filter(info => !info.isValid);
    if (invalidFiles.length > 0) {
      alert('解析に失敗したファイルが含まれています。修正または削除してください。');
      return;
    }

    setIsSubmitting(true);

    try {
      // 順次登録（並列にするとFirestoreのID採番でぶつかる可能性があるため、ここでは順次処理）
      for (const info of parsedInfos) {
        const arrayBuffer = await info.file.arrayBuffer();
        await createPrinted(
          arrayBuffer,
          info.file.name,
          projectId,
          info.quantity,
          targetStatus
        );
      }

      alert(`${parsedInfos.length} 件の部品登録が完了しました。`);
      const redirectPath = `/project/${projectId}`;
      router.push(redirectPath);
      router.refresh();
    } catch (error) {
      alert('エラーが発生しました: ' + (error instanceof Error ? error.message : '不明なエラー'));
      console.error(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const backHref = projectId ? `/project/${projectId}` : '/';

  return (
    <div className="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">
      <div className="max-w-3xl mx-auto">
        <header className="mb-8">
          <Link href={backHref} className="text-blue-600 hover:underline mb-2 inline-block">
            ← {projectId ? 'プロジェクト別進捗に戻る' : 'ダッシュボードに戻る'}
          </Link>
          <h1 className="text-3xl font-bold text-gray-800">3Dプリント一括追加登録</h1>
          <p className="text-gray-500 mt-2">STLファイル名から部品情報を自動取得して登録します。</p>
        </header>

        <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-lg p-6 space-y-6">
          {/* STLファイルアップロード */}
          <div className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${selectedFiles.length > 0 ? 'border-blue-400 bg-blue-50' : 'border-gray-300 hover:border-blue-500'
            }`}>
            <input
              type="file"
              accept=".stl"
              onChange={handleFileChange}
              multiple
              className="hidden"
              id="stl-upload"
            />
            <label htmlFor="stl-upload" className="cursor-pointer">
              <div className="text-gray-600">
                {selectedFiles.length > 0 ? (
                  <div className="space-y-2">
                    <p className="font-semibold text-blue-600 text-lg">{selectedFiles.length} 個のファイルを選択中</p>
                    <p className="text-sm text-gray-500">クリックしてファイルを変更・追加</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    <div className="text-4xl">📁</div>
                    <p className="font-medium">CADから出力したSTLファイルをアップロード</p>
                    <p className="text-sm text-gray-400">複数選択が可能です（クリックまたはドラッグ＆ドロップ）</p>
                  </div>
                )}
              </div>
            </label>
          </div>

          {/* 解析プレビューリスト */}
          {parsedInfos.length > 0 && (
            <div className="space-y-3">
              <h3 className="font-bold text-gray-800 flex justify-between items-center">
                <span>解析プレビュー</span>
                <span className="text-sm font-normal text-gray-500">{parsedInfos.length} 件</span>
              </h3>
              <div className="border rounded-lg overflow-hidden divide-y bg-gray-50">
                {parsedInfos.map((info, idx) => (
                  <div key={idx} className={`p-4 flex items-center justify-between ${info.isValid ? 'bg-white' : 'bg-red-50'}`}>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-500">STL</span>
                        <p className="font-medium text-gray-900 truncate">{info.file.name}</p>
                      </div>
                      {info.isValid ? (
                        <div className="mt-1 flex items-center gap-4 text-sm text-gray-600">
                          <span>部品番号: <strong className="font-mono text-blue-600">{info.partNumber}</strong></span>
                          <span>個数: <strong className="text-gray-900">{info.quantity}</strong></span>
                        </div>
                      ) : (
                        <p className="mt-1 text-sm text-red-600 font-medium">⚠️ {info.errorMessage}</p>
                      )}
                    </div>
                    <div className="ml-4">
                      {info.isValid ? (
                        <span className="text-green-500 text-xl">✓</span>
                      ) : (
                        <span className="text-red-500 text-xl">✕</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="pt-4 border-t">
            {/* ステータス選択 */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">登録後の初期ステータス</label>
              <div className="flex gap-6">
                {['UNPRINTED', 'PRINTED'].map((status) => (
                  <label key={status} className="flex items-center cursor-pointer group">
                    <input
                      type="radio"
                      name="status"
                      value={status}
                      checked={targetStatus === status}
                      onChange={(e) => setTargetStatus(e.target.value as ProcessStatus)}
                      className="mr-2 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300"
                    />
                    <span className={`text-sm font-medium transition-colors ${targetStatus === status ? 'text-blue-700' : 'text-gray-600 group-hover:text-gray-800'}`}>
                      {PROCESSES.find(p => p.key === status)?.name}
                    </span>
                  </label>
                ))}
              </div>
            </div>
          </div>

          <button
            type="submit"
            disabled={isSubmitting || selectedFiles.length === 0 || parsedInfos.some(i => !i.isValid)}
            className={`w-full text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all text-xl ${isSubmitting || selectedFiles.length === 0 || parsedInfos.some(i => !i.isValid)
              ? 'bg-gray-300 cursor-not-allowed'
              : 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 active:transform active:scale-[0.98]'
              }`}
          >
            {isSubmitting ? (
              <span className="flex items-center justify-center">
                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                {selectedFiles.length} 件を登録処理中...
              </span>
            ) : `プリントジョブ ${selectedFiles.length} 件を登録実行`}
          </button>
        </form>
      </div>
    </div>
  );
}

export default function PrintRegistrationPage() {
  return (
    <Suspense fallback={<div className="min-h-screen flex items-center justify-center">読み込み中...</div>}>
      <PrintRegistrationContent />
    </Suspense>
  );
}
</file>

<file path="app/project/[id]/page.tsx">
import Link from 'next/link';
import { notFound } from 'next/navigation';
import { aggregateProgress } from '@/src/modules/production/services/itemService';
import { SummaryCard } from '@/src/shared/components/SummaryCard';
import { mockStore } from '@/lib/mockStore';
import ProjectClientContent from './ProjectClientContent';

interface PageProps {
    params: Promise<{
        id: string;
    }>;
    searchParams?: Promise<{ [key: string]: string | string[] | undefined }>;
}

/**
 * プロジェクト別進捗ページ（サーバー側）
 */
export default async function ProjectDetailPage(props: PageProps) {
    const params = await props.params;
    const projectId = params.id;
    if (!projectId) {
        notFound();
    }

    const project = await mockStore.getProject(projectId);
    if (!project) {
        notFound();
    }

    // データの取得
    const parts = await mockStore.getParts(projectId);
    const partItems = await mockStore.getPartItems(projectId);
    const units = await mockStore.getUnitsByProject(projectId);

    const totalInventory = partItems.length;
    const inProgress = partItems.filter(item => item.status !== 'ASSEMBLED').length;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const completedToday = partItems.filter(item =>
        item.completed_at && new Date(item.completed_at) >= today
    ).length;

    // 表示データの集計
    const progressData = aggregateProgress(parts, partItems);

    return (
        <div className="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
            {/* ... (header and summary cards) */}
            <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <div>
                    <Link href="/" className="text-blue-600 hover:text-blue-800 mb-2 inline-block font-medium">
                        ← プロジェクト一覧へ戻る
                    </Link>
                    <h1 className="text-3xl font-bold text-gray-800">
                        {project.name}
                    </h1>
                    <p className="text-gray-600 mt-1">{project.description}</p>
                </div>
                <div className="flex gap-3">
                    <Link href="/storage">
                        <span className="bg-white text-gray-700 font-bold py-3 px-6 rounded-lg shadow-sm border border-gray-300 hover:bg-gray-50 transition-all cursor-pointer inline-block">
                            保管ボックス管理
                        </span>
                    </Link>
                    <Link href={`/print?project_id=${projectId}`}>
                        <span className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all cursor-pointer inline-block">
                            3Dプリント登録
                        </span>
                    </Link>
                </div>
            </header>

            {/* サマリーカード */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <SummaryCard title="総在庫数" value={totalInventory} />
                <SummaryCard title="仕掛品数" value={inProgress} valueColor="text-orange-500" />
                <SummaryCard title="本日完了数" value={completedToday} valueColor="text-green-500" />
            </div>

            {/* インタラクティブな一覧・カート機能 (クライアントコンポーネント) */}
            <ProjectClientContent
                progressData={progressData}
                parts={parts}
                partItems={partItems}
                projectId={projectId}
                initialUnits={units}
            />
        </div>
    );
}
</file>

<file path="app/project/[id]/ProjectClientContent.tsx">
'use client';

import React, { useState, useMemo } from 'react';
import {
    DndContext,
    DragOverlay,
    closestCorners,
    KeyboardSensor,
    PointerSensor,
    useSensor,
    useSensors,
    DragEndEvent,
    DragStartEvent,
} from '@dnd-kit/core';
import {
    sortableKeyboardCoordinates,
} from '@dnd-kit/sortable';
import { Plus, FolderPlus, ChevronRight, ChevronDown, MoreHorizontal, MoveRight } from 'lucide-react';
import { CartModal } from '@/src/modules/logistics/components/CartModal';
import { PreviewModal } from '@/src/modules/production/components/PreviewModal';
import { MovePartModal } from '@/src/modules/production/components/MovePartModal';
import { Part } from '@/src/modules/inventory/types';
import { PartItem, Unit } from '@/app/types';
import { ProcessStatus } from '@/src/shared/types';
import { updateItemStatus } from '@/src/modules/production/actions/updateItemStatus';
import { SwimlaneColumn } from '@/src/modules/production/components/swimlane/SwimlaneColumn';
import { SwimlaneItem } from '@/src/modules/production/components/swimlane/SwimlaneItem';
import { PROCESSES } from '@/app/constants';
import { calculateUnitProgress } from '@/app/utils';
import { mockStore } from '@/lib/mockStore';

// --- Main Component ---

export default function ProjectClientContent({
    progressData,
    parts: initialParts,
    partItems: initialItems,
    projectId,
    initialUnits
}: {
    progressData: any[],
    parts: Part[],
    partItems: PartItem[],
    projectId: string,
    initialUnits: Unit[]
}) {
    const [units, setUnits] = useState<Unit[]>(initialUnits);
    const [parts, setParts] = useState<Part[]>(initialParts);
    const [items, setItems] = useState<PartItem[]>(() => {
        const latestItemsMap = new Map<string, PartItem>();
        initialItems.forEach(item => {
            const currentLatest = latestItemsMap.get(item.part_id);
            if (!currentLatest) {
                latestItemsMap.set(item.part_id, item);
            } else {
                const currentIdx = PROCESSES.findIndex(p => p.key === currentLatest.status);
                const newIdx = PROCESSES.findIndex(p => p.key === item.status);
                if (newIdx > currentIdx) {
                    latestItemsMap.set(item.part_id, item);
                }
            }
        });
        return Array.from(latestItemsMap.values());
    });

    const [selectedIds, setSelectedIds] = useState<string[]>([]);
    const [isCartOpen, setIsCartOpen] = useState(false);
    const [activeId, setActiveId] = useState<string | null>(null);
    const [previewItem, setPreviewItem] = useState<any | null>(null);
    const [expandedUnits, setExpandedUnits] = useState<Record<string, boolean>>({ 'unclassified': true });

    // Unit Movement State
    const [movingPartId, setMovingPartId] = useState<string | null>(null);

    const sensors = useSensors(
        useSensor(PointerSensor, { activationConstraint: { distance: 5 } }),
        useSensor(KeyboardSensor, { coordinateGetter: sortableKeyboardCoordinates })
    );

    const handleAddUnit = async () => {
        const name = prompt('ユニット名を入力してください:');
        if (!name) return;
        try {
            const newUnit = await mockStore.addUnit(projectId, name);
            setUnits(prev => [...prev, newUnit]);
            setExpandedUnits(prev => ({ ...prev, [newUnit.id]: true }));
        } catch (error) {
            alert('ユニットの作成に失敗しました');
        }
    };

    const handleOpenMoveModal = (partId: string) => {
        setMovingPartId(partId);
    };

    const handleCloseMoveModal = () => {
        setMovingPartId(null);
    };

    const handleMovePartConfirm = async (unitId: string | null) => {
        if (!movingPartId) return;
        try {
            await mockStore.assignPartToUnit(movingPartId, unitId);
            setParts(prev => prev.map(p => p.id === movingPartId ? { ...p, unit_id: unitId } : p));

            // Expand the target unit automatically
            if (unitId) {
                setExpandedUnits(prev => ({ ...prev, [unitId]: true }));
            } else {
                setExpandedUnits(prev => ({ ...prev, 'unclassified': true }));
            }

            handleCloseMoveModal();
        } catch (error) {
            alert('ユニット移動に失敗しました');
        }
    };

    const toggleUnit = (unitId: string) => {
        setExpandedUnits(prev => ({ ...prev, [unitId]: !prev[unitId] }));
    };

    const handleDragStart = (event: DragStartEvent) => {
        setActiveId(event.active.id as string);
    };

    const handleDragEnd = async (event: DragEndEvent) => {
        const { active, over } = event;
        setActiveId(null);
        if (!over) return;

        const activeIdStr = active.id as string;
        const itemId = activeIdStr.split('-')[1];
        const activeItem = items.find(i => i.id === itemId);
        if (!activeItem) return;

        let targetStatus: string | undefined;
        const overIdStr = over.id as string;

        if (overIdStr.startsWith('container-')) {
            const partsList = overIdStr.split('-');
            const targetPartId = partsList[1];
            if (targetPartId !== activeItem.part_id) return;
            targetStatus = partsList.slice(2).join('-');
        } else if (overIdStr.startsWith('item-')) {
            const overItemId = overIdStr.split('-')[1];
            const overItem = items.find(i => i.id === overItemId);
            if (overItem && overItem.part_id !== activeItem.part_id) return;
            if (overItem) targetStatus = overItem.status;
        }

        if (targetStatus && targetStatus !== activeItem.status) {
            const originalStatus = activeItem.status;
            setItems(prev => prev.map(i =>
                i.id === itemId ? { ...i, status: targetStatus as ProcessStatus } : i
            ));

            const result = await updateItemStatus(itemId, targetStatus);
            if (!result.success) {
                setItems(prev => prev.map(i => i.id === itemId ? { ...i, status: originalStatus } : i));
                alert(`Failed to update status: ${result.error}`);
            }
        }
    };

    const handleToggleSelect = (itemId: string) => {
        setSelectedIds(prev => prev.includes(itemId) ? prev.filter(id => id !== itemId) : [...prev, itemId]);
    };

    const groupedParts = useMemo(() => {
        const groups: Record<string, Part[]> = { 'unclassified': [] };
        units.forEach(u => groups[u.id] = []);
        parts.forEach(p => {
            const uid = p.unit_id && groups[p.unit_id] ? p.unit_id : 'unclassified';
            groups[uid].push(p);
        });
        return groups;
    }, [units, parts]);

    const activeItem = activeId ? items.find(i => `item-${i.id}` === activeId) : null;
    const cartItems = items.filter(i => selectedIds.includes(i.id)).map(i => {
        const part = parts.find(p => p.id === i.part_id);
        return { id: i.id, part_number: part?.part_number || `Part-${i.part_id}`, status: i.status, count: 1 };
    });

    return (
        <div className="flex flex-col h-[75vh] bg-gray-50/50 border border-gray-200 rounded-xl overflow-hidden shadow-sm">
            {/* Toolbar */}
            <div className="bg-white border-b border-gray-200 p-4 flex justify-between items-center z-40">
                <div className="flex items-center gap-4">
                    <h2 className="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <FolderPlus size={18} className="text-blue-500" />
                        工程マトリクス
                    </h2>
                    <button
                        onClick={handleAddUnit}
                        className="flex items-center gap-2 bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors border border-blue-100"
                    >
                        <Plus size={16} />
                        ユニットを追加
                    </button>
                </div>
                <div className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">
                    Units Mode: Active
                </div>
            </div>

            <DndContext sensors={sensors} collisionDetection={closestCorners} onDragStart={handleDragStart} onDragEnd={handleDragEnd}>
                <div className="flex-1 overflow-x-auto overflow-y-auto">
                    <div className="flex w-max min-w-full relative">
                        {/* Static Legend Column */}
                        <div className="sticky left-0 z-30 w-32 md:w-44 shrink-0 bg-white border-r border-gray-200 shadow-md">
                            <div className="h-16 border-b border-gray-200 flex flex-col items-center justify-center bg-gray-50/80 backdrop-blur-md">
                                <span className="text-[9px] font-black text-gray-400 uppercase tracking-widest">Process Chain</span>
                            </div>
                            {PROCESSES.map((proc, index) => (
                                <div key={proc.key} className="h-[80px] border-b border-gray-100 p-3 flex flex-col justify-center">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="w-4 h-4 rounded bg-gray-100 text-gray-500 text-[9px] font-black flex items-center justify-center border border-gray-200">
                                            {index + 1}
                                        </span>
                                        <div className="text-[10px] font-black text-gray-800 uppercase truncate">{proc.name}</div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Grouped Columns */}
                        <div className="flex-1 flex flex-col">
                            {[...units, { id: 'unclassified', name: '未分類' } as Unit].map(unit => {
                                const unitParts = groupedParts[unit.id] || [];
                                const isExpanded = expandedUnits[unit.id];
                                const progress = calculateUnitProgress(unitParts, items);

                                return (
                                    <div key={unit.id} className="border-b border-gray-200 bg-white">
                                        {/* Unit Header */}
                                        <div
                                            className="sticky top-0 z-20 flex items-center justify-between px-6 py-4 bg-white/95 backdrop-blur-sm cursor-pointer hover:bg-gray-50/80 transition-colors shadow-sm"
                                            onClick={() => toggleUnit(unit.id)}
                                        >
                                            <div className="flex items-center gap-4">
                                                {isExpanded ? <ChevronDown size={20} className="text-gray-400" /> : <ChevronRight size={20} className="text-gray-400" />}
                                                <div>
                                                    <h3 className="text-sm font-black text-gray-800 flex items-center gap-2 uppercase tracking-wide">
                                                        {unit.name}
                                                        <span className="text-[10px] text-gray-400 font-medium">({unitParts.length} Parts)</span>
                                                    </h3>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-6">
                                                <div className="flex flex-col items-end gap-1">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-32 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                                            <div
                                                                className="h-full bg-green-500 transition-all duration-500"
                                                                style={{ width: `${progress}%` }}
                                                            />
                                                        </div>
                                                        <span className="text-[10px] font-black text-gray-900">{progress}%</span>
                                                    </div>
                                                    <span className="text-[9px] text-gray-400 font-bold uppercase">Ready Completion</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Unit Content */}
                                        {isExpanded && (
                                            <div className="flex pl-4 pr-10 py-4 bg-gray-50/30 overflow-x-visible">
                                                {unitParts.length > 0 ? (
                                                    <div className="flex divide-x divide-gray-200/50">
                                                        {unitParts.map(part => (
                                                            <div key={part.id} className="relative group">
                                                                <SwimlaneColumn
                                                                    part={part}
                                                                    items={items.filter(i => i.part_id === part.id)}
                                                                    selectedIds={selectedIds}
                                                                    onToggleSelect={handleToggleSelect}
                                                                    onPreview={(item) => {
                                                                        const p = parts.find(pt => pt.id === item.part_id);
                                                                        setPreviewItem({ ...item, part_number: p?.part_number });
                                                                    }}
                                                                    onMove={handleOpenMoveModal}
                                                                />
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div className="h-24 flex items-center justify-center w-full text-gray-400 text-xs font-medium italic">
                                                        このユニットに部品は登録されていません
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>

                <DragOverlay>
                    {activeItem ? (
                        <div className="w-48 shadow-2xl">
                            <SwimlaneItem
                                item={{
                                    ...activeItem,
                                    part_number: parts.find(p => p.id === activeItem.part_id)?.part_number
                                }}
                                isOverlay
                                isSelected={selectedIds.includes(activeItem.id)}
                                onToggleSelect={() => { }}
                                onPreview={() => { }}
                            />
                        </div>
                    ) : null}
                </DragOverlay>
            </DndContext>

            {/* Floating Cart Button */}
            <div className="fixed bottom-8 right-8 z-50">
                <button
                    onClick={() => setIsCartOpen(true)}
                    className="relative bg-black text-white p-4 rounded-full shadow-2xl hover:scale-105 active:scale-95 transition-all group"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    {selectedIds.length > 0 && (
                        <span className="absolute -top-2 -right-2 bg-blue-600 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full border-2 border-white shadow-sm">
                            {selectedIds.length}
                        </span>
                    )}
                </button>
            </div>

            <CartModal
                isOpen={isCartOpen}
                onClose={() => setIsCartOpen(false)}
                items={cartItems}
                onDownload={() => {
                    alert("Zipダウンロードを開始します");
                }}
            />

            <PreviewModal
                isOpen={!!previewItem}
                onClose={() => setPreviewItem(null)}
                partNumber={previewItem?.part_number || ''}
                itemId={previewItem?.id}
                status={previewItem?.status}
                projectId={projectId}
            />

            {movingPartId && (
                <MovePartModal
                    isOpen={!!movingPartId}
                    onClose={handleCloseMoveModal}
                    onMove={handleMovePartConfirm}
                    units={units}
                    currentUnitId={parts.find(p => p.id === movingPartId)?.unit_id}
                    partNumber={parts.find(p => p.id === movingPartId)?.part_number || ''}
                />
            )}
        </div>
    );
}
</file>

</files>
